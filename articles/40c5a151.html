<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>微服务项目架构搭建 | This0</title><meta name="keywords" content="sss"><meta name="author" content="YuPengtao"><meta name="copyright" content="YuPengtao"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="微服务项目架构搭建"><meta name="application-name" content="微服务项目架构搭建"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="微服务项目架构搭建"><meta property="og:url" content="https://www.this0.com/articles/40c5a151.html"><meta property="og:site_name" content="This0"><meta property="og:description" content="第一章 NoSQL数据库学习目标1 了解什么是NoSQL 数据库及常见的NoSQL数据库 2 了解其他类型数据库 第一节 NoSQL数据库概述1.1 什么是NoSQL数据库 NoSQL(NoSQL &amp;#x3D; Not Only SQL )，意即“不仅仅是SQL”，泛指非关系型的数据库。   不遵循"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://cdn.this0.com/blog/base/favicon.png"><meta property="article:author" content="YuPengtao"><meta property="article:tag" content="Godot学习，Godot教程,Java,maven,程序员，博客,This0,MySQL"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.this0.com/blog/base/favicon.png"><meta name="description" content="第一章 NoSQL数据库学习目标1 了解什么是NoSQL 数据库及常见的NoSQL数据库 2 了解其他类型数据库 第一节 NoSQL数据库概述1.1 什么是NoSQL数据库 NoSQL(NoSQL &amp;#x3D; Not Only SQL )，意即“不仅仅是SQL”，泛指非关系型的数据库。   不遵循"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://www.this0.com/articles/40c5a151"><link rel="preconnect" href="//cdn.cbd.int"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?3402e0377567bbeafe27f44ff4bc1b51";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: undefined,
  postHeadAiDescription: undefined,
  diytitle: {"enable":true,"leaveTitle":"w(ﾟДﾟ)w 不要走！再看看嘛！","backTitle":"♪(^∇^*)欢迎肥来！"},
  LA51: undefined,
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: 'https://twikoo-vercel.this0.com',
  commentBarrageConfig:undefined,
  root: '/',
  preloader: undefined,
  friends_vue_info: {"apiurl":null},
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":null},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: {"limitDay":180,"position":"top","messagePrev":"已经超过","messageNext":"天没更新了."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    simplehomepage: false,
    post: true
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: YuPengtao","link":"链接: ","source":"来源: This0","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'This0',
  title: '微服务项目架构搭建',
  postAI: '',
  pageFillDescription: '第一章 NoSQL数据库, 学习目标, 第一节 NoSQL数据库概述, 1.1 什么是NoSQL数据库, 1.2 NoSQL适用的场景, 1.3 NoSQL不适用的场景, 1.4 常见NoSQL数据库, 1.4.1 Memcached, 1.4.2 Redis, 1.4.3 MongoDB, 第二节 DB-Engines数据库排名, 第二章 Redis简介和安装, 学习目标, 第一节 Redis简介和适用场景, 1.1 配合关系型数据库做高速缓存, 1.2 多样的数据结构存储持久化数据, 第二节 Redis的安装和基本操作, 2.1 安装, 2.2 Redis的启动和停止, 2.2.1 查看安装目录, 2.2.2 默认配置文件拷贝到自定义路径, 2.2.3 前台启动方式, 2.2.4 后台启动方式, 2.2.5 通过客户端连接redis, 2.3.6 停止redis服务, 2.3.7 Redis端口号 6379 由来, x2Fx2FTODO, （2）数据库操作, （3）Redis单线程+多路复用, 第三章 Redis常用数据类型和命令, 学习目标, 第一节 key操作的相关命令, 第二节 字符串类型(String), 2.1 简介, 2.2 常用命令, 2.3 数据结构, 第三节 Redis 列表(List), 3.1 简介, 3.2 常用命令, 3.3 数据结构, 第四节Redis 集合(Set), 第二节 环境准备, 第三节 key相关API, 第四节 String相关API, 第五节 List相关API, 第六节 Set相关API, 第七节 Hash相关API, 第八节 ZSet相关API, x2Fx2FTODO第五章 SpringBoot整合Redis, 5.1 创建工程, 5.2 添加依赖, 5.3 创建配置文件, 5.4 创建启动类, 5.5 序列化定制, 5.6 编写测试方法, x2Fx2FTODO第六章 Redis配置文件解读, 学习目标, 第一节 网络配置相关x20, （1） bind绑定连接IP, （2） 端口号： 6379, （3）tcp-backlog 连接队列, （4）timeout连接超时, （5）tcp-keepalive  连接心跳检测, 第二节 GENREAL通用配置, （1）UNITS单位, （2）INCLUDES包含, （3）daemonize 后台进程, （4）pidfile 进程ID文件, （5）databases 16x20, 第三节 SECURITY安全配置, 第四节 LIMIT限制, （1）maxclients 客户端最大连接数, （2）maxmemory 最大占用内存, （3）maxmemory-policy  置换策略, （4）maxmemory-samples, x2Fx2FTODO第七章 Redis事务锁机制及案例, 学习目标, 第一节 Redis事务和锁机制, 1.1 Redis事务的定义, 1.2 Redis事务控制命令, 1.3 Redis事务错误处理, 1.4 Redis事务场景案例, 1.5 Redis事务的三个特性, 第二节 Redis Lua 脚本, 2.1 什么是LUA, 2.2 创建SpringBoot工程, 2.3 引入相关依赖, 2.4 创建配置文件, 2.5 创建LUA脚本, 2.6 创建配置类, 2.7 创建测试类, 第八章 Redis的持久化, 学习目标, 第一节 持久化总体介绍, 第二节 RDB持久化, 2.1 RDB简介, 2.2 RDB持久化流程, 2.3 RDB相关配置与操作, 2.4 RDB的优势和劣势, 2.4.1 优势, 2.4.2 劣势, 2.5 RDB小总结, 第三节 AOF持久化, 3.1 AOF简介, 3.2 AOF持计划流程, 3.3 AOF相关配置与操作, 3.4 AOF的优势, 3.5 AOF的劣势, 3.6 AOF小总结, 3.7 持久化方案选择, 第九章 Redis主从复制, 学习目标, 第一节 什么是主从复制, 第二节 主从复制的作用, 第三节 主从复制具体操作, （1）实现思路, （2） 一台机器上启动多个redis服务, （3）新建三个redis配置文件, （4）启动三个服务, （5）查看启动服务进程, （6）使用info replication查看主从相关信息, （7） 配置主从机器, （8）测试主从读写操作, 第四节 主从复制原理, 第五节 主动复制三种模式, 第六节 哨兵模式, 6.1 哨兵模式简介, 6.2 哨兵模式的使用步骤, （1）第一步 设置简单的一主二仆, （2）第二步 为哨兵模式准备配置文件, （3）第三步 启动哨兵, 6.3 哨兵模式的操作演示, （1）主机宕机演示, （2）复制延时, （3）故障恢复, 第十章 Redis集群操作, 学习目标, 9.1 目前面临问题分析, 9.2 什么是集群, 9.3 集群的搭建, （1）第一步搭建前的准备, （2）第二步制作六个实例的配置文件, （3）第三步启动六个服务, （4）第四步 将六个服务合并为一个集群, 9.4集群的登录, （1）集群登录方式, （2）登录后查看集群信息, 9.5 集群的slots, 9.6 集群中录入值, 9.7 集群中查找值, 9.8 集群故障恢复, 9.9 集群提供的好处, 9.10 集群的不足第一章数据库学习目标了解什么是数据库及常见的数据库了解其他类型数据库第一节数据库概述什么是数据库意即不仅仅是泛指非关系型的数据库不遵循标准不支持远超于的性能适用的场景对数据高并发的读写海量数据的读写对数据高可扩展性的不适用的场景需要事务支持基于的结构化查询存储处理复杂的关系查询不支持事务不支持不适用处理复杂关系的查询但是每个都是原子操作常见数据库很早出现的数据库数据都在内存中一般不持久化支持简单的模式支持类型单一一般是作为缓存数据库辅助持久化的数据库不支持持久化仅支持几乎覆盖了的绝大部分功能数据都在内存中支持持久化主要用作备份恢复除了支持简单的模式还支持多种数据结构的存储比如等一般是作为缓存数据库辅助持久化的数据库支持持久化更多数据结构高性能开源模式自由的文档型数据库数据都在内存中如果内存不足把不常用的数据保存到硬盘虽然是模式但是对尤其是提供了丰富的查询功能支持二进制数据及大型对象可以根据数据的特点替代成为独立的数据库或者配合存储特定的数据文档型数据库第二节数据库排名查看连接第二章简介和安装学习目标能够独立完成数据库的安装和启动方式调试能够简单操作数据库第一节简介和适用场景是存储系统区别于的二维表格的形式存储数据都是缓存在计算机内存中但是会周期性的把更新的数据写入磁盘或者把修改操作写入追加的记录文件实现数据的持久化读写速度快读取的速度是次写的速度是次的所有操作都是原子性的支持多种数据结构字符串列表哈希集合有序集合支持集群部署支持过期时间支持事务消息订阅配合关系型数据库做高速缓存高频次热门访问的数据降低数据库多样的数据结构存储持久化数据第二节的安装和基本操作安装安装见站内文章的启动和停止查看安装目录进入自己的安装路径然后执行性能测试工具可以在自己本子运行看看自己本子性能如何后面演示修复有问题的文件和后面讲修复有问题的文件集群使用服务器启动命令客户端操作入口默认配置文件拷贝到自定义路径养成好习惯拷贝到自定义路径能留个备份配置文件修改处后端启动保护模式远程连接注释掉访问密码前台启动方式不推荐原因窗口不能关闭关闭则服务停止后台启动方式启动时使用我们自己修改之后的配置文件查看服务启动状态通过客户端连接通过客户端指令连接如果想退出客户端可以按退出客户端不会关闭服务通过客户端连接指定端口下的默认连接后测试与的连通性带密码连接密码停止服务单实例非客户端连接模式下关闭服务在客户端连接模式下直接使用关闭当前连接的服务多实例关闭指定端口的服务端口号由来跳过了回头看数据库操作默认个数据库类似数组下标从开始初始默认使用号库使用命令来切换数据库如统一密码管理所有库同样密码查看当前数据库的的数量清空当前库通杀全部库单线程多路复用多路复用是指使用一个线程来检查多个文件描述符的就绪状态比如调用和函数传入多个文件描述符如果有一个文件描述符就绪则返回否则阻塞直到超时得到就绪状态后进行真正的操作可以在同一个线程里执行也可以启动线程执行比如使用线程池多路指的是多个网络连接客户端复用指的是复用同一个线程多路复用其实是使用一个线程来检查多个的就绪状态在单个线程中通过记录跟踪每一个流的状态来管理处理多个流一个客户端与服务端连接时会生成对应一个套接字描述符套接字描述符是文件描述符的一种每一个网络连接其实都对应一个文件描述符文件描述符系统中把一切都看做是文件当进程打开现有文件或创建新文件时内核向进程返回一个文件描述符可以理解文件描述符是一个索引这样要操作文件的时候我们直接找到索引就可以对其进行操作了我们将这个索引叫做文件描述符简称多个客户端与服务端连接时使用多路复用程序将客户端对应的注册到监听列表一个队列中当客服端执行等操作命令时多路复用程序会将命令封装成一个事件并绑定到对应的上文件事件处理器使用多路复用模块同时监控多个文件描述符的读写情况当和文件事件产生时文件事件处理器就会回调绑定的事件处理器进行处理相关命令操作文件事件分派器接收到多路复用程序传来的套接字后并根据套接字产生的事件类型将套接字派发给相应的事件处理器来进行处理相关命令操作整个文件事件处理器是在单线程上运行的但是通过多路复用模块的引入实现了同时对多个读写的监控当其中一个端达到写或读的状态文件事件处理器就马上执行从而就不会出现堵塞的问题提高了网络通信的性能第三章常用数据类型和命令学习目标的数据类型的存储时形式的这里的五大类型指的是的五种数据类型键值对无序集合不常用的个经纬度基数统计位图位域流相关命令如何对键进行一些操作类型的值如何进行操作类型的如何进行操作类型的如何进行操作类型的如何进行操作类型的如何进行操作第一节操作的相关命令命令记语法功能查看当前库所有匹配判断某个是否存在查看你的是什么类型删除指定的数据非阻塞删除仅将从元数据中删除真正的删除会在后续异步操作秒钟为给定的设置过期时间查看还有多少秒过期表示永不过期表示已过期命令切换数据库查看当前数据库的的数量清空当前库清空全部库非阻塞删除命令数据类型第二节字符串类型简介是最基本的类型你可以理解成与一模一样的类型一个对应一个类型是二进制安全的意味着的可以包含任何数据比如图片或者序列化的对象类型是最基本的数据类型一个中字符串最多可以是常用命令背是时间戳秒后面是毫秒语法解释添加键值对当数据库中不存在时可以将添加数据库当数据库中存在时可以将添加数据库与参数互斥的超时秒数的超时毫秒数与互斥查询对应键值将给定的追加到原值的末尾获得值的长度只有在不存在时设置的值将中储存的数字值增只能对数字值操作如果为空新增值为将中储存的数字值减只能对数字值操作如果为空新增值为步长将中储存的数字值增减自定义步长同时设置一个或多个对同时获取一个或多个同时设置一个或多个对当且仅当所有给定都不存在有一个失败则都失败原子性起始位置结束位置获得值的范围类似中的前包后包起始位置用覆写所储存的字符串值从起始位置开始索引从开始过期时间设置键值的同时设置过期时间单位秒以新换旧设置了新值同时获得旧值默认取出老的值设置新的值覆盖他整理一下顺序保留原来的过期时间一次设置多个起始位置结束位置获得值的范围类似中的前包后包到就是取全部设置指定区间范围内的值格式是值第几个字符开始具体值获取字符串长度和内容追加指令运行的原子性所谓原子操作是指不会被线程调度机制打断的操作这种操作一旦开始就一直运行到结束中间不会有任何切换到另一个线程在单线程中能够在单条指令中完成的操作都可以认为是原子操作因为中断只能发生于指令之间在多线程中不能被其它进程线程打断的操作就叫原子操作单命令的原子性主要得益于的单线程问题中的是否具有原子性原子性即不可分割性比如非和类型这个操作是不可分割的那么我们说这个操作是原子操作再比如这个操作实际是是可分割的所以他不是一个原子操作非原子操作都会存在线程安全问题需要使用同步技术或者锁来让它变成一个原子操作一个操作是原子操作那么我们称它具有原子性数据结构的数据结构为简单动态字符串缩写是可以修改的字符串内部结构实现上类似于的采用预分配冗余空间的方式来减少内存的频繁分配如图中所示内部为当前字符串实际分配的空间一般要高于实际字符串长度当字符串长度小于时扩容都是加倍现有的空间如果超过扩容时一次只会多扩的空间需要注意的是字符串最大长度为第三节列表简介单键多值一个键下的是一个列表是简单的字符串列表按照插入顺序排序你可以添加一个元素到列表的头部左边或者尾部右边它的底层实际是个双向链表对两端的操作性能很高通过索引下标的操作中间的节点性能会较差常用命令语法功能从左边右边插入一个或多个值从左边右边吐出一个值值在键在值光键亡从列表右边吐出一个值插到列表左边按照索引下标获得元素从左到右左边第一个右边第一个表示获取所有按照索引下标获得元素从左到右获得列表长度在的前面插入插入值在的后面插入插入值从左边删除个从左到右将列表下标为的值替换成一键多值没有操作最左边的取值并删除弹出最右边的取值并删除弹出在的值里删个元素开始结束截取指定范围的值后再赋值给左边弹出一个放到右边图下标元素数据结构五大数据解构都没看的数据结构为快速链表首先在列表元素较少的情况下会使用一块连续的内存存储这个结构是也即是压缩列表它将所有的元素紧挨着一起存储分配的是一块连续的内存当数据量比较多的时候才会改成因为普通的链表需要的附加指针空间太大会比较浪费空间比如这个列表里存的只是类型的数据结构上还需要两个额外的指针和将链表和结合起来组成了也就是将多个使用双向指针串起来使用这样既满足了快速的插入删除性能又不会出现太大的空间冗余第四节集合里面的添加遍历是否存在有返回没有返回删除统计随机取数迁移集合运算属于不属于的元素合并交集新出的返回交集的个数简介对外提供的功能与类似是一个列表的功能特殊之处在于是可以自动排重的当你需要存储一个列表数据又不希望出现重复数据时是一个很好的选择并且提供了判断某个成员是否在一个集合内的重要接口这个也是所不能提供的的是类型的无序集合它底层其实是一个为的表所以添加删除查找的复杂度都是一个算法随着数据的增加执行时间的长短如果是数据增加查找数据的时间不变常用命令语法功能将一个或多个元素加入到集合中已经存在的元素将被忽略取出该集合的所有值判断集合是否为含有该值有没有返回该集合的元素个数删除集合中的某个元素随机从该集合中吐出一个值随机从该集合中吐出个值随机从该集合中取出个值不会从集合中删除把集合中一个值从一个集合移动到另一个集合返回两个集合的交集元素返回两个集合的并集元素返回两个集合的差集元素中的不包含中的数据结构数据结构是字典字典是用哈希表实现的中的内部实现使用的是只不过所有的都指向同一个对象的结构也是一样它内部也使用结构所有都指向同一个内部值第五节哈希模式不变但是一个键值对要进行取值在很早以前版本就和没区别简介是一个键值对集合是一个类型的和的映射表特别适合用于存储对象类似里面的用户为查找的存储的用户对象包含姓名年龄生日等信息方式单序列化问题每次修改用户的某个属性需要先反序列化改好后再序列化回去开销较大方式多问题用户数据冗余方式单多通过用户属性标签就可以操作对应属性数据了既不需要重复存储数据也不会带来序列化和并发修改控制的问题常用命令语法功能给集合中的键赋值从集合取出批量设置的值查看哈希表中给定域是否存在列出该集合的所有列出该集合的所有为哈希表中的域的值加上增量将哈希表中的域的值设置为当且仅当域不存在数据结构类型对应的数据结构是两种压缩列表哈希表当长度较短且个数较少时使用否则使用第六节有序集合简介有序集合与普通集合非常相似是一个没有重复元素的字符串集合不同之处是有序集合的每个成员都关联了一个评分这个评分被用来按照从最低分到最高分的方式排序集合中的成员集合的成员是唯一的但是评分可以是重复了因为元素是有序的所以你也可以很快的根据评分或者次序来获取一个范围的元素访问有序集合的中间元素也是非常快的因此你能够使用有序集合作为一个没有重复成员的智能列表常用命令语法功能将一个或多个元素及其值加入到有序集当中升序返回有序集中下标在之间的元素代表第一个元素索引代表最后一个元素索引带可以让分数一起和值返回到结果集降序返回有序集中下标在之间的元素代表第一个元素索引代表最后一个元素索引带可以让分数一起和值返回到结果集返回有序集中所有值介于和之间包括等于或的成员有序集成员按值递增从小到大次序排列同上改为从大到小排列为元素的加上增量删除该集合下指定值的元素统计该集合分数区间内的元素个数返回该值在集合中的排名从开始案例如何利用实现一个文章访问量的排行榜小括号不包含的要加数量我理解后面的可选参数是执行几次逆序数据结构是提供的一个非常特别的数据结构一方面它等价于的数据结构可以给每一个元素赋予一个权重另一方面它又类似于内部的元素会按照权重进行排序可以得到每个元素的名次还可以通过的范围来获取元素的列表单线程和多路复用后五种没看第四章客户端程序学习目标了解能够独立搭建的环境熟练操作操作相关熟练操作操作相关熟练操作操作相关熟练操作操作相关熟练操作操作相关熟练操作操作相关第一节简介纯文本不仅是使用命令来操作现在基本上主流的语言都有客户端支持比如等在官方网站里列一些的客户端有等其中官方推荐使用和在企业中用的最多的就是提供了完整命令而有更多分布式的容器实现第二节环境准备创建普通项目导入如下依赖虚拟机和设置禁用的防火墙里执行命令中注释掉然后的值设置为测试程序和之间的通信连接成功第三节相关添加键值对并设置过期时间获取所有的键判断某个键是否存在查看键剩余过期时间根据键获取值第四节相关添加一次添加多个获取一次获取多个追加获取长度不存在时进行设置增长减少第五节相关放入获取取值第六节相关添加一个集合获取制定的集合判断是否包含删除元素弹出一个元素弹出个元素从一个向另一个移动元素第七节相关添加值宇智波赵四儿获取值批量添加值旋涡刘能查看是否存在查看集合中所有的查看集合中所有的给制定属性如不存在添加某个属性第八节相关准备数据李四王五赵六刘七添加元素张三升序返回有序降序返回元素增加分数张三赵六删除元素张三李四第五章整合创建工程添加依赖创建配置文件设置的底层参数切换操作的工具类要从的连接工厂获取链接才能操作客户端默认可以使用以下切换切换作为操作的底层客户端创建启动类序列化定制允许类型的都可以被转为进行存储自动配置好了连接工厂把对象转为字符串的序列化工具编写测试方法创建测试类编写测试方法测试测试集合第六章配置文件解读学习目标了解网络相关的配置了解通用配置了解安全配置了解限制第一节网络配置相关绑定连接默认情况只能接受本机的访问请求不写的情况下无限制接受任何地址的访问生产环境肯定要写你应用服务器的地址服务器是需要远程访问的所以需要将其注释掉如果开启了那么在没有设定且没有设密码的情况下只允许接受本机的响应保存配置停止服务重启启动查看进程不再限制是本机访问了这里完成之后就可以在上安装一个客户端连接虚拟机上的服务了端口号连接队列设置的其实是一个连接队列队列总和未完成三次握手队列已经完成三次握手队列在高并发环境下你需要一个高值来避免慢客户端连接问题注意内核会将这个值减小到的值所以需要确认增大和两个值来达到想要的效果连接超时一个空闲的客户端维持多少秒会关闭表示关闭该功能即永不关闭连接心跳检测对访问客户端的一种心跳检测每个秒检测一次单位为秒如果设置为则不会进行检测建议设置成第二节通用配置单位配置大小单位开头定义了一些基本的度量单位只支持不支持大小写不敏感包含在当前配置文件中引入其他配置文件中的内容一般都是引入一些公共配置后台进程是否为后台进程设置为守护进程后台启动进程文件存放文件的位置每个实例会产生一个不同的文件设定库的数量默认默认数据库为可以使用命令在连接上指定数据库第三节安全配置设置密码访问密码的查看设置和取消在命令中设置密码只是临时的重启服务器密码就还原了永久设置需要再配置文件中进行设置重新连接客户端测试第四节限制客户端最大连接数设置同时可以与多少个客户端进行连接默认情况下为个客户端如果达到了此限制则会拒绝新的连接请求并且向这些连接请求方发出以作回应最大占用内存建议必须设置否则将内存占满造成服务器宕机设置可以使用的内存量一旦到达内存使用上限将会试图移除内部数据移除规则可以通过来指定如果无法根据移除规则来移除内存中的数据或者设置了不允许移除那么则会针对那些需要申请内存的指令返回错误信息比如等但是对于无内存申请的指令仍然会正常响应比如等如果你的是主说明你的有从那么在设置内存使用上限时需要在系统中留出一些内存空间给同步队列缓存只有在你设置的是不移除的情况下才不用考虑这个因素置换策略使用算法移除只对设置了过期时间的键最近最少使用在所有集合中使用算法移除在过期集合中移除随机的只对设置了过期时间的键在所有集合中移除随机的移除那些值最小的即那些最近要过期的不进行移除针对写操作只是返回错误信息设置样本数量算法和最小算法都并非是精确的算法而是估算值所以你可以设置样本的大小默认会检查这么多个并选择其中的那个一般设置到的数字数值越小样本越不准确但性能消耗越小设置为那么将会增加额外的开销以保证接近真正的性能第七章事务锁机制及案例学习目标熟悉事务的定义和特点熟练事务控制的相关命令熟练使用的锁对数据进行监视熟练编写调用脚本代码第一节事务和锁机制事务的定义事务是一个单独的隔离操作事务中的所有命令都会序列化按顺序地执行事务在执行的过程中不会被其他客户端发送来的命令请求所打断事务的主要作用就是串联多个命令防止别的命令插队事务控制命令命令功能开始组队执行队列中的命令取消组队从输入命令开始输入的命令都会依次进入命令队列中但不会执行直到输入后会将之前的命令队列中的命令依次执行组队的过程中可以通过取消组队情况组队成功提交成功事务错误处理情况组队报错提交失败提交失败组队中某个命令出现了报告错误执行时整个的所有队列都会被取消情况组队成功提交时有成功有失败如果执行阶段某个命令报出了错误则只有报错的命令不会被执行其他的命令都会执行不会回滚事务场景案例场景说明想想一个场景有很多人有你的账户同时去参加双十一抢购一个请求想给金额减一个请求想给金额减一个请求想给金额减悲观锁悲观锁顾名思义就是很悲观每次去拿数据的时候都认为别人会修改所以每次在拿数据的时候都会上锁这样别人想拿这个数据就会直到它拿到锁传统的关系型数据库里边就用到了很多这种锁机制比如行锁表锁等读锁写锁等都是在做操作之前先上锁乐观锁乐观锁顾名思义就是很乐观每次去拿数据的时候都认为别人不会修改所以不会上锁但是在更新的时候会判断一下在此期间别人有没有去更新这个数据可以使用版本号等机制乐观锁适用于多读的应用类型这样可以提高吞吐量就是利用这种机制实现事务的监视和取消监视在执行之前先执行可以监视一个或多个如果在事务执行之前这个或这些被其他命令所改动那么事务将被打断取消命令对所有的监视如果在执行命令之后命令或命令先被执行了的话那么就不需要再执行了事务的三个特性单独的隔离操作事务中的所有命令都会序列化按顺序地执行事务在执行的过程中不会被其他客户端发送来的命令请求所打断没有隔离级别的概念队列中的命令没有提交之前都不会实际被执行因为事务提交前任何指令都不会被实际执行不保证原子性事务中如果有一条命令执行失败其后的命令仍然会被执行没有回滚第二节脚本什么是什么是脚本是一个小巧的脚本语言脚本语言脚本可以很容易的被代码调用也可以反过来调用的函数并没有提供强大的库一个完整的解释器不过所以不适合作为开发独立应用程序的语言而是作为嵌入式脚本语言很多应用程序游戏使用作为自己的嵌入式脚本语言以此来实现可配置性可扩展性这其中包括魔兽争霸地图魔兽世界博德之门愤怒的小鸟等众多游戏插件或外挂脚本的优势将复杂的或者多步的操作写为一个脚本一次提交给执行减少反复连接的次数提升性能脚本是类似事务有一定的原子性不会被其他命令插队可以完成一些事务性的操作但是注意的脚本功能只有在以上的版本才可以使用利用脚本淘汰用户解决超卖问题版本以后通过脚本解决争抢问题实际上是利用其单线程的特性用任务队列的方式解决多任务并发问题创建工程引入相关依赖创建配置文件创建脚本创建文件夹创建脚本文件脚本创建配置类简单序列化设置键序列化方式设置简单类型值的序列化方式设置默认序列化方式加载脚本设置返回值类型创建测试类修改成功修改失败手工添加一个值再试试修改成功修改失败说明需要传入三个值第一个参数脚本第二个参数集合如果是单个参数使用这个可以转换为单元素集合参数多参数第三个参数也就是其他类型参数第八章的持久化顺序跳过了学习目标熟悉持久化的概念熟悉持久化方式特点以及相关操作熟悉持久化方式特点以及相关操作第一节持久化总体介绍是将数据集整体存下来存在磁盘是存操作命令后面全部执行一次我们知道是一个内存型数据库内存的特性是掉电或者程序退出则不保存数据但是经过实测我们发现重启服务后之前存储的数据仍然在那么这就是通过持久化的方式实现的提供了个不同形式的持久化方式定时数据快照默认方式指令日志文件手动开启第二节持久化简介在指定的时间间隔内将内存中的数据集快照写入磁盘也就是行话讲的快照它恢复时是将快照文件直接读到内存里持久化流程执行流程会单独创建一个子进程来进行持久化会先将数据写入到一个临时文件中待持久化过程都结束了再用这个临时文件替换上次持久化好的文件整个过程中主进程是不进行任何操作的这就确保了极高的性能如果需要进行大规模数据的恢复且对于数据恢复的完整性不是非常敏感那方式要比方式更加的高效的缺点是最后一次持久化后的数据可能丢失子进程的作用是复制一个与当前进程一样的进程新进程的所有数据变量环境变量程序计数器等数值都和原进程一致但是是一个全新的进程并作为原进程的子进程在程序中会产生一个和父进程完全相同的子进程但子进程在此后多会系统调用出于效率考虑中引入了写时复制技术一般情况父进程和子进程会共用同一段物理内存只有进程空间的各段的内容要发生变化时才会将父进程的内容复制一份给子进程持计划流程图相关配置与操作自动触发文件名配置在中配置文件名称默认为我是开发改成单机版可以不改能使用命令获取配置文件位置配置文件的保存路径也可以修改默认为启动时命令行所在的目录下可以通过修改该配置将文件存到系统的指定目录下我就改成了自动执行快照策略命令临时这只快照执行策略格式秒钟写操作次数是整个内存的压缩过的的数据结构可以配置复合的快照触发条件默认是分钟至少万个发生变化或分钟至少个发生变化或个小时至少个发生变化禁用不设置指令或者给传入空字符串比如配置对变化的计数是累计的间隔秒修改次数个自动触发手动执行快照命令使用主进行进行持久化指令时只管保存其它不管全部阻塞手动保存不建议会在后台异步进行快照操作快照同时还可以响应客户端请求可以通过命令获取最后一次成功执行快照的时间命令执行命令也会产生文件但里面是空的无意义命令命令在关系服务的时候也会进行自动的持久化创建文件备份异常策略配置当无法写入磁盘的话直接关掉的写操作推荐文件压缩配置配置对于存储到磁盘中的快照可以设置是否进行压缩存储如果是的话会采用算法进行压缩如果你不想消耗来进行压缩的话可以设置为关闭此功能推荐文件检查完整性配置配置在存储快照后还可以让使用算法来进行数据校验但是这样做会增加大约的性能消耗如果希望获取到最大的性能提升可以关闭此功能推荐手动备份操作查询文件的目录将的文件拷贝到别的地方的恢复关闭先把备份的文件拷贝到工作目录下启动备份数据会直接加载禁用操作修改配置文件永久禁用通过指令临时禁用动态停止后给空值表示禁用保存策略不建议的优势和劣势优势适合大规模的数据恢复对数据完整性和一致性要求不高更适合使用节省磁盘空间恢复速度快劣势的时候内存中的数据被克隆了一份大致倍的膨胀性需要考虑虽然在时使用了写时拷贝技术但是如果数据庞大时还是比较消耗性能在备份周期在一定间隔时间做一次备份所以如果意外掉的话就会丢失最后一次快照后的所有修改小总结第三节持久化简介以日志的形式来记录每个写操作增量保存将执行过的所有写指令记录下来读操作不记录只许追加文件但不可以改写文件启动之初会读取该文件重新构建数据换言之重启的话就根据日志文件的内容将写指令从前到后执行一次以完成数据的恢复工作持计划流程客户端的请求写命令会被追加到缓冲区内缓冲区根据持久化策略将操作同步到磁盘的文件中文件大小超过重写策略或手动重写时会对文件重写压缩文件容量服务重启时会重新加载文件中的写操作达到数据恢复的目的相关配置与操作文件名配置可以在中配置文件名称默认为文件位置路径中文件的保存路径同的路径一致有变化基本文件增量文件清单文件开启修复恢复操作的备份机制和性能虽然和不同但是备份和恢复的操作同一样都是拷贝备份文件需要恢复时再拷贝到工作目录下启动系统即加载正常恢复数据修改默认的改为开启方式将有数据的文件复制一份保存到对应目录查看目录恢复重启然后重新加载异常修复数据修改默认的改为如遇到文件损坏通过进行恢复备份被写坏的文件恢复重启然后重新加载同步频率设置始终同步每次的写入都会立刻记入日志性能较差但数据完整性比较好每秒同步每秒记入日志一次如果宕机本秒的数据可能丢失不主动进行同步把同步时机交给操作系统压缩配置什么是文件压缩重写采用文件追加方式文件会越来越大为避免出现此种情况新增了重写机制当文件的大小超过所设定的阈值时就会启动文件的内容压缩只保留可以恢复数据的最小指令集可以使用命令如何实现重写文件持续增长而过大时会出一条新进程来将文件重写也是先写临时文件最后再版本后的重写是指上就是把的快照以二级制的形式附在新的头部作为已有的历史数据替换掉原来的流水账操作设置重写策略如果不写入文件只写入缓存用户请求不会阻塞但是在这段时间如果宕机会丢失这段时间的缓存数据降低数据安全性提高性能如果还是会把数据往磁盘里刷但是遇到重写操作可能会发生阻塞数据安全但是性能降低何时触发重写会记录上次重写时的大小默认配置是当文件大小是上次后大小的一倍且文件大于时触发重写虽然可以节约大量磁盘空间减少恢复时间但是每次重写还是有一定的负担的因此设定要满足一定条件才会进行重写设置重写基准值文件达到时开始重写文件是原来重写后文件的倍时触发设置重写基准值最小文件达到这个值开始重写例如文件达到开始重写降到下次什么时候开始重写系统载入时或者上次重写完毕时会记录此时大小设为如果的当前大小默认且当前大小默认的情况下会对进行重写重写的流程是触发重写判断是否当前有或在运行如果有则等待该命令结束后再继续执行主进程出子进程执行重写操作保证主进程不会阻塞子进程遍历内存中数据到临时文件客户端的写请求同时写入缓冲区和重写缓冲区保证原文件完整以及新文件生成期间的新的数据修改动作不会丢失子进程写完新的文件后向主进程发信号父进程更新统计信息主进程把中的数据写入到新的文件使用新的文件覆盖旧的文件完成重写的优势备份机制更稳健丢失数据概率更低可读的日志文本通过操作稳健可以处理误操作的劣势比起占用更多的磁盘空间恢复备份速度要慢每次读写都同步的话有一定的性能压力存在个别造成无法恢复小总结持久化方案选择和用哪个好官方推荐两个都启用如果对数据不敏感可以选单独用不建议单独用因为可能会出现如果只是做纯内存缓存可以都不用和如果同时开启系统默认取中的持久化数据官网建议持久化方式能够在指定的时间间隔能对你的数据进行快照存储持久化方式记录每次对服务器写的操作当服务器重启的时候会重新执行这些命令来恢复原始的数据命令以协议追加保存每次写的操作到文件末尾还能对文件进行后台重写使得文件的体积不至于过大只做缓存如果你只希望你的数据在服务器运行的时候存在你也可以不使用任何持久化方式同时开启两种持久化方式在这种情况下当重启的时候会优先载入文件来恢复原始的数据因为在通常情况下文件保存的数据集要比文件保存的数据集要完整的数据不实时同时使用两者时服务器重启也只会找文件那要不要只使用呢建议不要因为更适合用于备份数据库在不断变化不好备份快速重启而且不会有可能潜在的留着作为一个万一的手段性能建议因为文件只用作后备用途建议只在上持久化文件而且只要分钟备份一次就够了只保留这条规则如果使用好处是在最恶劣情况下也只会丢失不超过两秒数据启动脚本较简单只自己的文件就可以了代价一是带来了持续的二是的最后将过程中产生的新数据写到新文件造成的阻塞几乎是不可避免的只要硬盘许可应该尽量减少的频率重写的基础大小默认值太小了可以设到以上默认超过原大小大小时重写可以改到适当的数值第九章主从复制学习目标熟悉主从复制的特点能搭建的一主二仆和哨兵模式第一节什么是主从复制主机数据更新后根据配置和策略自动同步到备机的机制以写为主以读为主第二节主从复制的作用读写分离性能扩展容灾快速恢复第三节主从复制具体操作实现思路一个服务作为主机主要负责写操作两个服务作为从机主要负责读操作从机自动从主机同步数据下来从机主动找主机而主机不会找从机正常来说主机和从机应该在不同的上开启服务我们为了快速模拟可以在一台机器上模拟出三个服务即可一台机器上启动多个服务使用启动服务时要以来配置文件那么我们可以准备三个文件用来配置三个不同的服务启动三次分别以来三个不同的服务即可新建三个配置文件用于定义每个服务的专属配置新建关闭功能含义介绍引入共同的配置使用独立的进程文件设置当前服务的端口号使用独立的持久化文件暂时不适用持久化新建新建在中多添加一个配置设置从机的优先级值越小优先级越高用于选举主机时使用默认启动三个服务查看启动服务进程使用查看主从相关信息连接使用端口号执行查看信息配置主从机器配从不配主是让从机主动去找主机在和的机器上执行如下命令执行完毕再次查看主从配置信息测试主从读写操作主机上写入数据在从机上写数据报错主机宕机重启即可恢复主从状态无需其他操作从机宕机重启后需要重新执行才能恢复从机可以在配置文件中写入这样重启无需手动输入就可以恢复从机状态第四节主从复制原理启动成功连接到后会发送一个命令接到命令启动后台的存盘进程同时收集所有接收到的用于修改数据集命令在后台进程执行完毕之后将传送整个数据文件到以完成一次完全同步全量复制而服务在接收到数据库文件数据后将其存盘并加载到内存中增量复制继续将新的所有收集到的修改命令依次传给完成同步但是只要是重新连接一次完全同步全量复制将被自动执行第五节主动复制三种模式第一种一主二仆问题切入点问题是从头开始复制还是从切入点开始复制比如从进来那之前的是否也可以复制问题从机是否可以写可否问题主机后情况如何从机是上位还是原地待命问题主机又回来了后主机新增记录从机还能否顺利复制问题其中一台从机后情况如何依照原有它能跟上大部队吗还会自动变为从机吗第二种薪火相传上一个可以是下一个的同样可以接收其他的连接和同步请求那么该作为了链条中下一个的可以有效减轻的写压力去中心化降低风险用中途变更转向会清除之前的数据重新建立拷贝最新的风险是一旦某个宕机后面的都没法备份主机挂了从机还是从机无法写数据了第三种反客为主当一个宕机后后面的可以立刻升为其后面的不用做任何修改用将从机变为主机第六节哨兵模式哨兵模式简介反客为主的自动版能够后台监控主机是否故障如果故障了根据投票数自动将从库转换为主库哨兵模式的使用步骤第一步设置简单的一主二仆第二步为哨兵模式准备配置文件在目录下新建配置文件中放入如下内容其中为监控对象起的服务器名称为至少有多少个哨兵同意迁移的数量第三步启动哨兵运行下命令执行配置文件做压测可以用自带的工具哨兵模式的操作演示主机宕机演示当主机宕机会从从机中选择一个作为新的主机根据优先级原主机重启后会成为从机复制延时由于所有的写操作都是先在上操作然后同步更新到上所以从同步到机器有一定的延迟当系统很繁忙的时候延迟问题会更加严重机器数量的增加也会使这个问题更加严重故障恢复优先级在中默认值越小优先级越高偏移量是指获得原主机数据最全的每个实例启动后都会随机生成一个位的第十章集群操作学习目标熟悉中的集群模式特点能够独立搭建的集群能够熟练操作集群目前面临问题分析容量不够如何进行扩容并发写操作如何分摊另外主从模式薪火相传模式主机宕机导致地址发生变化应用程序中配置需要修改对应的主机地址端口等信息之前通过代理主机来解决但是中提供了解决方案就是无中心化集群配置什么是集群集群实现了对的水平扩容即启动个节点将整个数据库分布存储在这个节点中每个节点存储总数据的集群通过分区来提供一定程度的可用性即使集群中有一部分节点失效或者无法进行通讯集群也可以继续处理命令请求集群的搭建第一步搭建前的准备之前操作产生的和文件删除修改回清空主从复制和哨兵模式留下的一些文件开启注释掉第二步制作六个实例的配置文件配置文件的内容内容解释引用公共的配置文件设置端口号设置进程文件设置持久化问价名开启集群设置集群使用的结点文件名设置结点失联时间创建六个结点的配置文件创建一个配置文件后进行复制即可然后再下通过目标端口来批量替换每个配置文件中的端口号第三步启动六个服务组合之前请确保所有实例启动后文件都生成正常第四步将六个服务合并为一个集群切换目录到的下运行如下指令此处不要用请用真实地址采用最简单的方式配置集群一台主机一台从机正好三组输入继续集群的登录集群登录方式登录指令添加代表以集群方式登录登录后查看集群信息一个集群至少要有三个主节点选项表示我们希望为集群中的每个主节点创建一个从节点分配原则尽量保证每个主数据库运行在不同的每个从库和主库不在一个地址上集群的一个集群包含个插槽数据库中的每个键都属于这个插槽的其中一个集群使用公式来计算键属于哪个槽其中语句用于计算键的校验和集群中的每个节点负责处理一部分插槽举个例子如果一个集群可以有主节点其中节点负责处理号至号插槽节点负责处理号至号插槽节点负责处理号至号插槽集群中录入值在每次录入查询键值都会计算出该应该送往的插槽如果不是该客户端对应服务器的插槽会报错并告知应前往的实例地址和端口客户端提供了参数实现自动重定向如登入后再录入查询键值对可以自动重定向不在一个下的键值是不能使用等多键操作可以通过来定义组的概念从而使中内相同内容的键值对放到一个中去集群中查找值计算应该保存在那个插槽的值计算某个插槽中保存的的数量返回个槽中的键集群故障恢复如果主节点下线从节点能否自动升为主节点注意秒超时主节点恢复后主从关系会如何主节点回来变成从机如果所有某一段插槽的主从节点都宕掉服务是否还能继续中为那么整个集群都挂掉中为那么只有该插槽数据全都不能使用集群提供的好处实现扩容分摊压力无中心配置相对简单集群的不足多键操作是不被支持的多键的事务是不被支持的脚本不被支持由于集群方案出现较晚很多公司已经采用了其他的集群方案而代理或者客户端分片的方案想要迁移至需要整体迁移而不是逐步过渡复杂度较大',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-10-08 22:29:26',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.0.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://this0.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.png" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">This0</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a><div id="he-plugin-simple"></div><script>var WIDGET = {
  "CONFIG": {
    "modules": "0124",
    "background": "2",
    "tmpColor": "FFFFFF",
    "tmpSize": "16",
    "cityColor": "FFFFFF",
    "citySize": "16",
    "aqiColor": "E8D87B",
    "aqiSize": "16",
    "weatherIconSize": "24",
    "alertIconSize": "18",
    "padding": "10px 10px 10px 10px",
    "shadow": "0",
    "language": "auto",
    "borderRadius": "20",
    "fixed": "true",
    "vertical": "top",
    "horizontal": "left",
    "left": "20",
    "top": "7.1",
    "key": "df245676fb434a0691ead1c63341cd94"
  }
}
</script><link rel="stylesheet" href="https://widget.qweather.net/simple/static/css/he-simple.css?v=1.4.0"/><script src="https://widget.qweather.net/simple/static/js/he-simple.js?v=1.4.0"></script></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 归档</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 休闲</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 个人</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 唠叨</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于站长</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://cdn.this0.com/blog/base/wechat.jpg" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://cdn.this0.com/blog/base/wechat.jpg"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://cdn.this0.com/blog/base/alipay.jpg" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://cdn.this0.com/blog/base/alipay.jpg"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Docker/" style="font-size: 1.05rem;">Docker<sup>3</sup></a><a href="/tags/JavaSE/" style="font-size: 1.05rem; font-weight: 500; color: var(--anzhiyu-lighttext)">JavaSE<sup>18</sup></a><a href="/tags/JavaWeb/" style="font-size: 1.05rem;">JavaWeb<sup>1</sup></a><a href="/tags/Java%E9%A1%B9%E7%9B%AE/" style="font-size: 1.05rem;">Java项目<sup>1</sup></a><a href="/tags/Linux/" style="font-size: 1.05rem;">Linux<sup>1</sup></a><a href="/tags/Maven/" style="font-size: 1.05rem;">Maven<sup>1</sup></a><a href="/tags/MyBatis-Plus/" style="font-size: 1.05rem;">MyBatis-Plus<sup>1</sup></a><a href="/tags/Mybatis/" style="font-size: 1.05rem;">Mybatis<sup>1</sup></a><a href="/tags/Redis/" style="font-size: 1.05rem;">Redis<sup>1</sup></a><a href="/tags/SSM/" style="font-size: 1.05rem;">SSM<sup>3</sup></a><a href="/tags/SpringBoot/" style="font-size: 1.05rem;">SpringBoot<sup>1</sup></a><a href="/tags/SpringFramework/" style="font-size: 1.05rem;">SpringFramework<sup>1</sup></a><a href="/tags/SpringMVC/" style="font-size: 1.05rem;">SpringMVC<sup>1</sup></a><a href="/tags/gateway/" style="font-size: 1.05rem;">gateway<sup>1</sup></a><a href="/tags/mysql/" style="font-size: 1.05rem;">mysql<sup>1</sup></a><a href="/tags/nacos/" style="font-size: 1.05rem;">nacos<sup>1</sup></a><a href="/tags/nvm/" style="font-size: 1.05rem;">nvm<sup>1</sup></a><a href="/tags/sss/" style="font-size: 1.05rem;">sss<sup>1</sup></a><a href="/tags/%E5%B7%A5%E5%85%B7%E6%96%87%E6%A1%A3/" style="font-size: 1.05rem;">工具文档<sup>1</sup></a><a href="/tags/%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/" style="font-size: 1.05rem;">开发环境<sup>1</sup></a><a href="/tags/%E6%97%85%E6%B8%B8/" style="font-size: 1.05rem;">旅游<sup>1</sup></a><a href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E5%BC%80%E5%8F%91/" style="font-size: 1.05rem;">服务器端开发<sup>1</sup></a><a href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%BF%90%E7%BB%B4/" style="font-size: 1.05rem;">服务器运维<sup>3</sup></a><a href="/tags/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" style="font-size: 1.05rem;">环境搭建<sup>2</sup></a><a href="/tags/%E7%BD%91%E5%85%B3/" style="font-size: 1.05rem;">网关<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%AB%99%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3/" style="font-size: 1.05rem;">网站说明文档<sup>2</sup></a><a href="/tags/%E9%98%B2%E7%81%AB%E5%A2%99/" style="font-size: 1.05rem;">防火墙<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/10/"><span class="card-archive-list-date">十月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">19</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/04/"><span class="card-archive-list-date">四月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/02/"><span class="card-archive-list-date">二月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">7</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/01/"><span class="card-archive-list-date">一月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">12</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/12/"><span class="card-archive-list-date">十二月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">6</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/11/"><span class="card-archive-list-date">十一月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">6</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/10/"><span class="card-archive-list-date">十月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2023/08/"><span class="card-archive-list-date">八月 2023</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="article-meta tags"><a class="article-meta__tags" href="/tags/sss/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>sss</span></a></span></div></div><h1 class="post-title" itemprop="name headline">微服务项目架构搭建</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-02-20T18:23:58.000Z" title="发表于 2024-02-21 02:23:58">2024-02-21</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-10-08T14:29:26.293Z" title="更新于 2024-10-08 22:29:26">2024-10-08</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">18.6k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>69分钟</span></span><span class="post-meta-separator"></span><span id="" data-flag-title="微服务项目架构搭建"><i class="anzhiyufont anzhiyu-icon-fw-eye post-meta-icon"></i><span class="post-meta-label" title="阅读量">阅读量:</span><span id="twikoo_visitors" title="访问量"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为成都"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>成都</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src=""></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://www.this0.com/articles/40c5a151.html"><header><a href="/tags/sss/" tabindex="-1" itemprop="url">sss</a><h1 id="CrawlerTitle" itemprop="name headline">微服务项目架构搭建</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">YuPengtao</span><time itemprop="dateCreated datePublished" datetime="2024-02-20T18:23:58.000Z" title="发表于 2024-02-21 02:23:58">2024-02-21</time><time itemprop="dateCreated datePublished" datetime="2024-10-08T14:29:26.293Z" title="更新于 2024-10-08 22:29:26">2024-10-08</time></header><h1 id="第一章-NoSQL数据库"><a href="#第一章-NoSQL数据库" class="headerlink" title="第一章 NoSQL数据库"></a>第一章 NoSQL数据库</h1><h2 id="学习目标"><a href="#学习目标" class="headerlink" title="学习目标"></a>学习目标</h2><p>1 了解什么是NoSQL 数据库及常见的NoSQL数据库</p>
<p>2 了解其他类型数据库</p>
<h2 id="第一节-NoSQL数据库概述"><a href="#第一节-NoSQL数据库概述" class="headerlink" title="第一节 NoSQL数据库概述"></a>第一节 NoSQL数据库概述</h2><h3 id="1-1-什么是NoSQL数据库"><a href="#1-1-什么是NoSQL数据库" class="headerlink" title="1.1 什么是NoSQL数据库"></a>1.1 什么是NoSQL数据库</h3><blockquote>
<p>NoSQL(NoSQL &#x3D; Not Only SQL )，意即“不仅仅是SQL”，泛指非关系型的数据库。</p>
</blockquote>
<ul>
<li>不遵循SQL标准。</li>
<li>不支持ACID。</li>
<li>远超于SQL的性能。</li>
</ul>
<h3 id="1-2-NoSQL适用的场景"><a href="#1-2-NoSQL适用的场景" class="headerlink" title="1.2 NoSQL适用的场景"></a>1.2 NoSQL适用的场景</h3><ul>
<li>对数据高并发的读写</li>
<li>海量数据的读写</li>
<li>对数据高可扩展性的</li>
</ul>
<h3 id="1-3-NoSQL不适用的场景"><a href="#1-3-NoSQL不适用的场景" class="headerlink" title="1.3 NoSQL不适用的场景"></a>1.3 NoSQL不适用的场景</h3><ul>
<li><p>需要事务支持</p>
</li>
<li><p>基于sql的结构化查询存储，处理复杂的关系查询</p>
<p>&#x2F;&#x2F;TODO,不支持事务，不支持ACID,不适用处理复杂关系的查询，但是redis每个都是原子操作</p>
</li>
</ul>
<h3 id="1-4-常见NoSQL数据库"><a href="#1-4-常见NoSQL数据库" class="headerlink" title="1.4 常见NoSQL数据库"></a>1.4 常见NoSQL数据库</h3><h4 id="1-4-1-Memcached"><a href="#1-4-1-Memcached" class="headerlink" title="1.4.1 Memcached"></a>1.4.1 Memcached</h4><p>1 很早出现的NoSql数据库</p>
<p>2 <strong>数据都在内存中，一般不持久化</strong></p>
<p>3 支持简单的key-value模式，<strong>支持类型单一</strong></p>
<p>4 一般是作为<strong>缓存数据库</strong>辅助持久化的数据库</p>
<p>&#x2F;&#x2F;TODO,Memcached不支持持久化，仅支持key-value</p>
<h4 id="1-4-2-Redis"><a href="#1-4-2-Redis" class="headerlink" title="1.4.2 Redis"></a>1.4.2 Redis</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329197.png?x-oss-process=style/this0-blog"></p>
<p>1 几乎覆盖了Memcached的绝大部分功能</p>
<p>2 数据都在内存中，<strong>支持持久化，主要用作备份恢复</strong></p>
<p>3 除了支持简单的key-value模式，还支持多种数据结构的存储，比如 list、set、hash、zset等。</p>
<p>4 一般是作为<strong>缓存数据库</strong>辅助持久化的数据库</p>
<p>&#x2F;&#x2F;TODO,支持持久化，更多数据结构</p>
<h4 id="1-4-3-MongoDB"><a href="#1-4-3-MongoDB" class="headerlink" title="1.4.3 MongoDB"></a>1.4.3 MongoDB</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329198.png?x-oss-process=style/this0-blog"></p>
<p>1 高性能、开源、模式自由(schema free)的<strong>文档型数据库</strong></p>
<p>2 数据都在内存中， 如果内存不足，把不常用的数据保存到硬盘</p>
<p>3 虽然是key-value模式，但是对value（尤其是<strong>json</strong>）提供了丰富的查询功能</p>
<p>4 支持二进制数据及大型对象</p>
<p>5 可以根据数据的特点<strong>替代RDBMS</strong> ，成为独立的数据库。或者配合RDBMS，存储特定的数据。</p>
<p>&#x2F;&#x2F;TODO,文档型数据库</p>
<h2 id="第二节-DB-Engines数据库排名"><a href="#第二节-DB-Engines数据库排名" class="headerlink" title="第二节 DB-Engines数据库排名"></a>第二节 DB-Engines数据库排名</h2><p>查看连接<a target="_blank" rel="noopener" href="http://db-engines.com/en/ranking" title="http://db-engines.com/en/ranking"><strong>http://db-engines.com/en/ranking</strong></a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329199.png?x-oss-process=style/this0-blog" alt="image-20230627115200495"></p>
<h1 id="第二章-Redis简介和安装"><a href="#第二章-Redis简介和安装" class="headerlink" title="第二章 Redis简介和安装"></a>第二章 Redis简介和安装</h1><h2 id="学习目标-1"><a href="#学习目标-1" class="headerlink" title="学习目标"></a>学习目标</h2><p>1 能够独立完成redis数据库的安装和启动方式调试</p>
<p>2 能够简单操作redis数据库</p>
<h2 id="第一节-Redis简介和适用场景"><a href="#第一节-Redis简介和适用场景" class="headerlink" title="第一节 Redis简介和适用场景"></a>第一节 Redis简介和适用场景</h2><ul>
<li><p>Redis是key-value存储系统（区别于MySQL的二维表格的形式存储。）</p>
</li>
<li><p>Redis数据都是缓存在计算机内存中，但是Redis会周期性的把更新的数据写入磁盘或者把修改操作写入追加的记录文件，实现数据的持久化。</p>
</li>
<li><p>Redis读写速度快，Redis读取的速度是110000次&#x2F;s，写的速度是81000次&#x2F;s；</p>
</li>
<li><p>Redis的所有操作都是原子性的。</p>
</li>
<li><p>Redis支持多种数据结构：string（字符串），list（列表），hash（哈希），set（集合），zset(有序集合)</p>
</li>
<li><p>Redis支持集群部署</p>
</li>
<li><p>支持过期时间，支持事务，消息订阅</p>
</li>
</ul>
<h3 id="1-1-配合关系型数据库做高速缓存"><a href="#1-1-配合关系型数据库做高速缓存" class="headerlink" title="1.1 配合关系型数据库做高速缓存"></a>1.1 配合关系型数据库做高速缓存</h3><p>1 高频次，热门访问的数据，降低数据库IO</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329200.png?x-oss-process=style/this0-blog"></p>
<h3 id="1-2-多样的数据结构存储持久化数据"><a href="#1-2-多样的数据结构存储持久化数据" class="headerlink" title="1.2 多样的数据结构存储持久化数据"></a>1.2 多样的数据结构存储持久化数据</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329201.png?x-oss-process=style/this0-blog"></p>
<h2 id="第二节-Redis的安装和基本操作"><a href="#第二节-Redis的安装和基本操作" class="headerlink" title="第二节 Redis的安装和基本操作"></a>第二节 Redis的安装和基本操作</h2><h3 id="2-1-安装"><a href="#2-1-安装" class="headerlink" title="2.1 安装"></a>2.1 安装</h3><p>&#x2F;&#x2F;TODO，archlinux安装redis见站内文章：</p>
<h3 id="2-2-Redis的启动和停止"><a href="#2-2-Redis的启动和停止" class="headerlink" title="2.2 Redis的启动和停止"></a>2.2 Redis的启动和停止</h3><h4 id="2-2-1-查看安装目录"><a href="#2-2-1-查看安装目录" class="headerlink" title="2.2.1 查看安装目录"></a>2.2.1 查看安装目录</h4><p>进入自己的安装路径，然后执行</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ls</span> |<span class="keyword">grep</span> redis</span><br></pre></td></tr></table></figure>

<ul>
<li><p>redis-benchmark:性能测试工具，可以在自己本子运行，看看自己本子性能如何</p>
<p>&#x2F;&#x2F;TODO,后面演示</p>
</li>
<li><p>redis-check-aof：修复有问题的AOF文件，rdb和aof后面讲</p>
</li>
<li><p>redis-check-dump：修复有问题的dump.rdb文件</p>
</li>
<li><p>redis-sentinel：Redis集群使用</p>
</li>
<li><p>redis-server：Redis服务器启动命令</p>
</li>
<li><p>redis-cli：客户端，操作入口</p>
</li>
</ul>
<h4 id="2-2-2-默认配置文件拷贝到自定义路径"><a href="#2-2-2-默认配置文件拷贝到自定义路径" class="headerlink" title="2.2.2 默认配置文件拷贝到自定义路径"></a>2.2.2 默认配置文件拷贝到自定义路径</h4><p>养成好习惯，拷贝到自定义路径能留个备份</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp <span class="regexp">/etc/</span>redis<span class="regexp">/redis.conf /</span>home<span class="regexp">/ypt/</span>SDE<span class="regexp">/myredis/</span>redis7.conf</span><br></pre></td></tr></table></figure>

<p>配置文件修改4处：</p>
<p>1 后端启动</p>
<p>daemonize yes</p>
<p>2 保护模式</p>
<p>protected-mode no</p>
<p>3 远程连接</p>
<p>注释掉</p>
<p>bind 127.0.0.1 -::1</p>
<p>4 redis访问密码</p>
<p>requirepass redis</p>
<h4 id="2-2-3-前台启动方式"><a href="#2-2-3-前台启动方式" class="headerlink" title="2.2.3 前台启动方式"></a>2.2.3 前台启动方式</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server</span><br></pre></td></tr></table></figure>

<p>不推荐原因: 窗口不能关闭,关闭则服务停止</p>
<h4 id="2-2-4-后台启动方式"><a href="#2-2-4-后台启动方式" class="headerlink" title="2.2.4 后台启动方式"></a>2.2.4 后台启动方式</h4><p>启动redis时,使用我们自己修改之后的配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server /home/ypt/SDE/myredis/redis7.conf</span><br></pre></td></tr></table></figure>

<ul>
<li>查看服务启动状态</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep redis</span><br></pre></td></tr></table></figure>

<h4 id="2-2-5-通过客户端连接redis"><a href="#2-2-5-通过客户端连接redis" class="headerlink" title="2.2.5 通过客户端连接redis"></a>2.2.5 通过客户端连接redis</h4><ul>
<li>通过客户端指令连接redis</li>
</ul>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli</span><br></pre></td></tr></table></figure>

<ul>
<li>如果想退出客户端可以 按 Ctrl+c  ,退出客户端不会关闭redis服务</li>
<li>通过客户端连接指定端口下的redis (默认6379)</li>
</ul>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -p 6379</span><br></pre></td></tr></table></figure>

<ul>
<li>连接后,测试与redis的连通性</li>
</ul>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping</span><br></pre></td></tr></table></figure>

<p>带密码连接</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-<span class="keyword">cli</span> -a 密码</span><br></pre></td></tr></table></figure>

<h4 id="2-3-6-停止redis服务"><a href="#2-3-6-停止redis服务" class="headerlink" title="2.3.6 停止redis服务"></a>2.3.6 停止redis服务</h4><ul>
<li>单实例<code>非客户端连接模式</code>下关闭服务</li>
</ul>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli shutdown</span><br></pre></td></tr></table></figure>

<ul>
<li>在<code>客户端连接模式</code>下,直接使用shutdown关闭当前连接的redis服务</li>
</ul>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shutdown</span><br></pre></td></tr></table></figure>

<ul>
<li><code>多实例</code>关闭指定端口的redis服务</li>
</ul>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -p 6379 shutdown</span><br></pre></td></tr></table></figure>

<h4 id="2-3-7-Redis端口号-6379-由来"><a href="#2-3-7-Redis端口号-6379-由来" class="headerlink" title="2.3.7 Redis端口号 6379 由来"></a>2.3.7 Redis端口号 6379 由来</h4><p>Alessia <strong>Merz</strong></p>
<hr>
<p>&#x2F;&#x2F;TODO，跳过了，回头看</p>
<h1 id="TODO"><a href="#TODO" class="headerlink" title="&#x2F;&#x2F;TODO"></a>&#x2F;&#x2F;TODO</h1><h5 id="（2）数据库操作"><a href="#（2）数据库操作" class="headerlink" title="（2）数据库操作"></a>（2）数据库操作</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">默认16个数据库，类似数组下标从0开始，初始默认使用0号库</span><br><span class="line">使用命令 select &lt;dbid&gt;来切换数据库。如: select 8</span><br><span class="line">统一密码管理，所有库同样密码。</span><br><span class="line">dbsize查看当前数据库的key的数量</span><br><span class="line">flushdb清空当前库</span><br><span class="line">flushall通杀全部库</span><br></pre></td></tr></table></figure>

<h5 id="（3）Redis单线程-多路复用"><a href="#（3）Redis单线程-多路复用" class="headerlink" title="（3）Redis单线程+多路复用"></a>（3）Redis单线程+多路复用</h5><p>多路复用是指使用一个线程来检查多个文件描述符（Socket）的就绪状态，比如调用select和poll函数，传入多个文件描述符，如果有一个文件描述符就绪，则返回，否则阻塞直到超时。得到就绪状态后进行真正的操作可以在同一个线程里执行，也可以启动线程执行（比如使用线程池）</p>
<ul>
<li>多路：指的是多个网络连接客户端</li>
<li>复用：指的是复用同一个线程</li>
<li>I&#x2F;O 多路复用：其实是使用一个线程来检查多个 Socket 的就绪状态，在单个线程中通过记录跟踪每一个 socket（I&#x2F;O流）的状态来管理处理多个 I&#x2F;O 流。</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329212.png?x-oss-process=style/this0-blog" alt="image-20230706100628816"></p>
<p>1、一个 socket 客户端与服务端连接时，会生成对应一个套接字描述符(套接字描述符是文件描述符的一种)，每一个 socket 网络连接其实都对应一个文件描述符。</p>
<ul>
<li>文件描述符(file descriptor)： Linux 系统中，把一切都看做是文件，当进程打开现有文件或创建新文件时，内核向进程返回一个文件描述符。可以理解文件描述符是一个索引，这样，要操作文件的时候，我们直接找到索引就可以对其进行操作了。我们将这个索引叫做文件描述符（file descriptor），简称fd。</li>
</ul>
<p>2、多个客户端与服务端连接时，Redis 使用 「I&#x2F;O 多路复用程序」 将客户端 socket 对应的 FD 注册到监听列表(一个队列)中。当客服端执行 read、write 等操作命令时，I&#x2F;O 多路复用程序会将命令封装成一个事件，并绑定到对应的 FD 上。</p>
<p>3、「文件事件处理器」使用 I&#x2F;O 多路复用模块同时监控多个文件描述符（fd）的读写情况，当 accept、read、write 和 close 文件事件产生时，文件事件处理器就会回调 FD 绑定的事件处理器进行处理相关命令操作。</p>
<p>4、文件事件分派器接收到I&#x2F;O多路复用程序传来的套接字fd后，并根据套接字产生的事件类型，将套接字派发给相应的事件处理器来进行处理相关命令操作。</p>
<p>5、整个文件事件处理器是在单线程上运行的，但是通过 I&#x2F;O 多路复用模块的引入，实现了同时对多个 FD 读写的监控，当其中一个 client 端达到写或读的状态，文件事件处理器就马上执行，从而就不会出现 I&#x2F;O 堵塞的问题，提高了网络通信的性能。</p>
<h1 id="第三章-Redis常用数据类型和命令"><a href="#第三章-Redis常用数据类型和命令" class="headerlink" title="第三章 Redis常用数据类型和命令"></a>第三章 Redis常用数据类型和命令</h1><h2 id="学习目标-2"><a href="#学习目标-2" class="headerlink" title="学习目标"></a>学习目标</h2><p>1 Redis的数据类型</p>
<p>redis的存储时 key-value形式的,这里的五大类型指的是 value的五种数据类型</p>
<p>&#x2F;&#x2F;TODO</p>
<ul>
<li><p>String</p>
</li>
<li><p>List</p>
</li>
<li><p>Hash (key-value键值对)</p>
</li>
<li><p>Set （无序集合）</p>
</li>
<li><p>Zset</p>
</li>
</ul>
<hr>
<p>不常用的5个</p>
<ul>
<li>GEO （经纬度）</li>
<li>HyperLogLog （基数统计）</li>
<li>bitmap（位图）</li>
<li>bitfield (位域)</li>
<li>Stream （流）</li>
</ul>
<p>2 相关命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1 如何对键进行一些操作</span><br><span class="line">2 String类型的value值如何进行操作</span><br><span class="line">3 List 类型的value如何进行操作</span><br><span class="line">4 Set类型的value如何进行操作</span><br><span class="line">5 Hash类型的value如何进行操作</span><br><span class="line">6 Zset类型的value如何进行操作</span><br></pre></td></tr></table></figure>

<h2 id="第一节-key操作的相关命令"><a href="#第一节-key操作的相关命令" class="headerlink" title="第一节 key操作的相关命令"></a>第一节 key操作的相关命令</h2><p>&#x2F;&#x2F;TODO命令，记</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>keys *</td>
<td>查看当前库所有key (匹配：keys *1)</td>
</tr>
<tr>
<td>exists key</td>
<td>判断某个key是否存在</td>
</tr>
<tr>
<td>type key</td>
<td>查看你的key是什么类型</td>
</tr>
<tr>
<td>del key</td>
<td>删除指定的key数据</td>
</tr>
<tr>
<td><code>unlink key</code></td>
<td>非阻塞删除,仅将keys从keyspace元数据中删除，真正的删除会在后续异步操作</td>
</tr>
<tr>
<td>expire key 10</td>
<td>10秒钟：为给定的key设置过期时间</td>
</tr>
<tr>
<td>ttl key</td>
<td>查看还有多少秒过期，-1表示永不过期，-2表示已过期</td>
</tr>
<tr>
<td>select</td>
<td>命令切换数据库</td>
</tr>
<tr>
<td>dbsize</td>
<td>查看当前数据库的key的数量</td>
</tr>
<tr>
<td>flushdb</td>
<td>清空当前库</td>
</tr>
<tr>
<td>flushall</td>
<td>清空全部库</td>
</tr>
</tbody></table>
<p>&#x2F;&#x2F;TODO,unlink key，非阻塞删除</p>
<p>help命令 help @数据类型</p>
<h2 id="第二节-字符串类型-String"><a href="#第二节-字符串类型-String" class="headerlink" title="第二节 字符串类型(String)"></a>第二节 字符串类型(String)</h2><h3 id="2-1-简介"><a href="#2-1-简介" class="headerlink" title="2.1 简介"></a>2.1 简介</h3><p>1 String是Redis最基本的类型，你可以理解成与Memcached一模一样的类型，一个key对应一个value。</p>
<p>2 String类型是二进制安全的。意味着Redis的string可以包含任何数据。比如jpg图片或者序列化的对象。</p>
<p>3 String类型是Redis最基本的数据类型，一个Redis中字符串value最多可以是512M</p>
<h3 id="2-2-常用命令"><a href="#2-2-常用命令" class="headerlink" title="2.2 常用命令"></a>2.2 常用命令</h3><p>&#x2F;&#x2F;TODO背</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> key value [NX|<span class="type">XX</span>] [GET] [EX seconds|<span class="type">PX</span> milliseconds|<span class="type">EXAT</span> unix-<span class="built_in">time</span>-seconds|<span class="type">PXAT</span> unix-<span class="built_in">time</span>- milliseconds|<span class="type">KEEPTTL</span></span><br></pre></td></tr></table></figure>

<p>&#x2F;&#x2F;TODO,EXAT unix-time-seconds 是时间戳，秒，后面是毫秒</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td>set &lt;key&gt;&lt;value&gt;</td>
<td>添加键值对</td>
</tr>
<tr>
<td></td>
<td>NX：当数据库中key不存在时，可以将key-value添加数据库</td>
</tr>
<tr>
<td></td>
<td>XX：当数据库中key存在时，可以将key-value添加数据库，与NX参数互斥</td>
</tr>
<tr>
<td></td>
<td>EX：key的超时秒数</td>
</tr>
<tr>
<td></td>
<td>PX：key的超时毫秒数，与EX互斥</td>
</tr>
<tr>
<td>get &lt;key&gt;</td>
<td>查询对应键值</td>
</tr>
<tr>
<td>append &lt;key&gt;&lt;value&gt;</td>
<td>将给定的&lt;value&gt; 追加到原值的末尾</td>
</tr>
<tr>
<td>strlen &lt;key&gt;</td>
<td>获得值的长度</td>
</tr>
<tr>
<td>setnx &lt;key&gt;&lt;value&gt;</td>
<td>只有在 key 不存在时 设置 key 的值</td>
</tr>
<tr>
<td>incr &lt;key&gt;</td>
<td>将 key 中储存的数字值增1,只能对数字值操作，如果为空，新增值为1</td>
</tr>
<tr>
<td>decr &lt;key&gt;</td>
<td>将 key 中储存的数字值减1,只能对数字值操作，如果为空，新增值为-1</td>
</tr>
<tr>
<td>incrby &#x2F; decrby &lt;key&gt;&lt;步长&gt;</td>
<td>将 key 中储存的数字值增减。自定义步长</td>
</tr>
<tr>
<td>mset &lt;key1&gt;&lt;value1&gt;&lt;key2&gt;&lt;value2&gt; …..</td>
<td>同时设置一个或多个 key-value对</td>
</tr>
<tr>
<td>mget &lt;key1&gt;&lt;key2&gt;&lt;key3&gt; …..</td>
<td>同时获取一个或多个 value</td>
</tr>
<tr>
<td>msetnx &lt;key1&gt;&lt;value1&gt;&lt;key2&gt;&lt;value2&gt; …..</td>
<td>同时设置一个或多个 key-value 对，当且仅当所有给定 key 都不存在。有一个失败则都失败(原子性)</td>
</tr>
<tr>
<td>getrange &lt;key&gt;&lt;起始位置&gt;&lt;结束位置&gt;</td>
<td>获得值的范围，类似java中的substring，<strong>前包，后包</strong></td>
</tr>
<tr>
<td>setrange &lt;key&gt;&lt;起始位置&gt;&lt;value&gt;</td>
<td>用 &lt;value&gt; 覆写&lt;key&gt;所储存的字符串值，从&lt;起始位置&gt;开始(<strong>索引从0</strong>开始)。</td>
</tr>
<tr>
<td>setex &lt;key&gt; &lt;过期时间&gt; &lt;value&gt;</td>
<td>设置键值的同时，设置过期时间，单位秒。</td>
</tr>
<tr>
<td>getset &lt;key&gt;&lt;value&gt;</td>
<td>以新换旧，设置了新值同时获得旧值。</td>
</tr>
</tbody></table>
<p>&#x2F;&#x2F;TODO</p>
<p>set默认setxx,</p>
<p>set k1 v1 get</p>
<p>取出老的值，设置新的值v1覆盖他</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; get name</span><br><span class="line"><span class="string">&quot;zhangsan&quot;</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; set name lisi get</span><br><span class="line"><span class="string">&quot;zhangsan&quot;</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; get name</span><br><span class="line"><span class="string">&quot;lisi&quot;</span></span><br></pre></td></tr></table></figure>

<p>,整理一下顺序</p>
<p>保留原来的过期时间</p>
<p>keepttl</p>
<p>mset ，一次设置多个</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; mset  name1 zhangsan name2 lisi</span><br><span class="line"><span class="attribute">OK</span></span><br><span class="line"><span class="attribute">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; keys *</span><br><span class="line"><span class="attribute">1</span>) <span class="string">&quot;name1&quot;</span></span><br><span class="line"><span class="attribute">2</span>) <span class="string">&quot;name2&quot;</span></span><br><span class="line"><span class="attribute">3</span>) <span class="string">&quot;name&quot;</span></span><br><span class="line"><span class="attribute">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; mget  name  name1 name2</span><br><span class="line"><span class="attribute">1</span>) <span class="string">&quot;lisi&quot;</span></span><br><span class="line"><span class="attribute">2</span>) <span class="string">&quot;zhangsan&quot;</span></span><br><span class="line"><span class="attribute">3</span>) <span class="string">&quot;lisi&quot;</span></span><br><span class="line"><span class="attribute">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; </span><br></pre></td></tr></table></figure>



<p>getrange &lt;key&gt;&lt;起始位置&gt;&lt;结束位置&gt;  获得值的范围，类似java中的substring，<strong>前包，后包</strong></p>
<p>127.0.0.1:6379&gt; GETRANGE name 0 -1</p>
<p>0 到 -1 就是取全部</p>
<p>setrange设置指定区间范围内的值，格式是setrange key值 第几个字符开始 ，具体值</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403282048509.png?x-oss-process=style/this0-blog" alt="下载"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403282143643.png?x-oss-process=style/this0-blog" alt="image-20240328214346543"></p>
<p>incr key</p>
<p>incrby key increment</p>
<p>decr key</p>
<p>decrby key decrement</p>
<p>获取字符串长度和内容追加</p>
<p>&#x2F;&#x2F;TODO，</p>
<blockquote>
<p>redis指令运行的原子性</p>
</blockquote>
<ul>
<li>所谓原子操作是指不会被线程调度机制打断的操作；这种操作一旦开始，就一直运行到结束，中间不会有任何 context switch （切换到另一个线程）。<ul>
<li>（1）在单线程中， 能够在单条指令中完成的操作都可以认为是”原子操作”，因为中断只能发生于指令之间。</li>
<li>（2）在多线程中，不能被其它进程（线程）打断的操作就叫原子操作。</li>
<li>（3）Redis单命令的原子性主要得益于的单线程。</li>
</ul>
</li>
</ul>
<blockquote>
<p>问题 JAVA中的 a++ 是否具有原子性</p>
</blockquote>
<p><strong>原子性：</strong>即不可分割性。比如 a&#x3D;0；（a非long和double类型） 这个操作是不可分割的，那么我们说这个操作是原子操作。再比如：a++； 这个操作实际是a &#x3D; a + 1；是可分割的，所以他不是一个原子操作。非原子操作都会存在线程安全问题，需要<strong>使用同步技术（sychronized）或者锁（Lock）来让它变成一个原子操作</strong>。一个操作是原子操作，那么我们称它具有原子性。</p>
<h3 id="2-3-数据结构"><a href="#2-3-数据结构" class="headerlink" title="2.3 数据结构"></a>2.3 数据结构</h3><p>&#x2F;&#x2F;TODO</p>
<p>String的数据结构为简单动态字符串(Simple Dynamic String,缩写SDS)。是可以修改的字符串，内部结构实现上类似于Java的ArrayList，采用预分配冗余空间的方式来减少内存的频繁分配.</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329213.png?x-oss-process=style/this0-blog"></p>
<p>如图中所示，内部为当前字符串实际分配的空间，capacity一般要高于实际字符串长度len。当字符串长度小于1M时，扩容都是加倍现有的空间，如果超过1M，扩容时一次只会多扩1M的空间。需要注意的是字符串最大长度为512M。</p>
<h2 id="第三节-Redis-列表-List"><a href="#第三节-Redis-列表-List" class="headerlink" title="第三节 Redis 列表(List)"></a>第三节 Redis 列表(List)</h2><h3 id="3-1-简介"><a href="#3-1-简介" class="headerlink" title="3.1 简介"></a>3.1 简介</h3><p>单键多值, 一个键下的value是一个List.Redis 列表是简单的字符串列表，按照插入顺序排序。你可以添加一个元素到列表的头部（左边）或者尾部（右边）。它的底层实际是个双向链表，对两端的操作性能很高，通过索引下标的操作中间的节点性能会较差。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329214.png?x-oss-process=style/this0-blog"></p>
<h3 id="3-2-常用命令"><a href="#3-2-常用命令" class="headerlink" title="3.2 常用命令"></a>3.2 常用命令</h3><table>
<thead>
<tr>
<th>语法</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>lpush&#x2F;rpush &lt;key&gt;&lt;value1&gt;&lt;value2&gt;&lt;value3&gt; ….</td>
<td>从左边&#x2F;右边插入一个或多个值。</td>
</tr>
<tr>
<td>lpop&#x2F;rpop &lt;key&gt;</td>
<td>从左边&#x2F;右边吐出一个值。值在键在，值光键亡。</td>
</tr>
<tr>
<td>rpoplpush &lt;key1&gt;&lt;key2&gt;</td>
<td>从&lt;key1&gt;列表右边吐出一个值，插到&lt;key2&gt;列表左边</td>
</tr>
<tr>
<td>lrange &lt;key&gt;&lt;start&gt;&lt;stop&gt;</td>
<td>按照索引下标获得元素(从左到右)</td>
</tr>
<tr>
<td></td>
<td>0左边第一个，-1右边第一个，（0-1表示获取所有）</td>
</tr>
<tr>
<td>lindex &lt;key&gt;&lt;index&gt;</td>
<td>按照索引下标获得元素(从左到右)</td>
</tr>
<tr>
<td>llen &lt;key&gt;</td>
<td>获得列表长度</td>
</tr>
<tr>
<td>linsert &lt;key&gt; before &lt;value&gt;&lt;newvalue&gt;</td>
<td>在&lt;value&gt;的前面插入&lt;newvalue&gt;插入值</td>
</tr>
<tr>
<td>linsert &lt;key&gt; after &lt;value&gt;&lt;newvalue&gt;</td>
<td>在&lt;value&gt;的后面插入&lt;newvalue&gt;插入值</td>
</tr>
<tr>
<td>lrem &lt;key&gt;&lt;n&gt;&lt;value&gt;</td>
<td>从左边删除n个value(从左到右)</td>
</tr>
<tr>
<td>lset&lt;key&gt;&lt;index&gt;&lt;value&gt;</td>
<td>将列表key下标为index的值替换成value</td>
</tr>
</tbody></table>
<p>list 一键多值</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; LPUSH list1 <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span></span><br><span class="line">(integer) <span class="number">5</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; RPUSH list2 <span class="number">11</span> <span class="number">22</span> <span class="number">33</span> <span class="number">44</span> <span class="number">55</span></span><br><span class="line">(integer) <span class="number">5</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; LRANGE list1</span><br><span class="line">(error) ERR wrong number of arguments for &#x27;lrange&#x27; command</span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; LRANGE list1 <span class="number">0</span> -<span class="number">1</span></span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;5&quot;</span></span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;4&quot;</span></span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;2&quot;</span></span><br><span class="line"><span class="number">5</span>) <span class="string">&quot;1&quot;</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; LRANGE list2 <span class="number">0</span> -<span class="number">1</span></span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;11&quot;</span></span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;22&quot;</span></span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;33&quot;</span></span><br><span class="line"><span class="number">4</span>) <span class="string">&quot;44&quot;</span></span><br><span class="line"><span class="number">5</span>) <span class="string">&quot;55&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>没有rrange操作</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; LPOP list2</span><br><span class="line"><span class="string">&quot;22&quot;</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; LRANGE list2 <span class="number">0</span> -<span class="number">1</span></span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;33&quot;</span></span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;44&quot;</span></span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;55&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>lpop</p>
<p>最左边的取值并删除，弹出</p>
<p>rpop</p>
<p>最右边的取值并删除，弹出</p>
<p>lindex</p>
<p>llen</p>
<p>lrem ，在key的值里删x个y元素：</p>
<p>lrem key x y</p>
<p>ltrim key 开始index 结束index 截取指定范围的值后再赋值给key</p>
<p>rpoplpush list1 list2左边弹出一个，放到右边：图：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403282341076.png?x-oss-process=style/this0-blog" alt="屏幕截图_20240328_234058"></p>
<p>lest key 下标 元素</p>
<p>linsert key before&#x2F;after</p>
<h3 id="3-3-数据结构"><a href="#3-3-数据结构" class="headerlink" title="3.3 数据结构"></a>3.3 数据结构</h3><p>&#x2F;&#x2F;TODO,五大数据解构都没看</p>
<p>List的数据结构为快速链表quickList。首先在列表元素较少的情况下会使用一块连续的内存存储，这个结构是ziplist，也即是压缩列表。它将所有的元素紧挨着一起存储，分配的是一块连续的内存。当数据量比较多的时候才会改成quicklist。因为普通的链表需要的附加指针空间太大，会比较浪费空间。比如这个列表里存的只是int类型的数据，结构上还需要两个额外的指针prev和next。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329215.png?x-oss-process=style/this0-blog"></p>
<p>Redis将链表和ziplist结合起来组成了quicklist。也就是将多个ziplist使用双向指针串起来使用。这样既满足了快速的插入删除性能，又不会出现太大的空间冗余。</p>
<h2 id="第四节Redis-集合-Set"><a href="#第四节Redis-集合-Set" class="headerlink" title="第四节Redis 集合(Set)"></a>第四节Redis 集合(Set)</h2><p>java里面的hashset</p>
<p>添加</p>
<p>sadd</p>
<p>遍历</p>
<p>smembers key</p>
<p>是否存在，有返回1,没有返回0</p>
<p>sismember set1 1</p>
<p>删除</p>
<p>srem</p>
<p>统计</p>
<p>scard</p>
<p>随机取数</p>
<p>127.0.0.1:6379&gt; SRANDMEMBER set1 3</p>
<p>迁移</p>
<p>smove</p>
<p>集合运算</p>
<p>1 sdiff set1 set2 属于set1 不属于set2的元素</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; SMEMBERS set1</span><br><span class="line"><span class="attribute">1</span>) <span class="string">&quot;1&quot;</span></span><br><span class="line"><span class="attribute">2</span>) <span class="string">&quot;2&quot;</span></span><br><span class="line"><span class="attribute">3</span>) <span class="string">&quot;a&quot;</span></span><br><span class="line"><span class="attribute">4</span>) <span class="string">&quot;b&quot;</span></span><br><span class="line"><span class="attribute">5</span>) <span class="string">&quot;c&quot;</span></span><br><span class="line"><span class="attribute">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; SMEMBERS set2</span><br><span class="line"><span class="attribute">1</span>) <span class="string">&quot;1&quot;</span></span><br><span class="line"><span class="attribute">2</span>) <span class="string">&quot;2&quot;</span></span><br><span class="line"><span class="attribute">3</span>) <span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="attribute">4</span>) <span class="string">&quot;a&quot;</span></span><br><span class="line"><span class="attribute">5</span>) <span class="string">&quot;x&quot;</span></span><br><span class="line"><span class="attribute">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; sdiff set1 set2</span><br><span class="line"><span class="attribute">1</span>) <span class="string">&quot;b&quot;</span></span><br><span class="line"><span class="attribute">2</span>) <span class="string">&quot;c&quot;</span></span><br><span class="line"><span class="attribute">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">6379</span>&gt; </span><br></pre></td></tr></table></figure>

<p>2 合并：SUNION set1 set2 </p>
<ol>
<li><pre><code>127.0.0.1:6379&gt; SUNION set1 set2 
1) &quot;1&quot; 
2) &quot;2&quot; 
3) &quot;a&quot; 
4) &quot;b&quot; 
5) &quot;c&quot; 
6) &quot;3&quot; 
7) &quot;x&quot;
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">3 交集</span><br><span class="line"></span><br><span class="line">sinter <span class="keyword">set</span>1 <span class="keyword">set</span>2</span><br><span class="line"></span><br><span class="line">4 sintercard redis7新出的，返回交集的个数</span><br><span class="line"></span><br></pre></td></tr></table></figure>
127.0.0.1:6379&gt; sintercard 2 set1 set2 
(integer) 3
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 4.1 简介</span></span><br><span class="line"></span><br><span class="line">&amp;<span class="comment">#x20;   Redis set对外提供的功能与list类似是一个列表的功能，特殊之处在于set是可以**自动排重**的，当你需要存储一个列表数据，又不希望出现重复数据时，set是一个很好的选择，并且set提供了判断某个成员是否在一个set集合内的重要接口，这个也是list所不能提供的。</span></span><br><span class="line"></span><br><span class="line">&amp;<span class="comment">#x20;   Redis的Set是string类型的无序集合。它底层其实是一个value为null的hash表，所以添加，删除，查找的**复杂度都是O(1)**。一个算法，随着数据的增加，执行时间的长短，如果是O(1)，数据增加，查找数据的时间不变  &amp;#x20;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 4.2 常用命令</span></span><br><span class="line"></span><br><span class="line">|<span class="string"> 语法                                  </span>|<span class="string"> 功能                                                         </span>|</span><br><span class="line">|<span class="string"> ------------------------------------- </span>|<span class="string"> ------------------------------------------------------------ </span>|</span><br><span class="line">|<span class="string"> sadd \&lt;key&gt;\&lt;value1&gt;\&lt;value2&gt; .....   </span>|<span class="string"> 将一个或多个 member 元素加入到集合 key 中，已经存在的 member 元素将被忽略 </span>|</span><br><span class="line">|<span class="string"> smembers \&lt;key&gt;                       </span>|<span class="string"> 取出该集合的所有值。                                         </span>|</span><br><span class="line">|<span class="string"> sismember \&lt;key&gt;\&lt;value&gt;              </span>|<span class="string"> 判断集合\&lt;key&gt;是否为含有该\&lt;value&gt;值，有1，没有0             </span>|</span><br><span class="line">|<span class="string"> scard\&lt;key&gt;                           </span>|<span class="string"> 返回该集合的元素个数。                                       </span>|</span><br><span class="line">|<span class="string"> srem \&lt;key&gt;\&lt;value1&gt;\&lt;value2&gt; ....    </span>|<span class="string"> 删除集合中的某个元素。                                       </span>|</span><br><span class="line">|<span class="string"> spop \&lt;key&gt;                           </span>|<span class="string"> 随机从该集合中吐出一个值                                     </span>|</span><br><span class="line">|<span class="string"> spop \&lt;key&gt;\&lt;N&gt;                       </span>|<span class="string"> 随机从该集合中吐出N个值。                                    </span>|</span><br><span class="line">|<span class="string"> srandmember \&lt;key&gt;\&lt;n&gt;                </span>|<span class="string"> 随机从该集合中取出n个值。不会从集合中删除 。                 </span>|</span><br><span class="line">|<span class="string"> smove \&lt;source&gt;\&lt;destination&gt;\&lt;value&gt; </span>|<span class="string"> 把集合中一个值从一个集合移动到另一个集合                     </span>|</span><br><span class="line">|<span class="string"> sinter \&lt;key1&gt;\&lt;key2&gt;                 </span>|<span class="string"> 返回两个集合的交集元素。                                     </span>|</span><br><span class="line">|<span class="string"> sunion \&lt;key1&gt;\&lt;key2&gt;                 </span>|<span class="string"> 返回两个集合的并集元素。                                     </span>|</span><br><span class="line">|<span class="string"> sdiff \&lt;key1&gt;\&lt;key2&gt;                  </span>|<span class="string"> 返回两个集合的**差集**元素(key1中的，不包含key2中的)         </span>|</span><br><span class="line"></span><br><span class="line"><span class="comment">### 4.2 数据结构</span></span><br><span class="line"></span><br><span class="line">Set数据结构是dict字典，字典是用哈希表实现的。Java中HashSet的内部实现使用的是HashMap，只不过所有的value都指向同一个对象。Redis的set结构也是一样，它内部也使用hash结构，所有value都指向同一个内部值。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 第五节 Redis 哈希(Hash)</span></span><br><span class="line"></span><br><span class="line">kv模式不变，但V是一个键值对</span><br><span class="line"></span><br></pre></td></tr></table></figure>
127.0.0.1:6379&gt; hset user id 1 name zhangsan age 25
(integer) 3
127.0.0.1:6379&gt; hget user id
&quot;1&quot;
127.0.0.1:6379&gt; hget user name
&quot;zhangsan&quot;
127.0.0.1:6379&gt; hget user age
&quot;25&quot;
</code></pre>
</li>
</ol>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">要hget key key进行取值</span><br><span class="line"></span><br><span class="line">//TODO</span><br><span class="line"></span><br><span class="line">在很早以前，3.0版本，就和hmset没区别？</span><br><span class="line"></span><br><span class="line"><span class="comment">### 5.1 简介</span></span><br><span class="line"></span><br><span class="line">Redis hash 是一个键值对集合。Redis hash是一个string类型的field和value的映射表，hash特别适合用于存储对象。类似Java里面的Map\<span class="variable">&lt;String,Object&gt;</span>用户ID为查找的key，存储的value用户对象包含姓名，年龄，生日等信息</span><br><span class="line"></span><br><span class="line">- 方式1  单key+序列化 .问题:每次修改用户的某个属性需要，先反序列化改好后再序列化回去。开销较大。</span><br><span class="line"></span><br><span class="line">  ![image-20230706110321231](https://blog-resources.this0.com/image/202403281329216.png?x-oss-process=style/this0-blog)</span><br><span class="line"></span><br><span class="line">- 方式2 多key-value .问题:用户ID数据冗余 &amp;<span class="comment">#x20;</span></span><br><span class="line"></span><br><span class="line">  ![image-20230706110341117](https://blog-resources.this0.com/image/202403281329217.png?x-oss-process=style/this0-blog)</span><br><span class="line"></span><br><span class="line">- 方式3 单key + 多(field+value)</span><br><span class="line"></span><br><span class="line">![image-20230706110256007](https://blog-resources.this0.com/image/202403281329218.png?x-oss-process=style/this0-blog)</span><br><span class="line"></span><br><span class="line"><span class="symbol">*</span> <span class="symbol">*</span><span class="symbol">*</span>通过 key(用户ID) + field(属性标签) 就可以操作对应属性数据了，既不需要重复存储数据，也不会带来序列化和并发修改控制的问题<span class="symbol">*</span><span class="symbol">*</span>&amp;<span class="comment">#x20;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 5.2 常用命令</span></span><br><span class="line"></span><br><span class="line">|<span class="string"> 语法                                                 </span>|<span class="string"> 功能                                                         </span>|</span><br><span class="line">|<span class="string"> ---------------------------------------------------- </span>|<span class="string"> ------------------------------------------------------------ </span>|</span><br><span class="line">|<span class="string"> hset \&lt;key&gt;\&lt;field&gt;\&lt;value&gt;                          </span>|<span class="string"> 给\&lt;key&gt;集合中的 \&lt;field&gt;键赋值\&lt;value&gt;                      </span>|</span><br><span class="line">|<span class="string"> hget \&lt;key1&gt;\&lt;field&gt;                                 </span>|<span class="string"> 从\&lt;key1&gt;集合\&lt;field&gt;取出 value                              </span>|</span><br><span class="line">|<span class="string"> hmset \&lt;key1&gt;\&lt;field1&gt;\&lt;value1&gt;\&lt;field2&gt;\&lt;value2&gt;... </span>|<span class="string"> 批量设置hash的值                                             </span>|</span><br><span class="line">|<span class="string"> hexists\&lt;key1&gt;\&lt;field&gt;                               </span>|<span class="string"> 查看哈希表 key 中，给定域 field 是否存在。                   </span>|</span><br><span class="line">|<span class="string"> hkeys \&lt;key&gt;                                         </span>|<span class="string"> 列出该hash集合的所有field                                    </span>|</span><br><span class="line">|<span class="string"> hvals \&lt;key&gt;                                         </span>|<span class="string"> 列出该hash集合的所有value                                    </span>|</span><br><span class="line">|<span class="string"> hincrby \&lt;key&gt;\&lt;field&gt;\&lt;increment&gt;                   </span>|<span class="string"> 为哈希表 key 中的域 field 的值加上增量 1 -1                  </span>|</span><br><span class="line">|<span class="string"> hsetnx \&lt;key&gt;\&lt;field&gt;\&lt;value&gt;                        </span>|<span class="string"> 将哈希表 key 中的域 field 的值设置为 value ，当且仅当域 field 不存在 . </span>|</span><br><span class="line"></span><br><span class="line"><span class="comment">### 5.3 数据结构</span></span><br><span class="line"></span><br><span class="line">Hash类型对应的数据结构是两种：ziplist（压缩列表），hashtable（哈希表）。当field-value长度较短且个数较少时，使用ziplist，否则使用hashtable。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## 第六节 Redis 有序集合Zset</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 6.1 简介</span></span><br><span class="line"></span><br><span class="line">Redis有序集合zset与普通集合set非常相似，是一个没有重复元素的字符串集合。不同之处是有序集合的每个成员都关联了一个评分（score）,这个评分（score）被用来按照从最低分到最高分的方式排序集合中的成员。集合的成员是唯一的，但是评分可以是重复了 。因为元素是有序的, 所以你也可以很快的根据评分（score）或者次序（position）来获取一个范围的元素。访问有序集合的中间元素也是非常快的,因此你能够使用有序集合作为一个没有重复成员的智能列表。</span><br><span class="line"></span><br><span class="line"><span class="comment">### 6.2 常用命令</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">|<span class="string"> 语法                                                         </span>|<span class="string"> 功能                                                         </span>|</span><br><span class="line">|<span class="string"> ------------------------------------------------------------ </span>|<span class="string"> ------------------------------------------------------------ </span>|</span><br><span class="line">|<span class="string"> zadd \&lt;key&gt;\&lt;score1&gt;\&lt;value1&gt;\&lt;score2&gt;\&lt;value2&gt;…             </span>|<span class="string"> 将一个或多个 member 元素及其 score 值加入到有序集 key 当中。 </span>|</span><br><span class="line">|<span class="string"> zrange\&lt;key&gt;\&lt;start&gt;\&lt;stop&gt;  \[WITHSCORES]                   </span>|<span class="string"> 升序返回有序集 key 中，下标在\&lt;start&gt;\&lt;stop&gt;之间的元素,0代表第一个元素索引,-1代表最后一个元素索引.带WITHSCORES，可以让分数一起和值返回到结果集。 </span>|</span><br><span class="line">|<span class="string"> zrevrange \&lt;key&gt;\&lt;start&gt;\&lt;stop&gt; \[WITHSCORES]                </span>|<span class="string"> 降序返回有序集 key 中，下标在\&lt;start&gt;\&lt;stop&gt;之间的元素,0代表第一个元素索引,-1代表最后一个元素索引.带WITHSCORES，可以让分数一起和值返回到结果集 </span>|</span><br><span class="line">|<span class="string"> zrangebyscore \&lt;key&gt; \&lt;min&gt; \&lt;max&gt; \[withscores] \[limit offset count] </span>|<span class="string"> 返回有序集 key 中，所有 score 值介于 min 和 max 之间(包括等于 min 或 max )的成员。有序集成员按 score 值递增(从小到大)次序排列。 </span>|</span><br><span class="line">|<span class="string"> zrevrangebyscore \&lt;key&gt; \&lt;max&gt; \&lt;min&gt; \[withscores] \[limit offset count] </span>|<span class="string"> 同上，改为从大到小排列。                                     </span>|</span><br><span class="line">|<span class="string"> zincrby \&lt;key&gt;\&lt;increment&gt;\&lt;value&gt;                           </span>|<span class="string"> 为元素的score加上增量                                        </span>|</span><br><span class="line">|<span class="string"> zrem \&lt;key&gt;\&lt;value&gt;                                          </span>|<span class="string"> 删除该集合下，指定值的元素                                   </span>|</span><br><span class="line">|<span class="string"> zcount \&lt;key&gt;\&lt;min&gt;\&lt;max&gt;                                    </span>|<span class="string"> 统计该集合，分数区间内的元素个数                             </span>|</span><br><span class="line">|<span class="string"> zrank \&lt;key&gt;\&lt;value&gt;                                         </span>|<span class="string"> 返回该值在集合中的排名，从0开始。                            </span>|</span><br><span class="line"></span><br><span class="line">案例：如何利用zset实现一个文章访问量的排行榜？</span><br><span class="line"></span><br><span class="line">![](https://blog-resources.this0.com/image/202403281329219.png?x-oss-process=style/this0-blog)</span><br><span class="line"></span><br><span class="line">小括号不包含</span><br><span class="line"></span><br><span class="line">ZRANGEbyscore zset1 (70 500  withscores</span><br><span class="line"></span><br><span class="line">zmpop，7.0的 要加count 数量</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>127.0.0.1:6379&gt; ZMPOP 1 myzset max count<br>(error) ERR syntax error<br>127.0.0.1:6379&gt; ZMPOP 1 myzset max count<br>(error) ERR syntax error<br>127.0.0.1:6379&gt; ZMPOP 1 myzset max count 1</p>
<ol>
<li>“myzset”</li>
<li><ol>
<li><ol>
<li>“three”</li>
<li>“3”<br>127.0.0.1:6379&gt; ZMPOP 1 myzset max count 1</li>
</ol>
</li>
</ol>
</li>
<li>“myzset”</li>
<li><ol>
<li><ol>
<li>“two”</li>
<li>“2”<br>127.0.0.1:6379&gt; ZMPOP 1 myzset max count 1</li>
</ol>
</li>
</ol>
</li>
<li>“myzset”</li>
<li><ol>
<li><ol>
<li>“one”</li>
<li>“1”<br>127.0.0.1:6379&gt; ZMPOP 1 myzset max count 1<br>(nil)<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//TODO,我理解zmpop 后面的可选参数count 是执行几次，</span></span><br><span class="line"></span><br><span class="line">逆序</span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ZrevRANGE myzset <span class="number">0</span> <span class="number">-1</span>  </span><br><span class="line"></span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;three&quot;</span> </span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;two&quot;</span> </span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;one&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">6379</span>&gt; ZRANGE myzset <span class="number">0</span> <span class="number">-1</span>  </span><br><span class="line"></span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;one&quot;</span> </span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;two&quot;</span> </span><br><span class="line"><span class="number">3</span>) <span class="string">&quot;three&quot;</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">### <span class="number">6.3</span> 数据结构</span><br><span class="line"></span><br><span class="line">SortedSet(zset)是Redis提供的一个非常特别的数据结构，一方面它等价于Java的数据结构Map\&lt;String, Double&gt;，可以给每一个元素value赋予一个权重score，另一方面它又类似于TreeSet，内部的元素会按照权重score进行排序，可以得到每个元素的名次，还可以通过score的范围来获取元素的列表。</span><br><span class="line"></span><br><span class="line"><span class="comment">//TODO,单线程和多路复用</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//TODO,后五种没看</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># <span class="comment">//TODO第四章 Jedis客户端程序</span></span><br><span class="line"></span><br><span class="line">## 学习目标</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> 了解Jedis</span><br><span class="line"></span><br><span class="line"><span class="number">2</span> 能够独立搭建Jedis的环境</span><br><span class="line"></span><br><span class="line"><span class="number">3</span> 熟练操作key操作相关API</span><br><span class="line"></span><br><span class="line"><span class="number">4</span> 熟练操作String操作相关API</span><br><span class="line"></span><br><span class="line"><span class="number">5</span> 熟练操作List操作相关API</span><br><span class="line"></span><br><span class="line"><span class="number">6</span> 熟练操作Set操作相关API</span><br><span class="line"></span><br><span class="line"><span class="number">7</span> 熟练操作Hash操作相关API</span><br><span class="line"></span><br><span class="line"><span class="number">8</span> 熟练操作Zset操作相关API</span><br><span class="line"></span><br><span class="line">## 第一节 Jedis简介</span><br><span class="line"></span><br><span class="line">```纯文本</span><br><span class="line"> Redis不仅是使用命令来操作，现在基本上主流的语言都有客户端支持，比如java、C、C#、C++、php、Node.js、Go等。在官方网站里列一些Java的客户端，有Jedis、Redisson、Jredis、JDBC-Redis、等其中官方推荐使用Jedis和Redisson。 在企业中用的最多的就是Jedis。Jedis提供了完整Redis命令，而Redisson有更多分布式的容器实现。</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 id="第二节-环境准备"><a href="#第二节-环境准备" class="headerlink" title="第二节 环境准备"></a>第二节 环境准备</h2><blockquote>
<p>1 创建maven普通项目,导入如下依赖</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.junit.jupiter/junit-jupiter-api --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.jupiter<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-jupiter-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>2 虚拟机和Redis设置</p>
</blockquote>
<ul>
<li>禁用Linux的防火墙：Linux(CentOS7)里执行命令</li>
<li>systemctl stop&#x2F;disable firewalld.service</li>
<li>redis.conf中注释掉bind 127.0.0.1 ,然后 protected-mode 的值设置为no</li>
</ul>
<blockquote>
<p>3 测试JAVA程序和Redis之间的通信</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu.jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Demo01</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">TestPing</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Jedis</span> <span class="variable">jedis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Jedis</span>(<span class="string">&quot;192.168.6.101&quot;</span>,<span class="number">6379</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">pong</span> <span class="operator">=</span> jedis.ping();</span><br><span class="line">        System.out.println(<span class="string">&quot;连接成功：&quot;</span>+pong);</span><br><span class="line">        jedis.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="第三节-key相关API"><a href="#第三节-key相关API" class="headerlink" title="第三节 key相关API"></a>第三节 key相关API</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testKeyAPI</span><span class="params">()</span>&#123;</span><br><span class="line">    jedis.set(<span class="string">&quot;k1&quot;</span>, <span class="string">&quot;v1&quot;</span>);</span><br><span class="line">    <span class="comment">// 添加 键值对并设置过期时间</span></span><br><span class="line">    jedis.setex(<span class="string">&quot;k2&quot;</span>,<span class="number">100</span>, <span class="string">&quot;v2&quot;</span>);</span><br><span class="line">    jedis.set(<span class="string">&quot;k3&quot;</span>, <span class="string">&quot;v3&quot;</span>);</span><br><span class="line">    <span class="comment">// 获取所有的键</span></span><br><span class="line">    Set&lt;String&gt; keys = jedis.keys(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">    System.out.println(keys.size());</span><br><span class="line">    <span class="keyword">for</span> (String key : keys) &#123;</span><br><span class="line">        System.out.println(key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 判断某个键是否存在</span></span><br><span class="line">    System.out.println(jedis.exists(<span class="string">&quot;k1&quot;</span>));</span><br><span class="line">    <span class="comment">// 查看键剩余过期时间</span></span><br><span class="line">    System.out.println(jedis.ttl(<span class="string">&quot;k2&quot;</span>));</span><br><span class="line">    <span class="comment">// 根据键获取值</span></span><br><span class="line">    System.out.println(jedis.get(<span class="string">&quot;k1&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="第四节-String相关API"><a href="#第四节-String相关API" class="headerlink" title="第四节 String相关API"></a>第四节 String相关API</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加String</span></span><br><span class="line">System.out.println(jedis.set(<span class="string">&quot;k1&quot;</span>, <span class="string">&quot;v1&quot;</span>));</span><br><span class="line"><span class="comment">// 一次添加多个</span></span><br><span class="line">System.out.println(jedis.mset(<span class="string">&quot;ka&quot;</span>,<span class="string">&quot;aaa&quot;</span>,<span class="string">&quot;kb&quot;</span>,<span class="string">&quot;bbb&quot;</span>));</span><br><span class="line"><span class="comment">//  获取</span></span><br><span class="line">System.out.println(jedis.get(<span class="string">&quot;k1&quot;</span>));</span><br><span class="line"><span class="comment">// 一次获取多个</span></span><br><span class="line">System.out.println(jedis.mget(<span class="string">&quot;k1&quot;</span>,<span class="string">&quot;ka&quot;</span>,<span class="string">&quot;kb&quot;</span>));</span><br><span class="line"><span class="comment">// 追加</span></span><br><span class="line">System.out.println(jedis.append(<span class="string">&quot;k1&quot;</span>, <span class="string">&quot;vvvvv&quot;</span>));</span><br><span class="line"><span class="comment">// 获取长度</span></span><br><span class="line">System.out.println(jedis.strlen(<span class="string">&quot;k1&quot;</span>));</span><br><span class="line"><span class="comment">// 不存在时进行设置</span></span><br><span class="line">System.out.println(jedis.setnx(<span class="string">&quot;k1&quot;</span>,<span class="string">&quot;xxxxx&quot;</span>));</span><br><span class="line">System.out.println(jedis.setnx(<span class="string">&quot;k2&quot;</span>,<span class="string">&quot;10&quot;</span>));</span><br><span class="line"><span class="comment">// 增长/减少</span></span><br><span class="line">System.out.println(jedis.incr(<span class="string">&quot;k2&quot;</span>));</span><br><span class="line">System.out.println(jedis.decr(<span class="string">&quot;k2&quot;</span>));</span><br><span class="line">System.out.println(jedis.incrBy(<span class="string">&quot;k2&quot;</span>, <span class="number">10</span>));</span><br><span class="line">System.out.println(jedis.decrBy(<span class="string">&quot;k2&quot;</span>, <span class="number">10</span>));</span><br></pre></td></tr></table></figure>

<h2 id="第五节-List相关API"><a href="#第五节-List相关API" class="headerlink" title="第五节 List相关API"></a>第五节 List相关API</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testList</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">// 放入List</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">lpush</span> <span class="operator">=</span> jedis.lpush(<span class="string">&quot;klist&quot;</span>, <span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="string">&quot;d&quot;</span>);</span><br><span class="line">    System.out.println(lpush);</span><br><span class="line">    <span class="comment">// 获取List</span></span><br><span class="line">    List&lt;String&gt; kList = jedis.lrange(<span class="string">&quot;klist&quot;</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">    kList.forEach(System.out::println);</span><br><span class="line">    <span class="comment">// 取值</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">klist</span> <span class="operator">=</span> jedis.lpop(<span class="string">&quot;klist&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="第六节-Set相关API"><a href="#第六节-Set相关API" class="headerlink" title="第六节 Set相关API"></a>第六节 Set相关API</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSet</span><span class="params">()</span>&#123;</span><br><span class="line">     <span class="comment">// 添加一个set集合</span></span><br><span class="line">     jedis.sadd(<span class="string">&quot;skey&quot;</span>,<span class="string">&quot;a&quot;</span>,<span class="string">&quot;b&quot;</span>,<span class="string">&quot;c&quot;</span>,<span class="string">&quot;d&quot;</span>,<span class="string">&quot;e&quot;</span>);</span><br><span class="line">     <span class="comment">// 获取制定的set集合</span></span><br><span class="line">     Set&lt;String&gt; skey = jedis.smembers(<span class="string">&quot;skey&quot;</span>);</span><br><span class="line">     skey.forEach(System.out::println);</span><br><span class="line">     <span class="comment">//判断是否包含</span></span><br><span class="line">     System.out.println(jedis.sismember(<span class="string">&quot;skey&quot;</span>,<span class="string">&quot;a&quot;</span>));</span><br><span class="line">     <span class="comment">//删除元素</span></span><br><span class="line">     jedis.srem(<span class="string">&quot;skey&quot;</span>,<span class="string">&quot;a&quot;</span>,<span class="string">&quot;b&quot;</span>);</span><br><span class="line">     <span class="comment">//弹出一个元素</span></span><br><span class="line">     System.out.println(jedis.spop(<span class="string">&quot;skey&quot;</span>));</span><br><span class="line">     <span class="comment">//弹出N个元素</span></span><br><span class="line">     System.out.println(jedis.spop(<span class="string">&quot;skey&quot;</span>,<span class="number">2</span>));</span><br><span class="line">     <span class="comment">//从一个set向另一个set移动元素</span></span><br><span class="line">     jedis.smove(<span class="string">&quot;skey&quot;</span>,<span class="string">&quot;bkey&quot;</span>,<span class="string">&quot;X&quot;</span>);</span><br><span class="line">     <span class="comment">// ……</span></span><br><span class="line"></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h2 id="第七节-Hash相关API"><a href="#第七节-Hash相关API" class="headerlink" title="第七节 Hash相关API"></a>第七节 Hash相关API</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 添加值</span></span><br><span class="line">jedis.hset(<span class="string">&quot;player1&quot;</span>,<span class="string">&quot;pname&quot;</span>,<span class="string">&quot;宇智波赵四儿&quot;</span>);</span><br><span class="line">jedis.hset(<span class="string">&quot;player1&quot;</span>,<span class="string">&quot;page&quot;</span>,<span class="string">&quot;14&quot;</span>);</span><br><span class="line">jedis.hset(<span class="string">&quot;player1&quot;</span>,<span class="string">&quot;gender&quot;</span>,<span class="string">&quot;boy&quot;</span>);</span><br><span class="line"><span class="comment">// 获取值</span></span><br><span class="line">System.out.println(jedis.hget(<span class="string">&quot;player1&quot;</span>,<span class="string">&quot;pname&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//  批量添加值</span></span><br><span class="line">Map&lt;String,String&gt; player2=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String,String&gt;();</span><br><span class="line">player2.put(<span class="string">&quot;pname&quot;</span>,<span class="string">&quot;旋涡刘能&quot;</span>);</span><br><span class="line">player2.put(<span class="string">&quot;page&quot;</span>,<span class="string">&quot;13&quot;</span>);</span><br><span class="line">player2.put(<span class="string">&quot;gender&quot;</span>,<span class="string">&quot;boy&quot;</span>);</span><br><span class="line">jedis.hmset(<span class="string">&quot;player2&quot;</span>,player2);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查看filed是否存在</span></span><br><span class="line">System.out.println(jedis.hexists(<span class="string">&quot;player1&quot;</span>, <span class="string">&quot;pname&quot;</span>));</span><br><span class="line"><span class="comment">// 查看集合中所有的field</span></span><br><span class="line">Set&lt;String&gt; player1fields = jedis.hkeys(<span class="string">&quot;player1&quot;</span>);</span><br><span class="line">player1fields.forEach(System.out::println);</span><br><span class="line"><span class="comment">// 查看集合中所有的value</span></span><br><span class="line">List&lt;String&gt; player1vals = jedis.hvals(<span class="string">&quot;player1&quot;</span>);</span><br><span class="line">player1vals.forEach(System.out::println);</span><br><span class="line"><span class="comment">// 给制定属性+1</span></span><br><span class="line">jedis.hincrBy(<span class="string">&quot;player1&quot;</span>,<span class="string">&quot;page&quot;</span>,<span class="number">5</span>);</span><br><span class="line"><span class="comment">// 如不存在,添加某个属性</span></span><br><span class="line">jedis.hsetnx(<span class="string">&quot;player1&quot;</span>,<span class="string">&quot;height&quot;</span>,<span class="string">&quot;156&quot;</span>);</span><br><span class="line">System.out.println(jedis.hget(<span class="string">&quot;player1&quot;</span>,<span class="string">&quot;page&quot;</span>));</span><br><span class="line">System.out.println(jedis.hget(<span class="string">&quot;player1&quot;</span>,<span class="string">&quot;height&quot;</span>));</span><br></pre></td></tr></table></figure>

<h2 id="第八节-ZSet相关API"><a href="#第八节-ZSet相关API" class="headerlink" title="第八节 ZSet相关API"></a>第八节 ZSet相关API</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 准备数据</span></span><br><span class="line">Map&lt;String ,Double&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">map.put(<span class="string">&quot;李四&quot;</span>,<span class="number">11d</span>);</span><br><span class="line">map.put(<span class="string">&quot;王五&quot;</span>,<span class="number">8d</span>);</span><br><span class="line">map.put(<span class="string">&quot;赵六&quot;</span>,<span class="number">20d</span>);</span><br><span class="line">map.put(<span class="string">&quot;刘七&quot;</span>,<span class="number">3d</span>);</span><br><span class="line"><span class="comment">//  添加元素</span></span><br><span class="line">jedis.zadd(<span class="string">&quot;zkey&quot;</span>,<span class="number">10</span>,<span class="string">&quot;张三&quot;</span>);</span><br><span class="line">jedis.zadd(<span class="string">&quot;zkey&quot;</span>,map);</span><br><span class="line"> <span class="comment">// 升序返回有序</span></span><br><span class="line"> Set&lt;String&gt; zkeys = jedis.zrange(<span class="string">&quot;zkey&quot;</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line"> zkeys.forEach(System.out::println);</span><br><span class="line"> <span class="comment">//  降序返回元素</span></span><br><span class="line"> Set&lt;String&gt; zkeys2 = jedis.zrevrange(<span class="string">&quot;zkey&quot;</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line"> zkeys2.forEach(System.out::println);</span><br><span class="line"></span><br><span class="line"> System.out.println(<span class="string">&quot;===========&quot;</span>);</span><br><span class="line"> Set&lt;String&gt; zkeys3 = jedis.zrangeByScore(<span class="string">&quot;zkey&quot;</span>, <span class="number">10</span>, <span class="number">20</span>);</span><br><span class="line"> zkeys3.forEach(System.out::println);</span><br><span class="line"> System.out.println(<span class="string">&quot;===========&quot;</span>);</span><br><span class="line"> Set&lt;String&gt; zkeys4 = jedis.zrevrangeByScore(<span class="string">&quot;zkey&quot;</span>, <span class="number">20</span>, <span class="number">10</span>);</span><br><span class="line"> zkeys4.forEach(System.out::println);</span><br><span class="line"> <span class="comment">// 增加分数</span></span><br><span class="line"> jedis.zincrby(<span class="string">&quot;zkey&quot;</span>,<span class="number">5</span>,<span class="string">&quot;张三&quot;</span>);</span><br><span class="line"> jedis.zincrby(<span class="string">&quot;zkey&quot;</span>,-<span class="number">5</span>,<span class="string">&quot;赵六&quot;</span>);</span><br><span class="line"> <span class="comment">//  删除 元素</span></span><br><span class="line"> jedis.zrem(<span class="string">&quot;zkey&quot;</span>,<span class="string">&quot;张三&quot;</span>);</span><br><span class="line"> System.out.println(jedis.zcount(<span class="string">&quot;zkey&quot;</span>,<span class="number">10</span>,<span class="number">20</span>));</span><br><span class="line"> System.out.println(jedis.zrank(<span class="string">&quot;zkey&quot;</span>,<span class="string">&quot;李四&quot;</span>));</span><br></pre></td></tr></table></figure>



<h1 id="TODO第五章-SpringBoot整合Redis"><a href="#TODO第五章-SpringBoot整合Redis" class="headerlink" title="&#x2F;&#x2F;TODO第五章 SpringBoot整合Redis"></a>&#x2F;&#x2F;TODO第五章 SpringBoot整合Redis</h1><h2 id="5-1-创建工程"><a href="#5-1-创建工程" class="headerlink" title="5.1 创建工程"></a>5.1 创建工程</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329220.png?x-oss-process=style/this0-blog" alt="image-20230627195300172"></p>
<h2 id="5-2-添加依赖"><a href="#5-2-添加依赖" class="headerlink" title="5.2 添加依赖"></a>5.2 添加依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="5-3-创建配置文件"><a href="#5-3-创建配置文件" class="headerlink" title="5.3 创建配置文件"></a>5.3 创建配置文件</h2><p>application.properties</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.data.redis.host</span>=<span class="string">192.168.6.131</span></span><br><span class="line"><span class="attr">spring.data.redis.port</span>=<span class="string">6379</span></span><br><span class="line"><span class="comment">#spring.data.redis.client-type=lettuce</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#设置lettuce的底层参数</span></span><br><span class="line"><span class="comment">#spring.data.redis.lettuce.pool.enabled=true</span></span><br><span class="line"><span class="comment">#spring.data.redis.lettuce.pool.max-active=8</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#切换jedis</span></span><br><span class="line"><span class="attr">spring.data.redis.client-type</span>=<span class="string">jedis</span></span><br><span class="line"><span class="attr">spring.data.redis.jedis.pool.enabled</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">spring.data.redis.jedis.pool.max-active</span>=<span class="string">8</span></span><br></pre></td></tr></table></figure>



<p>RedisTemplate、StringRedisTemplate： 操作redis的工具类</p>
<ul>
<li><p>要从redis的连接工厂获取链接才能操作redis</p>
</li>
<li><p><strong>Redis客户端</strong></p>
</li>
<li><ul>
<li>Lettuce： 默认</li>
<li>Jedis：可以使用以下切换</li>
</ul>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--        切换 jedis 作为操作redis的底层客户端--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="5-4-创建启动类"><a href="#5-4-创建启动类" class="headerlink" title="5.4 创建启动类"></a>5.4 创建启动类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Application</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(Application.class,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="5-5-序列化定制"><a href="#5-5-序列化定制" class="headerlink" title="5.5 序列化定制"></a>5.5 序列化定制</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppRedisConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 允许Object类型的key-value，都可以被转为json进行存储。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> redisConnectionFactory 自动配置好了连接工厂</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;Object, Object&gt; <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory redisConnectionFactory)</span> &#123;</span><br><span class="line">        RedisTemplate&lt;Object, Object&gt; template = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line">        template.setConnectionFactory(redisConnectionFactory);</span><br><span class="line">        <span class="comment">//把对象转为json字符串的序列化工具</span></span><br><span class="line">        template.setDefaultSerializer(<span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>());</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="5-6-编写测试方法"><a href="#5-6-编写测试方法" class="headerlink" title="5.6 编写测试方法"></a>5.6 编写测试方法</h2><p>创建测试类，编写测试方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">redisTest</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">//测试String</span></span><br><span class="line">    redisTemplate.opsForValue().set(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;1234&quot;</span>);</span><br><span class="line">    System.out.println(redisTemplate.opsForValue().get(<span class="string">&quot;a&quot;</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//测试list集合</span></span><br><span class="line">    <span class="type">List</span> <span class="variable">list</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    list.add(<span class="string">&quot;lucy&quot;</span>);</span><br><span class="line">    list.add(<span class="string">&quot;mary&quot;</span>);</span><br><span class="line">    redisTemplate.opsForValue().set(<span class="string">&quot;abc&quot;</span>,list);</span><br><span class="line">    System.out.println(redisTemplate.opsForValue().get(<span class="string">&quot;abc&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="TODO第六章-Redis配置文件解读"><a href="#TODO第六章-Redis配置文件解读" class="headerlink" title="&#x2F;&#x2F;TODO第六章 Redis配置文件解读"></a>&#x2F;&#x2F;TODO第六章 Redis配置文件解读</h1><h2 id="学习目标-3"><a href="#学习目标-3" class="headerlink" title="学习目标"></a>学习目标</h2><p>1 了解网络相关的配置</p>
<p>2 了解GENERAL通用配置</p>
<p>3 了解SECURITY安全配置</p>
<p>4 了解LIMIT限制</p>
<h2 id="第一节-网络配置相关-x20"><a href="#第一节-网络配置相关-x20" class="headerlink" title="第一节 网络配置相关&#x20;"></a>第一节 网络配置相关&#x20;</h2><h3 id="（1）-bind绑定连接IP"><a href="#（1）-bind绑定连接IP" class="headerlink" title="（1） bind绑定连接IP"></a>（1） bind绑定连接IP</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">默认情况bind=127.0.0.1只能接受本机的访问请求,不写的情况下，无限制接受任何ip地址的访问,生产环境肯定要写你应用服务器的地址；服务器是需要远程访问的，所以需要将其注释掉.如果开启了protected-mode，那么在没有设定bind ip且没有设密码的情况下，Redis只允许接受本机的响应</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329221.png?x-oss-process=style/this0-blog" alt="image-20230706115102403"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">保存配置，停止服务，重启启动查看进程，不再限制是本机访问了。</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329224.png?x-oss-process=style/this0-blog" alt="image-20230706115212609"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">这里完成之后,就可以在window上安装一个redis客户端,连接虚拟机上的redis服务了</span><br></pre></td></tr></table></figure>



<h3 id="（2）-端口号：-6379"><a href="#（2）-端口号：-6379" class="headerlink" title="（2） 端口号： 6379"></a>（2） 端口号： 6379</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329225.png?x-oss-process=style/this0-blog" alt="image-20230706115349569"></p>
<h3 id="（3）tcp-backlog-连接队列"><a href="#（3）tcp-backlog-连接队列" class="headerlink" title="（3）tcp-backlog 连接队列"></a>（3）tcp-backlog 连接队列</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  设置tcp的backlog，backlog其实是一个连接队列，backlog队列总和=未完成三次握手队列 + 已经完成三次握手队列。在高并发环境下你需要一个高backlog值来避免慢客户端连接问题。</span><br><span class="line"></span><br><span class="line">​  注意Linux内核会将这个值减小到/proc/sys/net/core/somaxconn的值（128），所以需要确认增大/proc/sys/net/core/somaxconn和/proc/sys/net/ipv4/tcp_max_syn_backlog（128）两个值来达到想要的效果</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329227.png?x-oss-process=style/this0-blog" alt="image-20230706115554212"></p>
<h3 id="（4）timeout连接超时"><a href="#（4）timeout连接超时" class="headerlink" title="（4）timeout连接超时"></a>（4）timeout连接超时</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">一个空闲的客户端维持多少秒会关闭，0表示关闭该功能。即永不关闭。</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329228.png?x-oss-process=style/this0-blog" alt="image-20230706115650664"></p>
<h3 id="（5）tcp-keepalive-连接心跳检测"><a href="#（5）tcp-keepalive-连接心跳检测" class="headerlink" title="（5）tcp-keepalive  连接心跳检测"></a>（5）tcp-keepalive  连接心跳检测</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">对访问客户端的一种心跳检测，每个n秒检测一次。</span><br><span class="line">单位为秒，如果设置为0 则不会进行Keepalive检测，建议设置成60  </span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329229.png?x-oss-process=style/this0-blog" alt="image-20230706115754570"></p>
<h2 id="第二节-GENREAL通用配置"><a href="#第二节-GENREAL通用配置" class="headerlink" title="第二节 GENREAL通用配置"></a>第二节 GENREAL通用配置</h2><h3 id="（1）UNITS单位"><a href="#（1）UNITS单位" class="headerlink" title="（1）UNITS单位"></a>（1）UNITS单位</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">配置大小单位,开头定义了一些基本的度量单位，只支持bytes，不支持bit,大小写不敏感</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329230.png?x-oss-process=style/this0-blog" alt="image-20230706120047530"></p>
<h3 id="（2）INCLUDES包含"><a href="#（2）INCLUDES包含" class="headerlink" title="（2）INCLUDES包含"></a>（2）INCLUDES包含</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在当前配置文件中引入其他配置文件中的内容,一般都是引入一些公共配置</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329231.png?x-oss-process=style/this0-blog" alt="image-20230706120131180"></p>
<h3 id="（3）daemonize-后台进程"><a href="#（3）daemonize-后台进程" class="headerlink" title="（3）daemonize 后台进程"></a>（3）daemonize 后台进程</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">是否为后台进程，设置为yes ,守护进程，后台启动</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329232.png?x-oss-process=style/this0-blog" alt="image-20230706120319825"></p>
<h3 id="（4）pidfile-进程ID文件"><a href="#（4）pidfile-进程ID文件" class="headerlink" title="（4）pidfile 进程ID文件"></a>（4）pidfile 进程ID文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">存放pid文件的位置，每个实例会产生一个不同的pid文件</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329233.png?x-oss-process=style/this0-blog" alt="image-20230706120451425"></p>
<h3 id="（5）databases-16-x20"><a href="#（5）databases-16-x20" class="headerlink" title="（5）databases 16&#x20;"></a>（5）databases 16&#x20;</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">设定库的数量 默认16，默认数据库为0，可以使用SELECT &lt;dbid&gt;命令在连接上指定数据库id</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329234.png?x-oss-process=style/this0-blog" alt="image-20230706120627340"></p>
<h2 id="第三节-SECURITY安全配置"><a href="#第三节-SECURITY安全配置" class="headerlink" title="第三节 SECURITY安全配置"></a>第三节 SECURITY安全配置</h2><blockquote>
<p>1 设置密码</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329235.png?x-oss-process=style/this0-blog" alt="image-20230706120811624"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">访问密码的查看、设置和取消</span><br><span class="line">在命令中设置密码，只是临时的。重启redis服务器，密码就还原了。</span><br><span class="line">永久设置，需要再配置文件中进行设置。</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329236.png?x-oss-process=style/this0-blog" alt="image-20230706121200103"></p>
<p><strong>重新连接客户端测试</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329237.png?x-oss-process=style/this0-blog" alt="image-20230706121253744"></p>
<h2 id="第四节-LIMIT限制"><a href="#第四节-LIMIT限制" class="headerlink" title="第四节 LIMIT限制"></a>第四节 LIMIT限制</h2><h3 id="（1）maxclients-客户端最大连接数"><a href="#（1）maxclients-客户端最大连接数" class="headerlink" title="（1）maxclients 客户端最大连接数"></a>（1）maxclients 客户端最大连接数</h3><ul>
<li>设置redis同时可以与多少个客户端进行连接。</li>
<li>默认情况下为10000个客户端。</li>
<li>如果达到了此限制，redis则会拒绝新的连接请求，并且向这些连接请求方发出“max number of clients reached”以作回应。</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329238.png?x-oss-process=style/this0-blog" alt="image-20230706121546036"></p>
<h3 id="（2）maxmemory-最大占用内存"><a href="#（2）maxmemory-最大占用内存" class="headerlink" title="（2）maxmemory 最大占用内存"></a>（2）maxmemory 最大占用内存</h3><ul>
<li>建议<strong>必须设置</strong>，否则，将内存占满，造成服务器宕机</li>
<li>设置redis可以使用的内存量。一旦到达内存使用上限，redis将会试图移除内部数据，移除规则可以通过maxmemory-policy来指定。</li>
<li>如果redis无法根据移除规则来移除内存中的数据，或者设置了“不允许移除”，那么redis则会针对那些需要申请内存的指令返回错误信息，比如SET、LPUSH等。</li>
<li>但是对于无内存申请的指令，仍然会正常响应，比如GET等。如果你的redis是主redis（说明你的redis有从redis），那么在设置内存使用上限时，需要在系统中留出一些内存空间给同步队列缓存，只有在你设置的是“不移除”的情况下，才不用考虑这个因素。</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329239.png?x-oss-process=style/this0-blog" alt="image-20230706121729584"></p>
<h3 id="（3）maxmemory-policy-置换策略"><a href="#（3）maxmemory-policy-置换策略" class="headerlink" title="（3）maxmemory-policy  置换策略"></a>（3）maxmemory-policy  置换策略</h3><ul>
<li>volatile-lru：使用LRU算法移除key，只对设置了过期时间的键；（最近最少使用）</li>
<li>allkeys-lru：在所有集合key中，使用LRU算法移除key</li>
<li>volatile-random：在过期集合中移除随机的key，只对设置了过期时间的键</li>
<li>allkeys-random：在所有集合key中，移除随机的key</li>
<li>volatile-ttl：移除那些TTL值最小的key，即那些最近要过期的key</li>
<li>noeviction：不进行移除。针对写操作，只是返回错误信息</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329240.png?x-oss-process=style/this0-blog" alt="image-20230706121843454"></p>
<h3 id="（4）maxmemory-samples"><a href="#（4）maxmemory-samples" class="headerlink" title="（4）maxmemory-samples"></a>（4）maxmemory-samples</h3><ul>
<li>设置样本数量，LRU算法和最小TTL算法都并非是精确的算法，而是估算值，所以你可以设置样本的大小，redis默认会检查这么多个key并选择其中LRU的那个。</li>
<li>一般设置3到7的数字，数值越小样本越不准确，但性能消耗越小。</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329241.png?x-oss-process=style/this0-blog" alt="image-20230706122145032"></p>
<ul>
<li>设置为 10，那么 Redis 将会增加额外的 CPU 开销以保证接近真正的 LRU 性能</li>
</ul>
<h1 id="TODO第七章-Redis事务锁机制及案例"><a href="#TODO第七章-Redis事务锁机制及案例" class="headerlink" title="&#x2F;&#x2F;TODO第七章 Redis事务锁机制及案例"></a>&#x2F;&#x2F;TODO第七章 Redis事务锁机制及案例</h1><h2 id="学习目标-4"><a href="#学习目标-4" class="headerlink" title="学习目标"></a>学习目标</h2><p>1 熟悉Redis事务的定义和特点</p>
<p>2 熟练Redis事务控制的相关命令</p>
<p>3 熟练使用Redis的锁对数据进行监视</p>
<p>4 熟练编写Redis调用LUA脚本代码</p>
<h2 id="第一节-Redis事务和锁机制"><a href="#第一节-Redis事务和锁机制" class="headerlink" title="第一节 Redis事务和锁机制"></a>第一节 Redis事务和锁机制</h2><h3 id="1-1-Redis事务的定义"><a href="#1-1-Redis事务的定义" class="headerlink" title="1.1 Redis事务的定义"></a>1.1 Redis事务的定义</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Redis事务是一个单独的隔离操作：事务中的所有命令都会序列化、按顺序地执行。事务在执行的过程中，不会被其他客户端发送来的命令请求所打断。Redis事务的主要作用就是串联多个命令防止别的命令插队。</span><br></pre></td></tr></table></figure>



<h3 id="1-2-Redis事务控制命令"><a href="#1-2-Redis事务控制命令" class="headerlink" title="1.2 Redis事务控制命令"></a>1.2 Redis事务控制命令</h3><table>
<thead>
<tr>
<th>命令</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>multi</td>
<td>开始组队</td>
</tr>
<tr>
<td>exec</td>
<td>执行队列中的命令</td>
</tr>
<tr>
<td>discard</td>
<td>取消组队</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">从输入Multi命令开始，输入的命令都会依次进入命令队列中，但不会执行，直到输入Exec后，Redis会将之前的命令队列中的命令依次执行。组队的过程中可以通过discard取消组队</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329242.png?x-oss-process=style/this0-blog"></p>
<blockquote>
<p>情况1 ,组队成功,提交成功</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329243.png?x-oss-process=style/this0-blog" alt="image-20230706135508396"></p>
<h3 id="1-3-Redis事务错误处理"><a href="#1-3-Redis事务错误处理" class="headerlink" title="1.3 Redis事务错误处理"></a>1.3 Redis事务错误处理</h3><blockquote>
<p>情况2,组队报错,提交失败：提交失败组队中某个命令出现了报告错误，执行时整个的所有队列都会被取消</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329244.png?x-oss-process=style/this0-blog"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329245.png?x-oss-process=style/this0-blog" alt="image-20230706135937567"></p>
<blockquote>
<p>情况3, 组队成功,提交时有成功有失败。如果执行阶段某个命令报出了错误，则只有报错的命令不会被执行，其他的命令都会执行，不会回滚。</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329246.png?x-oss-process=style/this0-blog"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329247.png?x-oss-process=style/this0-blog" alt="image-20230706140338715"></p>
<h3 id="1-4-Redis事务场景案例"><a href="#1-4-Redis事务场景案例" class="headerlink" title="1.4 Redis事务场景案例"></a>1.4 Redis事务场景案例</h3><blockquote>
<p>场景说明</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">想想一个场景：有很多人有你的账户,同时去参加双十一抢购  </span><br><span class="line">一个请求想给金额减8000</span><br><span class="line">一个请求想给金额减5000</span><br><span class="line">一个请求想给金额减1000</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329248.png?x-oss-process=style/this0-blog"></p>
<blockquote>
<p><strong>悲观锁</strong></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">悲观锁(Pessimistic Lock), 顾名思义，就是很悲观，每次去拿数据的时候都认为别人会修改，所以每次在拿数据的时候都会上锁，这样别人想拿这个数据就会block直到它拿到锁。传统的关系型数据库里边就用到了很多这种锁机制，比如行锁，表锁等，读锁，写锁等，都是在做操作之前先上锁。</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329249.png?x-oss-process=style/this0-blog"></p>
<blockquote>
<p><strong>乐观锁</strong></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">乐观锁(Optimistic Lock), 顾名思义，就是很乐观，每次去拿数据的时候都认为别人不会修改，所以不会上锁，但是在更新的时候会判断一下在此期间别人有没有去更新这个数据，可以使用版本号等机制。乐观锁适用于多读的应用类型，这样可以提高吞吐量。Redis就是利用这种check-and-set机制实现事务的。</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329250.png?x-oss-process=style/this0-blog"></p>
<blockquote>
<p><strong>监视和取消监视key</strong></p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在执行multi之前，先执行watch key1 [key2],可以监视一个(或多个) key ，如果在事务**执行之前这个(或这些) key 被其他命令所改动，那么事务将被打断。**</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329252.png?x-oss-process=style/this0-blog" alt="image-20230706141601678"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">取消 WATCH 命令对所有 key 的监视。如果在执行 WATCH 命令之后，EXEC 命令或DISCARD 命令先被执行了的话，那么就不需要再执行UNWATCH 了。 </span><br></pre></td></tr></table></figure>



<h3 id="1-5-Redis事务的三个特性"><a href="#1-5-Redis事务的三个特性" class="headerlink" title="1.5 Redis事务的三个特性"></a>1.5 Redis事务的三个特性</h3><ul>
<li>单独的隔离操作<ul>
<li>事务中的所有命令都会序列化、按顺序地执行。事务在执行的过程中，不会被其他客户端发送来的命令请求所打断。</li>
</ul>
</li>
<li>没有隔离级别的概念<ul>
<li>队列中的命令没有提交之前都不会实际被执行，因为事务提交前任何指令都不会被实际执行</li>
</ul>
</li>
<li>不保证原子性<ul>
<li>事务中如果有一条命令执行失败，其后的命令仍然会被执行，没有回滚</li>
</ul>
</li>
</ul>
<h2 id="第二节-Redis-Lua-脚本"><a href="#第二节-Redis-Lua-脚本" class="headerlink" title="第二节 Redis Lua 脚本"></a>第二节 Redis Lua 脚本</h2><h3 id="2-1-什么是LUA"><a href="#2-1-什么是LUA" class="headerlink" title="2.1 什么是LUA"></a>2.1 什么是LUA</h3><blockquote>
<p>什么是LUA脚本</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329253.png?x-oss-process=style/this0-blog"></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Lua 是一个小巧的[脚本语言](http://baike.baidu.com/item/脚本语言)，Lua脚本可以很容易的被C/C++ 代码调用，也可以反过来调用C/C++的函数，Lua并没有提供强大的库，一个完整的Lua解释器不过200k，所以Lua不适合作为开发独立应用程序的语言，而是作为嵌入式脚本语言。很多应用程序、游戏使用LUA作为自己的嵌入式脚本语言，以此来实现可配置性、可扩展性。这其中包括魔兽争霸地图、魔兽世界、博德之门、愤怒的小鸟等众多游戏插件或外挂。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>LUA脚本的优势</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">将复杂的或者多步的redis操作，写为一个脚本，一次提交给redis执行，减少反复连接redis的次数。提升性能。</span><br><span class="line">LUA脚本是类似redis事务，有一定的原子性，不会被其他命令插队，可以完成一些redis事务性的操作。但是注意redis的lua脚本功能，只有在Redis 2.6以上的版本才可以使用。利用lua脚本淘汰用户，解决超卖问题。redis 2.6版本以后，通过lua脚本解决争抢问题，实际上是redis利用其单线程的特性，用任务队列的方式解决多任务并发问题。</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329254.png?x-oss-process=style/this0-blog"></p>
<h3 id="2-2-创建SpringBoot工程"><a href="#2-2-创建SpringBoot工程" class="headerlink" title="2.2 创建SpringBoot工程"></a>2.2 创建SpringBoot工程</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329255.png?x-oss-process=style/this0-blog" alt="image-20230706154943584"></p>
<h3 id="2-3-引入相关依赖"><a href="#2-3-引入相关依赖" class="headerlink" title="2.3 引入相关依赖"></a>2.3 引入相关依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="2-4-创建配置文件"><a href="#2-4-创建配置文件" class="headerlink" title="2.4 创建配置文件"></a>2.4 创建配置文件</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.data.redis.host</span>=<span class="string">192.168.6.131</span></span><br><span class="line"><span class="attr">spring.data.redis.port</span>=<span class="string">6379</span></span><br></pre></td></tr></table></figure>



<h3 id="2-5-创建LUA脚本"><a href="#2-5-创建LUA脚本" class="headerlink" title="2.5 创建LUA脚本"></a>2.5 创建LUA脚本</h3><p>创建文件夹lua，创建脚本文件test.lua</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329256.png?x-oss-process=style/this0-blog" alt="image-20230706155329622"></p>
<blockquote>
<p>LUA脚本</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">local</span> current = redis.call(<span class="string">&#x27;GET&#x27;</span>, KEYS[1])</span><br><span class="line"><span class="keyword">if</span> current == ARGV[1]</span><br><span class="line">  <span class="keyword">then</span> redis.call(<span class="string">&#x27;SET&#x27;</span>, KEYS[1], ARGV[2])</span><br><span class="line">  <span class="built_in">return</span> <span class="literal">true</span></span><br><span class="line">end</span><br><span class="line"><span class="built_in">return</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>



<h3 id="2-6-创建配置类"><a href="#2-6-创建配置类" class="headerlink" title="2.6 创建配置类"></a>2.6 创建配置类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.ClassPathResource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.Resource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.script.RedisScript;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.GenericJackson2JsonRedisSerializer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.serializer.StringRedisSerializer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppRedisConfiguration</span>  &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//简单序列化</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisTemplate&lt;String,String&gt; <span class="title function_">redisTemplate</span><span class="params">(RedisConnectionFactory factory)</span> &#123;</span><br><span class="line">        RedisTemplate&lt;String,String&gt; redisTemplate = <span class="keyword">new</span> <span class="title class_">RedisTemplate</span>&lt;&gt;();</span><br><span class="line">        redisTemplate.setConnectionFactory(factory);</span><br><span class="line">        <span class="comment">// 设置键序列化方式</span></span><br><span class="line">        redisTemplate.setKeySerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">        <span class="comment">// 设置简单类型值的序列化方式</span></span><br><span class="line">        redisTemplate.setValueSerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">        <span class="comment">// 设置默认序列化方式</span></span><br><span class="line">        redisTemplate.setDefaultSerializer(<span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>());</span><br><span class="line">        redisTemplate.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//加载lua脚本，设置返回值类型</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RedisScript&lt;Boolean&gt; <span class="title function_">script</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Resource</span> <span class="variable">scriptSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;lua/test.lua&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> RedisScript.of(scriptSource, Boolean.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-7-创建测试类"><a href="#2-7-创建测试类" class="headerlink" title="2.7 创建测试类"></a>2.7 创建测试类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.atguigu;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.script.RedisScript;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestLua</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisScript&lt;Boolean&gt; script;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String,String&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> checkAndSet(<span class="string">&quot;hello&quot;</span>,<span class="string">&quot;helloworld&quot;</span>);</span><br><span class="line">        System.out.println(flag ? <span class="string">&quot;修改成功&quot;</span> : <span class="string">&quot;修改失败&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 手工添加一个值，再试试</span></span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">flag1</span> <span class="operator">=</span> checkAndSet(<span class="string">&quot;world&quot;</span>,<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        System.out.println(flag1 ? <span class="string">&quot;修改成功&quot;</span> : <span class="string">&quot;修改失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">checkAndSet</span><span class="params">(String value1,String value2)</span> &#123;</span><br><span class="line">        List&lt;String&gt; keyList = Collections.singletonList(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.execute(script, keyList, value1,value2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>RedisTemplate.execute说明</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329257.png?x-oss-process=style/this0-blog" alt="image-20230706160027980"></p>
<p><strong>RedisTemplate.execute需要传入三个值</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329258.png?x-oss-process=style/this0-blog" alt="image-20230706160201481"></p>
<ul>
<li><strong>第一个参数 RedisScript script：</strong> Lua脚本</li>
</ul>
<ul>
<li><strong>第二个参数 List keys：</strong>集合<ul>
<li>如果是单个参数，使用这个可以转换为<strong>单元素集合</strong><ul>
<li>Collections.singletonList(参数)；</li>
</ul>
</li>
<li>多参数<ul>
<li><code>List&lt;String&gt; keys = Arrays.asList(key1, key2, key3);</code></li>
</ul>
</li>
</ul>
</li>
<li><strong>第三个参数 args：</strong>ARGV，也就是其他类型参数</li>
</ul>
<h1 id="第八章-Redis的持久化"><a href="#第八章-Redis的持久化" class="headerlink" title="第八章 Redis的持久化"></a>第八章 Redis的持久化</h1><p>&#x2F;&#x2F;TODO,顺序跳过了</p>
<h2 id="学习目标-5"><a href="#学习目标-5" class="headerlink" title="学习目标"></a>学习目标</h2><p>1 熟悉Redis持久化的概念</p>
<p>2 熟悉RDB持久化方式特点以及相关操作</p>
<p>3 熟悉AOF持久化方式特点以及相关操作</p>
<h2 id="第一节-持久化总体介绍"><a href="#第一节-持久化总体介绍" class="headerlink" title="第一节 持久化总体介绍"></a>第一节 持久化总体介绍</h2><p>&#x2F;&#x2F;TODO,rdb是将数据集整体存下来存在磁盘，aof是存操作命令，后面全部执行一次</p>
<blockquote>
<p>我们知道Redis是一个内存型数据库,内存的特性是掉电或者程序退出则不保存数据,但是经过实测我们发现,Redis重启服务后,之前存储的数据仍然在,那么这就是通过持久化的方式实现的.</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329259.png?x-oss-process=style/this0-blog"></p>
<blockquote>
<p>Redis 提供了2个不同形式的持久化方式。</p>
</blockquote>
<ul>
<li>RDB（Redis DataBase）定时数据快照 默认方式</li>
<li>AOF（Append Of File） 指令日志文件 手动开启</li>
</ul>
<h2 id="第二节-RDB持久化"><a href="#第二节-RDB持久化" class="headerlink" title="第二节 RDB持久化"></a>第二节 RDB持久化</h2><h3 id="2-1-RDB简介"><a href="#2-1-RDB简介" class="headerlink" title="2.1 RDB简介"></a>2.1 RDB简介</h3><blockquote>
<p>在指定的时间间隔内将内存中的数据集快照写入磁盘,也就是行话讲的Snapshot快照，它恢复时是将快照文件直接读到内存里.</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329260.png?x-oss-process=style/this0-blog"></p>
<h3 id="2-2-RDB持久化流程"><a href="#2-2-RDB持久化流程" class="headerlink" title="2.2 RDB持久化流程"></a>2.2 RDB持久化流程</h3><blockquote>
<p>执行流程</p>
</blockquote>
<p>&#x20;   Redis会单独创建（fork）一个子进程来进行持久化，会先将数据写入到 一个临时文件中，待持久化过程都结束了，再用这个临时文件替换上次持久化好的文件。 整个过程中，主进程是不进行任何IO操作的，这就确保了极高的性能 如果需要进行大规模数据的恢复，且对于数据恢复的完整性不是非常敏感，那RDB方式要比AOF方式更加的高效。RDB的缺点是最后一次持久化后的数据可能丢失。</p>
<blockquote>
<p>Fork子进程</p>
</blockquote>
<ul>
<li>Fork的作用是复制一个与当前进程一样的进程。新进程的所有数据（变量、环境变量、程序计数器等） 数值都和原进程一致，但是是一个全新的进程，并作为原进程的子进程</li>
<li>在Linux程序中，fork()会产生一个和父进程完全相同的子进程，但子进程在此后多会exec系统调用，出于效率考虑，Linux中引入了“写时复制技术”</li>
<li>一般情况父进程和子进程会共用同一段物理内存，只有进程空间的各段的内容要发生变化时，才会将父进程的内容复制一份给子进程。</li>
</ul>
<blockquote>
<p>RDB持计划流程图</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329261.png?x-oss-process=style/this0-blog"></p>
<h3 id="2-3-RDB相关配置与操作"><a href="#2-3-RDB相关配置与操作" class="headerlink" title="2.3 RDB相关配置与操作"></a>2.3 RDB相关配置与操作</h3><p>1 自动触发</p>
<blockquote>
<p>RDB文件名配置</p>
</blockquote>
<ul>
<li>&#x20;在redis.conf中配置文件名称，默认为dump.rdb</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329262.png?x-oss-process=style/this0-blog" alt="image-20230706162436439"></p>
<p>我是archlinux开发，改成</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">dbfilename</span> dumparch.rdb</span><br></pre></td></tr></table></figure>

<p>单机版可以不改。</p>
<p>redis能使用config命令获取配置</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1:6379</span>&gt; config get requirepass</span><br><span class="line"><span class="number">1</span>) <span class="string">&quot;requirepass&quot;</span></span><br><span class="line"><span class="number">2</span>) <span class="string">&quot;redis&quot;</span></span><br><span class="line"><span class="number">127.0.0.1:6379</span>&gt; </span><br></pre></td></tr></table></figure>



<blockquote>
<p>RDB文件位置配置</p>
</blockquote>
<ul>
<li>rdb文件的保存路径，也可以修改。默认为Redis启动时命令行所在的目录下.</li>
<li>可以通过修改该配置,将RDB文件存到系统的指定目录下</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329263.png?x-oss-process=style/this0-blog" alt="image-20230706162540821"></p>
<p>我就改成了</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dir <span class="regexp">/home/y</span>pt<span class="regexp">/SDE/my</span>redis<span class="regexp">/dumpfiles/</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>RDB自动执行快照策略</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329264.png?x-oss-process=style/this0-blog" alt="image-20230706162725781"></p>
<ul>
<li>save命令临时这只快照执行策略<ul>
<li><p>格式：save 秒钟 写操作次数 RDB是整个内存的压缩过的Snapshot，RDB的数据结构，可以配置复合的快照触发条件， 默认是1分钟至少1万个key发生变化，或5分钟至少100个key发生变化，或1个小时至少1个key发生变化。</p>
</li>
<li><p>禁用 不设置save指令，或者给save传入空字符串</p>
</li>
</ul>
</li>
</ul>
<p>比如，配置</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">save</span> <span class="number">5</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>

<p><code>对变化的计数是累计的</code></p>
<p>间隔 &gt;&#x3D; 5秒,修改次数 &gt;&#x3D; 2个,自动触发</p>
<blockquote>
<p>RDB手动执行快照命令</p>
</blockquote>
<ul>
<li><p>save VS bgsave</p>
<ul>
<li>save ：使用主进行进行持久化指令,save时只管保存，其它不管，全部阻塞。手动保存。不建议。</li>
<li>bgsave：Redis会在后台异步进行快照操作，快照同时还可以响应客户端请求。<br>可以通过lastsave 命令获取最后一次成功执行快照的时间<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329265.png?x-oss-process=style/this0-blog"></li>
</ul>
</li>
<li><p>flushall命令</p>
<ul>
<li>执行flushall命令，也会产生dump.rdb文件，但里面是空的，无意义</li>
</ul>
</li>
<li><p>shutdown命令</p>
<ul>
<li>shutdown命令在关系服务的时候也会进行自动的持久化,创建rdb文件</li>
</ul>
</li>
</ul>
<blockquote>
<p>RDB备份异常策略</p>
</blockquote>
<ul>
<li>stop-writes-on-bgsave-error 配置<ul>
<li>当Redis无法写入磁盘的话，直接关掉Redis的写操作。推荐yes.</li>
</ul>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329266.png?x-oss-process=style/this0-blog" alt="image-20230706162910097"></p>
<blockquote>
<p>RDB 文件压缩配置</p>
</blockquote>
<ul>
<li>rdbcompression配置<ul>
<li>对于存储到磁盘中的快照，可以设置是否进行压缩存储。如果是的话，redis会采用LZF算法进行压缩。如果你不想消耗CPU来进行压缩的话，可以设置为关闭此功能。推荐yes.<br><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329267.png?x-oss-process=style/this0-blog" alt="image-20230706163019916"></li>
</ul>
</li>
</ul>
<blockquote>
<p>RDB文件检查完整性配置</p>
</blockquote>
<ul>
<li>rdbchecksum配置<ul>
<li>在存储快照后，还可以让redis使用CRC64算法来进行数据校验，但是这样做会增加大约10%的性能消耗，如果希望获取到最大的性能提升，可以关闭此功能.推荐yes.</li>
</ul>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329268.png?x-oss-process=style/this0-blog" alt="image-20230706163056568"></p>
<blockquote>
<p>RDB手动备份操作</p>
</blockquote>
<ul>
<li><p>查询rdb文件的目录 将 *.rdb的文件拷贝到别的地方</p>
</li>
<li><p>rdb的恢复</p>
<ul>
<li><p>关闭Redis</p>
</li>
<li><p>先把备份的文件拷贝到工作目录下 cp dump2.rdb dump.rdb</p>
</li>
<li><p>启动Redis, 备份数据会直接加载</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>RDB禁用操作</p>
</blockquote>
<ul>
<li>修改配置文件永久禁用</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329269.png?x-oss-process=style/this0-blog"></p>
<ul>
<li>通过指令临时禁用</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">动态停止RDB：redis-cli config set save &quot;&quot;  save后给空值，表示禁用保存策略(不建议)</span><br></pre></td></tr></table></figure>



<h3 id="2-4-RDB的优势和劣势"><a href="#2-4-RDB的优势和劣势" class="headerlink" title="2.4 RDB的优势和劣势"></a>2.4 RDB的优势和劣势</h3><h4 id="2-4-1-优势"><a href="#2-4-1-优势" class="headerlink" title="2.4.1 优势"></a>2.4.1 优势</h4><ul>
<li>适合大规模的数据恢复</li>
<li>对数据完整性和一致性要求不高更适合使用</li>
<li><strong>节省磁盘空间</strong></li>
<li><strong>恢复速度快</strong></li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329270.png?x-oss-process=style/this0-blog"></p>
<h4 id="2-4-2-劣势"><a href="#2-4-2-劣势" class="headerlink" title="2.4.2 劣势"></a>2.4.2 劣势</h4><ul>
<li>Fork的时候，内存中的数据被克隆了一份，大致2倍的膨胀性需要考虑</li>
<li>虽然Redis在fork时使用了<strong>写时拷贝技术</strong>,但是如果数据庞大时还是比较消耗性能。</li>
<li>在备份周期在一定间隔时间做一次备份，所以如果Redis意外down掉的话，就会丢失最后一次快照后的所有修改。</li>
</ul>
<h3 id="2-5-RDB小总结"><a href="#2-5-RDB小总结" class="headerlink" title="2.5 RDB小总结"></a>2.5 RDB小总结</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329271.png?x-oss-process=style/this0-blog"></p>
<h2 id="第三节-AOF持久化"><a href="#第三节-AOF持久化" class="headerlink" title="第三节 AOF持久化"></a>第三节 AOF持久化</h2><h3 id="3-1-AOF简介"><a href="#3-1-AOF简介" class="headerlink" title="3.1 AOF简介"></a>3.1 AOF简介</h3><p>&#x20;      Append Only File 以日志的形式来记录每个写操作（增量保存），将Redis执行过的所有写指令记录下来(读操作不记录)， 只许追加文件但不可以改写文件，redis启动之初会读取该文件重新构建数据，换言之，redis 重启的话就根据日志文件的内容将写指令从前到后执行一次以完成数据的恢复工作</p>
<h3 id="3-2-AOF持计划流程"><a href="#3-2-AOF持计划流程" class="headerlink" title="3.2 AOF持计划流程"></a>3.2 AOF持计划流程</h3><p>（1）客户端的请求写命令会被append追加到AOF缓冲区内；</p>
<p>（2）AOF缓冲区根据AOF持久化策略[always,everysec,no]将操作sync同步到磁盘的AOF文件中；</p>
<p>（3）AOF文件大小超过重写策略或手动重写时，会对AOF文件rewrite重写，压缩AOF文件容量；</p>
<p>（4）Redis服务重启时，会重新load加载AOF文件中的写操作达到数据恢复的目的；</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329272.png?x-oss-process=style/this0-blog"></p>
<h3 id="3-3-AOF相关配置与操作"><a href="#3-3-AOF相关配置与操作" class="headerlink" title="3.3 AOF相关配置与操作"></a>3.3 AOF相关配置与操作</h3><blockquote>
<p>AOF文件名配置</p>
</blockquote>
<ul>
<li>可以在redis.conf中配置文件名称，默认为 appendonly.aof</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329273.png?x-oss-process=style/this0-blog" alt="image-20230706163701368"></p>
<blockquote>
<p>AOF文件位置路径</p>
</blockquote>
<ul>
<li>Redis6中，AOF文件的保存路径，同RDB的路径一致。</li>
<li>Redis7有变化：</li>
</ul>
<p>base：基本文件</p>
<p>incr：增量文件</p>
<p>manifest：清单文件</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329274.png?x-oss-process=style/this0-blog" alt="image-20230706164947931"></p>
<blockquote>
<p>AOF开启-修复-恢复操作</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AOF的备份机制和性能虽然和RDB不同, 但是备份和恢复的操作同RDB一样，都是拷贝备份文件，需要恢复时再拷贝到Redis工作目录下，启动系统即加载。</span><br></pre></td></tr></table></figure>

<ul>
<li><p>正常恢复数据</p>
<ul>
<li><p>修改默认的appendonly no，改为yes,开启AOP方式</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329275.png?x-oss-process=style/this0-blog" alt="image-20230706163851658"></p>
</li>
<li><p>将有数据的aof文件复制一份保存到对应目录(查看目录：config get dir)</p>
</li>
<li><p>恢复：重启redis然后重新加载</p>
</li>
</ul>
</li>
<li><p>异常修复数据</p>
<ul>
<li><p>修改默认的appendonly no，改为yes</p>
</li>
<li><p>如遇到AOF文件损坏，通过&#x2F;usr&#x2F;local&#x2F;bin&#x2F;redis-check-aof –fix appendonly.aof.1.incr.aof进行恢复</p>
</li>
<li><p>备份被写坏的AOF文件</p>
</li>
<li><p>恢复：重启redis，然后重新加载</p>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>AOF同步频率设置</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329277.png?x-oss-process=style/this0-blog" alt="image-20230706164003278"></p>
<ul>
<li><p>appendfsync always</p>
<ul>
<li>始终同步，每次Redis的写入都会立刻记入日志；性能较差但数据完整性比较好</li>
</ul>
</li>
<li><p>appendfsync everysec</p>
<ul>
<li>每秒同步，每秒记入日志一次，如果宕机，本秒的数据可能丢失。</li>
</ul>
</li>
<li><p>appendfsync no</p>
<ul>
<li>redis不主动进行同步，把同步时机交给操作系统。</li>
</ul>
</li>
</ul>
<blockquote>
<p>AOF压缩配置</p>
</blockquote>
<ul>
<li><p>什么是文件压缩 rewrite重写?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AOF采用文件追加方式，文件会越来越大为避免出现此种情况，新增了重写机制, 当AOF文件的大小超过所设定的阈值时，Redis就会启动AOF文件的内容压缩， 只保留可以恢复数据的最小指令集.可以使用命令bgrewriteaof</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329278.png?x-oss-process=style/this0-blog"></p>
</li>
<li><p>如何实现重写?</p>
<ul>
<li>AOF文件持续增长而过大时，会fork出一条新进程来将文件重写(也是先写临时文件最后再rename)，redis4.0版本后的重写，是指上就是把rdb 的快照，以二级制的形式附在新的aof头部，作为已有的历史数据，替换掉原来的流水账操作。</li>
<li>no-appendfsync-on-rewrite 设置重写策略</li>
<li>如果 no-appendfsync-on-rewrite&#x3D;yes ,不写入aof文件只写入缓存，用户请求不会阻塞，但是在这段时间如果宕机会丢失这段时间的缓存数据。（降低数据安全性，提高性能）</li>
<li>如果 no-appendfsync-on-rewrite&#x3D;no, 还是会把数据往磁盘里刷，但是遇到重写操作，可能会发生阻塞。（数据安全，但是性能降低）</li>
</ul>
</li>
<li><p>何时触发重写?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Redis会记录上次重写时的AOF大小，默认配置是当AOF文件大小是上次rewrite后大小的一倍且文件大于64M时触发,重写虽然可以节约大量磁盘空间，减少恢复时间。但是每次重写还是有一定的负担的，因此设定Redis要满足一定条件才会进行重写。</span><br></pre></td></tr></table></figure>

<ul>
<li>auto-aof-rewrite-percentage 设置重写基准值<ul>
<li>文件达到100%时开始重写（文件是原来重写后文件的2倍时触发）</li>
</ul>
</li>
<li>auto-aof-rewrite-min-size 设置重写基准值<ul>
<li>最小文件64MB。达到这个值开始重写。</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">例如：文件达到70MB开始重写，降到50MB，下次什么时候开始重写？100MB</span><br><span class="line">系统载入时或者上次重写完毕时，Redis会记录此时AOF大小，设为base_size,如果Redis的AOF当前大小&gt;= base_size +base_size*100% (默认)且当前大小&gt;=64mb(默认)的情况下，Redis会对AOF进行重写。 </span><br></pre></td></tr></table></figure>
</li>
<li><p>重写的流程是?</p>
<ul>
<li>（1）bgrewriteaof触发重写，判断是否当前有bgsave或bgrewriteaof在运行，如果有，则等待该命令结束后再继续执行。</li>
<li>（2）主进程fork出子进程执行重写操作，保证主进程不会阻塞。</li>
<li>（3）子进程遍历redis内存中数据到临时文件，客户端的写请求同时写入aof_buf缓冲区和aof_rewrite_buf重写缓冲区,保证原AOF文件完整以及新AOF文件生成期间的新的数据修改动作不会丢失。</li>
<li>（4）<ul>
<li>1).子进程写完新的AOF文件后，向主进程发信号，父进程更新统计信息。&#x20;</li>
<li>2).主进程把aof_rewrite_buf中的数据写入到新的AOF文件。</li>
</ul>
</li>
<li>（5）使用新的AOF文件覆盖旧的AOF文件，完成AOF重写。</li>
</ul>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329279.png?x-oss-process=style/this0-blog"></p>
<h3 id="3-4-AOF的优势"><a href="#3-4-AOF的优势" class="headerlink" title="3.4 AOF的优势"></a>3.4 AOF的优势</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329280.png?x-oss-process=style/this0-blog"></p>
<ul>
<li>备份机制更稳健，丢失数据概率更低。</li>
<li>可读的日志文本，通过操作AOF稳健，可以处理误操作。</li>
</ul>
<h3 id="3-5-AOF的劣势"><a href="#3-5-AOF的劣势" class="headerlink" title="3.5 AOF的劣势"></a>3.5 AOF的劣势</h3><ul>
<li>比起RDB占用更多的磁盘空间。</li>
<li>恢复备份速度要慢。</li>
<li>每次读写都同步的话，有一定的性能压力。</li>
<li>存在个别Bug，造成无法恢复。</li>
</ul>
<h3 id="3-6-AOF小总结"><a href="#3-6-AOF小总结" class="headerlink" title="3.6 AOF小总结"></a>3.6 AOF小总结</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329281.png?x-oss-process=style/this0-blog"></p>
<h3 id="3-7-持久化方案选择"><a href="#3-7-持久化方案选择" class="headerlink" title="3.7 持久化方案选择"></a>3.7 持久化方案选择</h3><blockquote>
<p>RDB和AOP用哪个好?</p>
</blockquote>
<ul>
<li>官方推荐两个都启用。</li>
<li>如果对数据不敏感，可以选单独用RDB。</li>
<li>不建议单独用 AOF，因为可能会出现Bug。</li>
<li>如果只是做纯内存缓存，可以都不用。</li>
<li>AOF和RDB如果同时开启,系统默认取AOF中的持久化数据</li>
</ul>
<blockquote>
<p>官网建议</p>
</blockquote>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329282.png?x-oss-process=style/this0-blog"></p>
<ul>
<li>RDB持久化方式能够在指定的时间间隔能对你的数据进行快照存储</li>
<li>AOF持久化方式记录每次对服务器写的操作,当服务器重启的时候会重新执行这些命令来恢复原始的数据,AOF命令以redis协议追加保存每次写的操作到文件末尾.</li>
<li>Redis还能对AOF文件进行后台重写,使得AOF文件的体积不至于过大</li>
<li>只做缓存：如果你只希望你的数据在服务器运行的时候存在,你也可以不使用任何持久化方式.</li>
<li>同时开启两种持久化方式</li>
<li>在这种情况下,当redis重启的时候会优先载入AOF文件来恢复原始的数据, 因为在通常情况下AOF文件保存的数据集要比RDB文件保存的数据集要完整.</li>
<li>RDB的数据不实时，同时使用两者时服务器重启也只会找AOF文件。那要不要只使用AOF呢？</li>
<li>建议不要，因为RDB更适合用于备份数据库(AOF在不断变化不好备份)， 快速重启，而且不会有AOF可能潜在的bug，留着作为一个万一的手段。</li>
<li>性能建议</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">因为RDB文件只用作后备用途，建议只在Slave上持久化RDB文件，而且只要15分钟备份一次就够了，只保留save 900 1这条规则。</span><br><span class="line"> </span><br><span class="line">如果使用AOF，好处是在最恶劣情况下也只会丢失不超过两秒数据，启动脚本较简单只load自己的AOF文件就可以了。</span><br><span class="line">代价,一是带来了持续的IO，二是AOF rewrite的最后将rewrite过程中产生的新数据写到新文件造成的阻塞几乎是不可避免的。</span><br><span class="line">只要硬盘许可，应该尽量减少AOF rewrite的频率，AOF重写的基础大小默认值64M太小了，可以设到5G以上。</span><br><span class="line">默认超过原大小100%大小时重写可以改到适当的数值。</span><br></pre></td></tr></table></figure>



<h1 id="第九章-Redis主从复制"><a href="#第九章-Redis主从复制" class="headerlink" title="第九章 Redis主从复制"></a>第九章 Redis主从复制</h1><h2 id="学习目标-6"><a href="#学习目标-6" class="headerlink" title="学习目标"></a>学习目标</h2><p>1 熟悉Redis主从复制的特点</p>
<p>2 能搭建Redis的 一主二仆和哨兵模式</p>
<h2 id="第一节-什么是主从复制"><a href="#第一节-什么是主从复制" class="headerlink" title="第一节 什么是主从复制"></a>第一节 什么是主从复制</h2><blockquote>
<p>主机数据更新后根据配置和策略， 自动同步到备机的master&#x2F;slaver机制，Master以写为主，Slave以读为主</p>
</blockquote>
<h2 id="第二节-主从复制的作用"><a href="#第二节-主从复制的作用" class="headerlink" title="第二节 主从复制的作用"></a>第二节 主从复制的作用</h2><ul>
<li>读写分离，性能扩展</li>
<li>容灾快速恢复</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329283.png?x-oss-process=style/this0-blog"></p>
<h2 id="第三节-主从复制具体操作"><a href="#第三节-主从复制具体操作" class="headerlink" title="第三节 主从复制具体操作"></a>第三节 主从复制具体操作</h2><h3 id="（1）实现思路"><a href="#（1）实现思路" class="headerlink" title="（1）实现思路"></a>（1）实现思路</h3><ul>
<li><p>1 一个redis服务作为主机,主要负责写操作</p>
</li>
<li><p>2 两个redis服务作为从机,主要负责读操作</p>
</li>
<li><p>3 从机自动从主机同步数据下来</p>
</li>
<li><p>4 从机主动找主机,而主机不会找从机</p>
</li>
<li><p>5 正常来说主机和从机应该在不同的IP上开启redis服务,我们为了快速模拟,可以在一台机器上模拟出三个redis服务即可</p>
</li>
</ul>
<h3 id="（2）-一台机器上启动多个redis服务"><a href="#（2）-一台机器上启动多个redis服务" class="headerlink" title="（2） 一台机器上启动多个redis服务"></a>（2） 一台机器上启动多个redis服务</h3><ul>
<li>使用redis-server启动服务时,要以来redis.conf配置文件.那么我们可以准备三个redis.conf文件,用来配置三个不同的服务,启动三次分别以来三个不同的服务即可</li>
</ul>
<h3 id="（3）新建三个redis配置文件"><a href="#（3）新建三个redis配置文件" class="headerlink" title="（3）新建三个redis配置文件"></a>（3）新建三个redis配置文件</h3><p><strong>用于定义每个服务的专属配置</strong></p>
<ul>
<li><p>新建redis6379.conf</p>
<p>关闭aof功能</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329284.png?x-oss-process=style/this0-blog" alt="image-20230706184344365"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">include /root/myredis/redis.conf</span><br><span class="line">pidfile /var/run/redis_6379.pid</span><br><span class="line">port 6379</span><br><span class="line">dbfilename dump6379.rdb</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329286.png?x-oss-process=style/this0-blog"></p>
<ul>
<li>含义介绍</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">include /root/myredis/redis.conf # 引入共同的配置</span><br><span class="line">pidfile /var/run/redis_6379.pid # 使用独立的进程文件</span><br><span class="line">port 6379 # 设置当前服务的端口号</span><br><span class="line">dbfilename dump6379.rdb # 使用独立的RDB持久化文件  暂时不适用AOP持久化</span><br></pre></td></tr></table></figure>


</li>
<li><p>新建redis6380.conf</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329287.png?x-oss-process=style/this0-blog"></p>
</li>
<li><p>新建redis6381.conf</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329288.png?x-oss-process=style/this0-blog"></p>
<ul>
<li>在redis6381中多添加一个配置,设置从机的优先级，值越小，优先级越高，用于选举主机时使用。默认100</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">replica-priority 10 </span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="（4）启动三个服务"><a href="#（4）启动三个服务" class="headerlink" title="（4）启动三个服务"></a>（4）启动三个服务</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329289.png?x-oss-process=style/this0-blog" alt="image-20230706185404340"></p>
<h3 id="（5）查看启动服务进程"><a href="#（5）查看启动服务进程" class="headerlink" title="（5）查看启动服务进程"></a>（5）查看启动服务进程</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329290.png?x-oss-process=style/this0-blog" alt="image-20230706185335546"></p>
<h3 id="（6）使用info-replication查看主从相关信息"><a href="#（6）使用info-replication查看主从相关信息" class="headerlink" title="（6）使用info replication查看主从相关信息"></a>（6）使用info replication查看主从相关信息</h3><ul>
<li>连接redis，使用：redis-cli -p 端口号</li>
<li>执行 info replication查看信息</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329291.png?x-oss-process=style/this0-blog" alt="image-20230706185249563"></p>
<h3 id="（7）-配置主从机器"><a href="#（7）-配置主从机器" class="headerlink" title="（7） 配置主从机器"></a>（7） 配置主从机器</h3><ul>
<li><p>配从不配主,是让从机主动去找主机</p>
</li>
<li><p>在6380 和6381的机器上执行如下命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slaveof 127.0.0.1 6379</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行完毕再次查看主从配置信息</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329292.png?x-oss-process=style/this0-blog" alt="image-20230706185658801"></p>
</li>
</ul>
<h3 id="（8）测试主从读写操作"><a href="#（8）测试主从读写操作" class="headerlink" title="（8）测试主从读写操作"></a>（8）测试主从读写操作</h3><ul>
<li><p>主机上写入数据OK</p>
</li>
<li><p>在从机上写数据报错</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329293.png?x-oss-process=style/this0-blog"></p>
</li>
<li><p>主机宕机,重启即可恢复主从状态,无需其他操作</p>
</li>
<li><p>从机宕机,重启后需要重新执行 slaveof 127.0.0.1 6379 才能恢复</p>
</li>
<li><p>从机可以在配置文件中写入slaveof 127.0.0.1 6379 ,这样重启无需手动输入slaveof 127.0.0.1 6379就可以恢复从机状态</p>
</li>
</ul>
<h2 id="第四节-主从复制原理"><a href="#第四节-主从复制原理" class="headerlink" title="第四节 主从复制原理"></a>第四节 主从复制原理</h2><ul>
<li>Slave启动成功连接到master后会发送一个sync命令</li>
<li>Master接到命令启动后台的存盘进程，同时收集所有接收到的用于修改数据集命令， 在后台进程执行完毕之后，master将传送整个数据文件到slave,以完成一次完全同步</li>
<li>全量复制：而slave服务在接收到数据库文件数据后，将其存盘并加载到内存中。</li>
<li>增量复制：Master继续将新的所有收集到的修改命令依次传给slave,完成同步</li>
<li>但是只要是重新连接master,一次完全同步（全量复制)将被自动执行</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329294.png?x-oss-process=style/this0-blog"></p>
<h2 id="第五节-主动复制三种模式"><a href="#第五节-主动复制三种模式" class="headerlink" title="第五节 主动复制三种模式"></a>第五节 主动复制三种模式</h2><blockquote>
<p>第一种 一主二仆</p>
</blockquote>
<ul>
<li>问题1: 切入点问题,slave1、slave2是从头开始复制还是从切入点开始复制?比如从k4进来，那之前的k1,k2,k3是否也可以复制？</li>
<li>问题2 :从机是否可以写？set可否？</li>
<li>问题3:主机shutdown后情况如何？从机是上位还是原地待命？</li>
<li>问题4:主机又回来了后，主机新增记录，从机还能否顺利复制？</li>
<li>问题5:其中一台从机down后情况如何？依照原有它能跟上大部队吗(还会自动变为从机吗?)？</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329295.png?x-oss-process=style/this0-blog"></p>
<blockquote>
<p>第二种 薪火相传</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">上一个Slave可以是下一个slave的Master，Slave同样可以接收其他 slaves的连接和同步请求，那么该slave作为了链条中下一个的master, 可以有效减轻master的写压力,去中心化降低风险。用 slaveof  &lt;ip&gt;&lt;port&gt;</span><br><span class="line">​中途变更转向:会清除之前的数据，重新建立拷贝最新的,风险是一旦某个slave宕机，后面的slave都没法备份,主机挂了，从机还是从机，无法写数据了</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329297.png?x-oss-process=style/this0-blog"></p>
<blockquote>
<p>第三种 反客为主</p>
</blockquote>
<ul>
<li>当一个master宕机后，后面的slave可以立刻升为master，其后面的slave不用做任何修改。用 slaveof no one  将从机变为主机。</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329298.png?x-oss-process=style/this0-blog"></p>
<h2 id="第六节-哨兵模式"><a href="#第六节-哨兵模式" class="headerlink" title="第六节 哨兵模式"></a>第六节 哨兵模式</h2><h3 id="6-1-哨兵模式简介"><a href="#6-1-哨兵模式简介" class="headerlink" title="6.1 哨兵模式简介"></a>6.1 哨兵模式简介</h3><blockquote>
<p>反客为主的自动版，能够后台监控主机是否故障，如果故障了根据投票数自动将从库转换为主库</p>
</blockquote>
<h3 id="6-2-哨兵模式的使用步骤"><a href="#6-2-哨兵模式的使用步骤" class="headerlink" title="6.2 哨兵模式的使用步骤"></a>6.2 哨兵模式的使用步骤</h3><h4 id="（1）第一步-设置简单的一主二仆"><a href="#（1）第一步-设置简单的一主二仆" class="headerlink" title="（1）第一步: 设置简单的一主二仆"></a>（1）第一步: 设置简单的一主二仆</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329299.png?x-oss-process=style/this0-blog"></p>
<h4 id="（2）第二步-为哨兵模式准备配置文件"><a href="#（2）第二步-为哨兵模式准备配置文件" class="headerlink" title="（2）第二步: 为哨兵模式准备配置文件"></a>（2）第二步: 为哨兵模式准备配置文件</h4><ul>
<li><p>在&#x2F;root&#x2F;myredis 目录下新建sentinel.conf 配置文件中放入如下内容</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sentinel monitor mymaster 127.0.0.1 6379 1</span><br></pre></td></tr></table></figure>
</li>
<li><p>其中mymaster为监控对象起的服务器名称， 1 为至少有多少个哨兵同意迁移的数量。 &#x20;</p>
</li>
</ul>
<h4 id="（3）第三步-启动哨兵"><a href="#（3）第三步-启动哨兵" class="headerlink" title="（3）第三步: 启动哨兵"></a>（3）第三步: 启动哨兵</h4><ul>
<li><p>运行&#x2F;usr&#x2F;local&#x2F;bin 下 redis-sentinel 命令,执行&#x2F;root&#x2F;myredis&#x2F;sentinel.conf配置文件</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-sentinel /root/myredis/sentinel.conf</span><br></pre></td></tr></table></figure>
</li>
<li><p>redis做压测可以用自带的redis-benchmark工具 &#x20;</p>
</li>
</ul>
<h3 id="6-3-哨兵模式的操作演示"><a href="#6-3-哨兵模式的操作演示" class="headerlink" title="6.3 哨兵模式的操作演示"></a>6.3 哨兵模式的操作演示</h3><h4 id="（1）主机宕机演示"><a href="#（1）主机宕机演示" class="headerlink" title="（1）主机宕机演示"></a>（1）主机宕机演示</h4><ul>
<li>当主机宕机,会从从机中选择一个作为新的主机,根据优先级slave-properity, 原主机重启后会成为从机</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329300.png?x-oss-process=style/this0-blog" alt="image-20230706190854461"></p>
<h4 id="（2）复制延时"><a href="#（2）复制延时" class="headerlink" title="（2）复制延时"></a>（2）复制延时</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">由于所有的写操作都是先在Master上操作，然后同步更新到Slave上，所以从Master同步到Slave机器有一定的延迟，当系统很繁忙的时候，延迟问题会更加严重，Slave机器数量的增加也会使这个问题更加严重。</span><br></pre></td></tr></table></figure>



<h4 id="（3）故障恢复"><a href="#（3）故障恢复" class="headerlink" title="（3）故障恢复"></a>（3）故障恢复</h4><ul>
<li>优先级在redis.conf中默认：replica-priority 100，值越小优先级越高</li>
<li>偏移量是指获得原主机数据最全的</li>
<li>每个redis实例启动后都会随机生成一个40位的runid</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329301.png?x-oss-process=style/this0-blog"></p>
<h1 id="第十章-Redis集群操作"><a href="#第十章-Redis集群操作" class="headerlink" title="第十章 Redis集群操作"></a>第十章 Redis集群操作</h1><h2 id="学习目标-7"><a href="#学习目标-7" class="headerlink" title="学习目标"></a>学习目标</h2><p>1 熟悉Redis中的集群模式特点</p>
<p>2 能够独立搭建Redis的集群</p>
<p>3 能够熟练操作集群</p>
<h2 id="9-1-目前面临问题分析"><a href="#9-1-目前面临问题分析" class="headerlink" title="9.1 目前面临问题分析"></a>9.1 目前面临问题分析</h2><ul>
<li>容量不够，redis如何进行扩容？</li>
<li>并发写操作， redis如何分摊？</li>
<li>另外，主从模式，薪火相传模式，主机宕机，导致ip地址发生变化，应用程序中配置需要修改对应的主机地址、端口等信息。</li>
<li>之前通过代理主机来解决，但是redis3.0中提供了解决方案。就是无中心化集群配置。</li>
</ul>
<h2 id="9-2-什么是集群"><a href="#9-2-什么是集群" class="headerlink" title="9.2 什么是集群"></a>9.2 什么是集群</h2><blockquote>
<p>Redis 集群实现了对Redis的水平扩容，即启动N个redis节点，将整个数据库分布存储在这N个节点中，每个节点存储总数据的1&#x2F;N。</p>
</blockquote>
<blockquote>
<p>Redis 集群通过分区（partition）来提供一定程度的可用性（availability ）：即使集群中有一部分节点失效或者无法进行通讯，集群也可以继续处理命令请求。</p>
</blockquote>
<h2 id="9-3-集群的搭建"><a href="#9-3-集群的搭建" class="headerlink" title="9.3 集群的搭建"></a>9.3 集群的搭建</h2><h3 id="（1）第一步-搭建前的准备"><a href="#（1）第一步-搭建前的准备" class="headerlink" title="（1）第一步,搭建前的准备"></a>（1）第一步,搭建前的准备</h3><ul>
<li>之前操作产生的rdb和aof文件删除</li>
<li>appendonly 修改回 no</li>
<li>清空主从复制和哨兵模式留下的一些文件</li>
<li>开启daemonize yes</li>
<li>protected-mode no</li>
<li>注释掉bind</li>
</ul>
<h3 id="（2）第二步-制作六个实例的配置文件"><a href="#（2）第二步-制作六个实例的配置文件" class="headerlink" title="（2）第二步,制作六个实例的配置文件"></a>（2）第二步,制作六个实例的配置文件</h3><ul>
<li><p>配置文件的内容</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">include /root/myredis/redis.conf</span><br><span class="line">port 6379</span><br><span class="line">pidfile &quot;/var/run/redis_6379.pid&quot;</span><br><span class="line">dbfilename &quot;dump6379.rdb&quot;</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes-6379.conf</span><br><span class="line">cluster-node-timeout 15000</span><br></pre></td></tr></table></figure>
</li>
<li><p>内容解释</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">include /root/myredis/redis.conf #引用公共的配置文件</span><br><span class="line">port 6379 # 设置端口号</span><br><span class="line">pidfile &quot;/var/run/redis_6379.pid&quot; # 设置pid进程文件</span><br><span class="line">dbfilename &quot;dump6379.rdb&quot; # 设置rdb持久化问价名</span><br><span class="line">cluster-enabled yes # 开启集群</span><br><span class="line">cluster-config-file nodes-6379.conf # 设置集群使用的结点文件名</span><br><span class="line">cluster-node-timeout 15000 # 设置结点失联时间</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建6379 6380 6381  6389 6390 6391 六个结点的配置文件</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">创建一个配置文件后,进行复制即可,然后再vim下,通过 :%s/6379/目标端口 来批量替换每个配置文件中的端口号</span><br></pre></td></tr></table></figure>

<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329302.png?x-oss-process=style/this0-blog" alt="image-20230706200218897"></p>
</li>
</ul>
<h3 id="（3）第三步-启动六个服务"><a href="#（3）第三步-启动六个服务" class="headerlink" title="（3）第三步,启动六个服务"></a>（3）第三步,启动六个服务</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329303.png?x-oss-process=style/this0-blog" alt="image-20230706200143345"></p>
<ul>
<li>组合之前，请确保所有redis实例启动后，nodes-xxxx.conf文件都生成正常。</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329304.png?x-oss-process=style/this0-blog" alt="image-20230706200315643"></p>
<h3 id="（4）第四步-将六个服务合并为一个集群"><a href="#（4）第四步-将六个服务合并为一个集群" class="headerlink" title="（4）第四步 ,将六个服务合并为一个集群"></a>（4）第四步 ,将六个服务合并为一个集群</h3><ul>
<li><p>切换目录到redis的src下</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/redis-7.0.10/src</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行如下指令</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster create --cluster-replicas 1 192.168.6.131:6379 192.168.6.131:6380 192.168.6.131:6381 192.168.6.131:6382 192.168.6.131:6383 192.168.6.131:6384</span><br></pre></td></tr></table></figure>

<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">  </span><br></pre></td></tr></table></figure>

<p><strong>此处不要用127.0.0.1， 请用真实IP地址    –replicas 1 采用最简单的方式配置集群，一台主机，一台从机，正好三组。</strong></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329305.png?x-oss-process=style/this0-blog" alt="image-20230706200816752"></p>
<p>输入 yes 继续</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329306.png?x-oss-process=style/this0-blog" alt="image-20230706200954694"></p>
</li>
</ul>
<h2 id="9-4集群的登录"><a href="#9-4集群的登录" class="headerlink" title="9.4集群的登录"></a>9.4集群的登录</h2><h3 id="（1）集群登录方式"><a href="#（1）集群登录方式" class="headerlink" title="（1）集群登录方式"></a>（1）集群登录方式</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329308.png?x-oss-process=style/this0-blog"></p>
<ul>
<li>登录指令添加 -c 代表以集群方式登录</li>
</ul>
<h3 id="（2）登录后查看集群信息"><a href="#（2）登录后查看集群信息" class="headerlink" title="（2）登录后查看集群信息"></a>（2）登录后查看集群信息</h3><ul>
<li><p>一个集群至少要有三个主节点。选项 –cluster-replicas 1 表示我们希望为集群中的每个主节点创建一个从节点。</p>
</li>
<li><p>分配原则尽量保证每个主数据库运行在不同的IP,每个从库和主库不在一个IP地址上。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster nodes</span><br></pre></td></tr></table></figure></li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329309.png?x-oss-process=style/this0-blog" alt="image-20230706201216761"></p>
<h2 id="9-5-集群的slots"><a href="#9-5-集群的slots" class="headerlink" title="9.5 集群的slots"></a>9.5 集群的slots</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329310.png?x-oss-process=style/this0-blog" alt="image-20230706201426691"></p>
<ul>
<li>一个 Redis 集群包含 16384 个插槽（hash slot）， 数据库中的每个键都属于这 16384 个插槽的其中一个，</li>
<li>集群使用公式 CRC16(key) % 16384 来计算键 key 属于哪个槽， 其中 CRC16(key) 语句用于计算键 key 的 CRC16 校验和 。</li>
<li>集群中的每个节点负责处理一部分插槽。 举个例子， 如果一个集群可以有主节点， 其中：<ul>
<li>节点 A 负责处理 0 号至 5460 号插槽。</li>
<li>节点 B 负责处理 5461 号至 10922 号插槽。</li>
<li>节点 C 负责处理 10923 号至 16383 号插槽。</li>
</ul>
</li>
</ul>
<h2 id="9-6-集群中录入值"><a href="#9-6-集群中录入值" class="headerlink" title="9.6 集群中录入值"></a>9.6 集群中录入值</h2><ul>
<li>在redis-cli每次录入、查询键值，redis都会计算出该key应该送往的插槽，如果不是该客户端对应服务器的插槽，redis会报错，并告知应前往的redis实例地址和端口。</li>
<li>redis-cli客户端提供了 –c 参数实现自动重定向。</li>
<li>如 redis-cli -c –p 6379 登入后，再录入、查询键值对可以自动重定向。</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329311.png?x-oss-process=style/this0-blog" alt="image-20230706201647379"></p>
<ul>
<li><p>不在一个slot下的键值，是不能使用mget,mset等多键操作。</p>
</li>
<li><p>可以通过{}来定义组的概念，从而使key中{}内相同内容的键值对放到一个slot中去。</p>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329312.png?x-oss-process=style/this0-blog" alt="image-20230706201756159"></p>
<h2 id="9-7-集群中查找值"><a href="#9-7-集群中查找值" class="headerlink" title="9.7 集群中查找值"></a>9.7 集群中查找值</h2><ul>
<li>cluster keyslot key 计算key应该保存在那个插槽</li>
<li>cluster countkeysinslot slot的值 计算某个插槽中保存的key的数量</li>
<li>CLUSTER GETKEYSINSLOT &lt;slot&gt;&lt;count&gt; 返回 count 个 slot 槽中的键。</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329313.png?x-oss-process=style/this0-blog" alt="image-20230706202007674"></p>
<h2 id="9-8-集群故障恢复"><a href="#9-8-集群故障恢复" class="headerlink" title="9.8 集群故障恢复"></a>9.8 集群故障恢复</h2><ul>
<li>如果主节点下线？从节点能否自动升为主节点？注意：<strong>15秒超时</strong></li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329314.png?x-oss-process=style/this0-blog" alt="image-20230706202459470"></p>
<ul>
<li>主节点恢复后，主从关系会如何？主节点回来变成从机。</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://blog-resources.this0.com/image/202403281329315.png?x-oss-process=style/this0-blog" alt="image-20230706202640635"></p>
<ul>
<li>如果所有某一段插槽的主从节点都宕掉，redis服务是否还能继续?<ul>
<li>redis.conf中cluster-require-full-coverage 为yes 那么 ，整个集群都挂掉</li>
<li>redis.conf中cluster-require-full-coverage 为no 那么，只有该插槽数据全都不能使用。</li>
</ul>
</li>
</ul>
<h2 id="9-9-集群提供的好处"><a href="#9-9-集群提供的好处" class="headerlink" title="9.9 集群提供的好处"></a>9.9 集群提供的好处</h2><ul>
<li>实现扩容</li>
<li>分摊压力</li>
<li>无中心配置相对简单</li>
</ul>
<h2 id="9-10-集群的不足"><a href="#9-10-集群的不足" class="headerlink" title="9.10 集群的不足"></a>9.10 集群的不足</h2><ul>
<li>多键操作是不被支持的</li>
<li>多键的Redis事务是不被支持的。lua脚本不被支持</li>
<li>由于集群方案出现较晚，很多公司已经采用了其他的集群方案，而代理或者客户端分片的方案想要迁移至redis cluster，需要整体迁移而不是逐步过渡，复杂度较大。</li>
</ul>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.this0.com/blog/base/favicon.png" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.this0.com/blog/base/favicon.png" title="头像" alt="头像"></a><div class="post-copyright__author_name">YuPengtao</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://www.this0.com/articles/40c5a151.html">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://www.this0.com/articles/40c5a151.html')">微服务项目架构搭建</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://cdn.this0.com/blog/base/wechat.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.this0.com/blog/base/wechat.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://cdn.this0.com/blog/base/alipay.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.this0.com/blog/base/alipay.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://www.this0.com/articles/40c5a151.html"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.this0.com" target="_blank">This0</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/sss/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>sss<span class="tagsPageCount">1</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://cdn.this0.com/blog/base/favicon.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/articles/1a1a324a.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">gateway网关</div></div></a></div><div class="next-post pull-right"><a href="/articles/40c5a151.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">微服务项目架构搭建</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.this0.com/blog/base/favicon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-status"><img class="g-status" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://cdn.jsdelivr.net/gh/zc998800/cdn/face/gif/p011.gif" alt="status"/></div></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">YuPengtao</h1><div class="author-info__desc"></div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/anzhiyu-c" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/372204786" target="_blank" title="BiliBili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bullhorn anzhiyu-shake"></i><span>公告</span></div><div class="announcement_content">欢迎来看我的博客鸭~</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%AB%A0-NoSQL%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">1.</span> <span class="toc-text">第一章 NoSQL数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87"><span class="toc-number">1.1.</span> <span class="toc-text">学习目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E8%8A%82-NoSQL%E6%95%B0%E6%8D%AE%E5%BA%93%E6%A6%82%E8%BF%B0"><span class="toc-number">1.2.</span> <span class="toc-text">第一节 NoSQL数据库概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E4%BB%80%E4%B9%88%E6%98%AFNoSQL%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.1 什么是NoSQL数据库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-NoSQL%E9%80%82%E7%94%A8%E7%9A%84%E5%9C%BA%E6%99%AF"><span class="toc-number">1.2.2.</span> <span class="toc-text">1.2 NoSQL适用的场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-NoSQL%E4%B8%8D%E9%80%82%E7%94%A8%E7%9A%84%E5%9C%BA%E6%99%AF"><span class="toc-number">1.2.3.</span> <span class="toc-text">1.3 NoSQL不适用的场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-%E5%B8%B8%E8%A7%81NoSQL%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">1.2.4.</span> <span class="toc-text">1.4 常见NoSQL数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-1-Memcached"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">1.4.1 Memcached</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-2-Redis"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">1.4.2 Redis</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-3-MongoDB"><span class="toc-number">1.2.4.3.</span> <span class="toc-text">1.4.3 MongoDB</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E8%8A%82-DB-Engines%E6%95%B0%E6%8D%AE%E5%BA%93%E6%8E%92%E5%90%8D"><span class="toc-number">1.3.</span> <span class="toc-text">第二节 DB-Engines数据库排名</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%AB%A0-Redis%E7%AE%80%E4%BB%8B%E5%92%8C%E5%AE%89%E8%A3%85"><span class="toc-number">2.</span> <span class="toc-text">第二章 Redis简介和安装</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87-1"><span class="toc-number">2.1.</span> <span class="toc-text">学习目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E8%8A%82-Redis%E7%AE%80%E4%BB%8B%E5%92%8C%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">2.2.</span> <span class="toc-text">第一节 Redis简介和适用场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E9%85%8D%E5%90%88%E5%85%B3%E7%B3%BB%E5%9E%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E5%81%9A%E9%AB%98%E9%80%9F%E7%BC%93%E5%AD%98"><span class="toc-number">2.2.1.</span> <span class="toc-text">1.1 配合关系型数据库做高速缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E5%A4%9A%E6%A0%B7%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%AD%98%E5%82%A8%E6%8C%81%E4%B9%85%E5%8C%96%E6%95%B0%E6%8D%AE"><span class="toc-number">2.2.2.</span> <span class="toc-text">1.2 多样的数据结构存储持久化数据</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E8%8A%82-Redis%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="toc-number">2.3.</span> <span class="toc-text">第二节 Redis的安装和基本操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%AE%89%E8%A3%85"><span class="toc-number">2.3.1.</span> <span class="toc-text">2.1 安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-Redis%E7%9A%84%E5%90%AF%E5%8A%A8%E5%92%8C%E5%81%9C%E6%AD%A2"><span class="toc-number">2.3.2.</span> <span class="toc-text">2.2 Redis的启动和停止</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-%E6%9F%A5%E7%9C%8B%E5%AE%89%E8%A3%85%E7%9B%AE%E5%BD%95"><span class="toc-number">2.3.2.1.</span> <span class="toc-text">2.2.1 查看安装目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%8B%B7%E8%B4%9D%E5%88%B0%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B7%AF%E5%BE%84"><span class="toc-number">2.3.2.2.</span> <span class="toc-text">2.2.2 默认配置文件拷贝到自定义路径</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-3-%E5%89%8D%E5%8F%B0%E5%90%AF%E5%8A%A8%E6%96%B9%E5%BC%8F"><span class="toc-number">2.3.2.3.</span> <span class="toc-text">2.2.3 前台启动方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-4-%E5%90%8E%E5%8F%B0%E5%90%AF%E5%8A%A8%E6%96%B9%E5%BC%8F"><span class="toc-number">2.3.2.4.</span> <span class="toc-text">2.2.4 后台启动方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-5-%E9%80%9A%E8%BF%87%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9E%E6%8E%A5redis"><span class="toc-number">2.3.2.5.</span> <span class="toc-text">2.2.5 通过客户端连接redis</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-6-%E5%81%9C%E6%AD%A2redis%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.3.2.6.</span> <span class="toc-text">2.3.6 停止redis服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-7-Redis%E7%AB%AF%E5%8F%A3%E5%8F%B7-6379-%E7%94%B1%E6%9D%A5"><span class="toc-number">2.3.2.7.</span> <span class="toc-text">2.3.7 Redis端口号 6379 由来</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#TODO"><span class="toc-number">3.</span> <span class="toc-text">&#x2F;&#x2F;TODO</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C"><span class="toc-number">3.0.0.0.1.</span> <span class="toc-text">（2）数据库操作</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%EF%BC%883%EF%BC%89Redis%E5%8D%95%E7%BA%BF%E7%A8%8B-%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8"><span class="toc-number">3.0.0.0.2.</span> <span class="toc-text">（3）Redis单线程+多路复用</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E7%AB%A0-Redis%E5%B8%B8%E7%94%A8%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E5%92%8C%E5%91%BD%E4%BB%A4"><span class="toc-number">4.</span> <span class="toc-text">第三章 Redis常用数据类型和命令</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87-2"><span class="toc-number">4.1.</span> <span class="toc-text">学习目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E8%8A%82-key%E6%93%8D%E4%BD%9C%E7%9A%84%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4"><span class="toc-number">4.2.</span> <span class="toc-text">第一节 key操作的相关命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E8%8A%82-%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%B1%BB%E5%9E%8B-String"><span class="toc-number">4.3.</span> <span class="toc-text">第二节 字符串类型(String)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E7%AE%80%E4%BB%8B"><span class="toc-number">4.3.1.</span> <span class="toc-text">2.1 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">4.3.2.</span> <span class="toc-text">2.2 常用命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">4.3.3.</span> <span class="toc-text">2.3 数据结构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E8%8A%82-Redis-%E5%88%97%E8%A1%A8-List"><span class="toc-number">4.4.</span> <span class="toc-text">第三节 Redis 列表(List)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E7%AE%80%E4%BB%8B"><span class="toc-number">4.4.1.</span> <span class="toc-text">3.1 简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">4.4.2.</span> <span class="toc-text">3.2 常用命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">4.4.3.</span> <span class="toc-text">3.3 数据结构</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E8%8A%82Redis-%E9%9B%86%E5%90%88-Set"><span class="toc-number">4.5.</span> <span class="toc-text">第四节Redis 集合(Set)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E8%8A%82-%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">4.6.</span> <span class="toc-text">第二节 环境准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E8%8A%82-key%E7%9B%B8%E5%85%B3API"><span class="toc-number">4.7.</span> <span class="toc-text">第三节 key相关API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E8%8A%82-String%E7%9B%B8%E5%85%B3API"><span class="toc-number">4.8.</span> <span class="toc-text">第四节 String相关API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E8%8A%82-List%E7%9B%B8%E5%85%B3API"><span class="toc-number">4.9.</span> <span class="toc-text">第五节 List相关API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E8%8A%82-Set%E7%9B%B8%E5%85%B3API"><span class="toc-number">4.10.</span> <span class="toc-text">第六节 Set相关API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%83%E8%8A%82-Hash%E7%9B%B8%E5%85%B3API"><span class="toc-number">4.11.</span> <span class="toc-text">第七节 Hash相关API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%85%AB%E8%8A%82-ZSet%E7%9B%B8%E5%85%B3API"><span class="toc-number">4.12.</span> <span class="toc-text">第八节 ZSet相关API</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#TODO%E7%AC%AC%E4%BA%94%E7%AB%A0-SpringBoot%E6%95%B4%E5%90%88Redis"><span class="toc-number">5.</span> <span class="toc-text">&#x2F;&#x2F;TODO第五章 SpringBoot整合Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-%E5%88%9B%E5%BB%BA%E5%B7%A5%E7%A8%8B"><span class="toc-number">5.1.</span> <span class="toc-text">5.1 创建工程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-%E6%B7%BB%E5%8A%A0%E4%BE%9D%E8%B5%96"><span class="toc-number">5.2.</span> <span class="toc-text">5.2 添加依赖</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">5.3.</span> <span class="toc-text">5.3 创建配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-%E5%88%9B%E5%BB%BA%E5%90%AF%E5%8A%A8%E7%B1%BB"><span class="toc-number">5.4.</span> <span class="toc-text">5.4 创建启动类</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-5-%E5%BA%8F%E5%88%97%E5%8C%96%E5%AE%9A%E5%88%B6"><span class="toc-number">5.5.</span> <span class="toc-text">5.5 序列化定制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-6-%E7%BC%96%E5%86%99%E6%B5%8B%E8%AF%95%E6%96%B9%E6%B3%95"><span class="toc-number">5.6.</span> <span class="toc-text">5.6 编写测试方法</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#TODO%E7%AC%AC%E5%85%AD%E7%AB%A0-Redis%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%A7%A3%E8%AF%BB"><span class="toc-number">6.</span> <span class="toc-text">&#x2F;&#x2F;TODO第六章 Redis配置文件解读</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87-3"><span class="toc-number">6.1.</span> <span class="toc-text">学习目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E8%8A%82-%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE%E7%9B%B8%E5%85%B3-x20"><span class="toc-number">6.2.</span> <span class="toc-text">第一节 网络配置相关 </span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%881%EF%BC%89-bind%E7%BB%91%E5%AE%9A%E8%BF%9E%E6%8E%A5IP"><span class="toc-number">6.2.1.</span> <span class="toc-text">（1） bind绑定连接IP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%882%EF%BC%89-%E7%AB%AF%E5%8F%A3%E5%8F%B7%EF%BC%9A-6379"><span class="toc-number">6.2.2.</span> <span class="toc-text">（2） 端口号： 6379</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%883%EF%BC%89tcp-backlog-%E8%BF%9E%E6%8E%A5%E9%98%9F%E5%88%97"><span class="toc-number">6.2.3.</span> <span class="toc-text">（3）tcp-backlog 连接队列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%884%EF%BC%89timeout%E8%BF%9E%E6%8E%A5%E8%B6%85%E6%97%B6"><span class="toc-number">6.2.4.</span> <span class="toc-text">（4）timeout连接超时</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%885%EF%BC%89tcp-keepalive-%E8%BF%9E%E6%8E%A5%E5%BF%83%E8%B7%B3%E6%A3%80%E6%B5%8B"><span class="toc-number">6.2.5.</span> <span class="toc-text">（5）tcp-keepalive  连接心跳检测</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E8%8A%82-GENREAL%E9%80%9A%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">6.3.</span> <span class="toc-text">第二节 GENREAL通用配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%881%EF%BC%89UNITS%E5%8D%95%E4%BD%8D"><span class="toc-number">6.3.1.</span> <span class="toc-text">（1）UNITS单位</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%882%EF%BC%89INCLUDES%E5%8C%85%E5%90%AB"><span class="toc-number">6.3.2.</span> <span class="toc-text">（2）INCLUDES包含</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%883%EF%BC%89daemonize-%E5%90%8E%E5%8F%B0%E8%BF%9B%E7%A8%8B"><span class="toc-number">6.3.3.</span> <span class="toc-text">（3）daemonize 后台进程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%884%EF%BC%89pidfile-%E8%BF%9B%E7%A8%8BID%E6%96%87%E4%BB%B6"><span class="toc-number">6.3.4.</span> <span class="toc-text">（4）pidfile 进程ID文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%885%EF%BC%89databases-16-x20"><span class="toc-number">6.3.5.</span> <span class="toc-text">（5）databases 16 </span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E8%8A%82-SECURITY%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE"><span class="toc-number">6.4.</span> <span class="toc-text">第三节 SECURITY安全配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E8%8A%82-LIMIT%E9%99%90%E5%88%B6"><span class="toc-number">6.5.</span> <span class="toc-text">第四节 LIMIT限制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%881%EF%BC%89maxclients-%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%9C%80%E5%A4%A7%E8%BF%9E%E6%8E%A5%E6%95%B0"><span class="toc-number">6.5.1.</span> <span class="toc-text">（1）maxclients 客户端最大连接数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%882%EF%BC%89maxmemory-%E6%9C%80%E5%A4%A7%E5%8D%A0%E7%94%A8%E5%86%85%E5%AD%98"><span class="toc-number">6.5.2.</span> <span class="toc-text">（2）maxmemory 最大占用内存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%883%EF%BC%89maxmemory-policy-%E7%BD%AE%E6%8D%A2%E7%AD%96%E7%95%A5"><span class="toc-number">6.5.3.</span> <span class="toc-text">（3）maxmemory-policy  置换策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%884%EF%BC%89maxmemory-samples"><span class="toc-number">6.5.4.</span> <span class="toc-text">（4）maxmemory-samples</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#TODO%E7%AC%AC%E4%B8%83%E7%AB%A0-Redis%E4%BA%8B%E5%8A%A1%E9%94%81%E6%9C%BA%E5%88%B6%E5%8F%8A%E6%A1%88%E4%BE%8B"><span class="toc-number">7.</span> <span class="toc-text">&#x2F;&#x2F;TODO第七章 Redis事务锁机制及案例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87-4"><span class="toc-number">7.1.</span> <span class="toc-text">学习目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E8%8A%82-Redis%E4%BA%8B%E5%8A%A1%E5%92%8C%E9%94%81%E6%9C%BA%E5%88%B6"><span class="toc-number">7.2.</span> <span class="toc-text">第一节 Redis事务和锁机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-Redis%E4%BA%8B%E5%8A%A1%E7%9A%84%E5%AE%9A%E4%B9%89"><span class="toc-number">7.2.1.</span> <span class="toc-text">1.1 Redis事务的定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-Redis%E4%BA%8B%E5%8A%A1%E6%8E%A7%E5%88%B6%E5%91%BD%E4%BB%A4"><span class="toc-number">7.2.2.</span> <span class="toc-text">1.2 Redis事务控制命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-Redis%E4%BA%8B%E5%8A%A1%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-number">7.2.3.</span> <span class="toc-text">1.3 Redis事务错误处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-Redis%E4%BA%8B%E5%8A%A1%E5%9C%BA%E6%99%AF%E6%A1%88%E4%BE%8B"><span class="toc-number">7.2.4.</span> <span class="toc-text">1.4 Redis事务场景案例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5-Redis%E4%BA%8B%E5%8A%A1%E7%9A%84%E4%B8%89%E4%B8%AA%E7%89%B9%E6%80%A7"><span class="toc-number">7.2.5.</span> <span class="toc-text">1.5 Redis事务的三个特性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E8%8A%82-Redis-Lua-%E8%84%9A%E6%9C%AC"><span class="toc-number">7.3.</span> <span class="toc-text">第二节 Redis Lua 脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E4%BB%80%E4%B9%88%E6%98%AFLUA"><span class="toc-number">7.3.1.</span> <span class="toc-text">2.1 什么是LUA</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%88%9B%E5%BB%BASpringBoot%E5%B7%A5%E7%A8%8B"><span class="toc-number">7.3.2.</span> <span class="toc-text">2.2 创建SpringBoot工程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E5%BC%95%E5%85%A5%E7%9B%B8%E5%85%B3%E4%BE%9D%E8%B5%96"><span class="toc-number">7.3.3.</span> <span class="toc-text">2.3 引入相关依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">7.3.4.</span> <span class="toc-text">2.4 创建配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-%E5%88%9B%E5%BB%BALUA%E8%84%9A%E6%9C%AC"><span class="toc-number">7.3.5.</span> <span class="toc-text">2.5 创建LUA脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-number">7.3.6.</span> <span class="toc-text">2.6 创建配置类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-7-%E5%88%9B%E5%BB%BA%E6%B5%8B%E8%AF%95%E7%B1%BB"><span class="toc-number">7.3.7.</span> <span class="toc-text">2.7 创建测试类</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%85%AB%E7%AB%A0-Redis%E7%9A%84%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">8.</span> <span class="toc-text">第八章 Redis的持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87-5"><span class="toc-number">8.1.</span> <span class="toc-text">学习目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E8%8A%82-%E6%8C%81%E4%B9%85%E5%8C%96%E6%80%BB%E4%BD%93%E4%BB%8B%E7%BB%8D"><span class="toc-number">8.2.</span> <span class="toc-text">第一节 持久化总体介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E8%8A%82-RDB%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">8.3.</span> <span class="toc-text">第二节 RDB持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-RDB%E7%AE%80%E4%BB%8B"><span class="toc-number">8.3.1.</span> <span class="toc-text">2.1 RDB简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-RDB%E6%8C%81%E4%B9%85%E5%8C%96%E6%B5%81%E7%A8%8B"><span class="toc-number">8.3.2.</span> <span class="toc-text">2.2 RDB持久化流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-RDB%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE%E4%B8%8E%E6%93%8D%E4%BD%9C"><span class="toc-number">8.3.3.</span> <span class="toc-text">2.3 RDB相关配置与操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-RDB%E7%9A%84%E4%BC%98%E5%8A%BF%E5%92%8C%E5%8A%A3%E5%8A%BF"><span class="toc-number">8.3.4.</span> <span class="toc-text">2.4 RDB的优势和劣势</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-1-%E4%BC%98%E5%8A%BF"><span class="toc-number">8.3.4.1.</span> <span class="toc-text">2.4.1 优势</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-2-%E5%8A%A3%E5%8A%BF"><span class="toc-number">8.3.4.2.</span> <span class="toc-text">2.4.2 劣势</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-RDB%E5%B0%8F%E6%80%BB%E7%BB%93"><span class="toc-number">8.3.5.</span> <span class="toc-text">2.5 RDB小总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E8%8A%82-AOF%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">8.4.</span> <span class="toc-text">第三节 AOF持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-AOF%E7%AE%80%E4%BB%8B"><span class="toc-number">8.4.1.</span> <span class="toc-text">3.1 AOF简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-AOF%E6%8C%81%E8%AE%A1%E5%88%92%E6%B5%81%E7%A8%8B"><span class="toc-number">8.4.2.</span> <span class="toc-text">3.2 AOF持计划流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-AOF%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE%E4%B8%8E%E6%93%8D%E4%BD%9C"><span class="toc-number">8.4.3.</span> <span class="toc-text">3.3 AOF相关配置与操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-AOF%E7%9A%84%E4%BC%98%E5%8A%BF"><span class="toc-number">8.4.4.</span> <span class="toc-text">3.4 AOF的优势</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-AOF%E7%9A%84%E5%8A%A3%E5%8A%BF"><span class="toc-number">8.4.5.</span> <span class="toc-text">3.5 AOF的劣势</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-AOF%E5%B0%8F%E6%80%BB%E7%BB%93"><span class="toc-number">8.4.6.</span> <span class="toc-text">3.6 AOF小总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-7-%E6%8C%81%E4%B9%85%E5%8C%96%E6%96%B9%E6%A1%88%E9%80%89%E6%8B%A9"><span class="toc-number">8.4.7.</span> <span class="toc-text">3.7 持久化方案选择</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B9%9D%E7%AB%A0-Redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-number">9.</span> <span class="toc-text">第九章 Redis主从复制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87-6"><span class="toc-number">9.1.</span> <span class="toc-text">学习目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E8%8A%82-%E4%BB%80%E4%B9%88%E6%98%AF%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-number">9.2.</span> <span class="toc-text">第一节 什么是主从复制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E8%8A%82-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">9.3.</span> <span class="toc-text">第二节 主从复制的作用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E8%8A%82-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%85%B7%E4%BD%93%E6%93%8D%E4%BD%9C"><span class="toc-number">9.4.</span> <span class="toc-text">第三节 主从复制具体操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E5%AE%9E%E7%8E%B0%E6%80%9D%E8%B7%AF"><span class="toc-number">9.4.1.</span> <span class="toc-text">（1）实现思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%882%EF%BC%89-%E4%B8%80%E5%8F%B0%E6%9C%BA%E5%99%A8%E4%B8%8A%E5%90%AF%E5%8A%A8%E5%A4%9A%E4%B8%AAredis%E6%9C%8D%E5%8A%A1"><span class="toc-number">9.4.2.</span> <span class="toc-text">（2） 一台机器上启动多个redis服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%883%EF%BC%89%E6%96%B0%E5%BB%BA%E4%B8%89%E4%B8%AAredis%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">9.4.3.</span> <span class="toc-text">（3）新建三个redis配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%884%EF%BC%89%E5%90%AF%E5%8A%A8%E4%B8%89%E4%B8%AA%E6%9C%8D%E5%8A%A1"><span class="toc-number">9.4.4.</span> <span class="toc-text">（4）启动三个服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%885%EF%BC%89%E6%9F%A5%E7%9C%8B%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1%E8%BF%9B%E7%A8%8B"><span class="toc-number">9.4.5.</span> <span class="toc-text">（5）查看启动服务进程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%886%EF%BC%89%E4%BD%BF%E7%94%A8info-replication%E6%9F%A5%E7%9C%8B%E4%B8%BB%E4%BB%8E%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF"><span class="toc-number">9.4.6.</span> <span class="toc-text">（6）使用info replication查看主从相关信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%887%EF%BC%89-%E9%85%8D%E7%BD%AE%E4%B8%BB%E4%BB%8E%E6%9C%BA%E5%99%A8"><span class="toc-number">9.4.7.</span> <span class="toc-text">（7） 配置主从机器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%888%EF%BC%89%E6%B5%8B%E8%AF%95%E4%B8%BB%E4%BB%8E%E8%AF%BB%E5%86%99%E6%93%8D%E4%BD%9C"><span class="toc-number">9.4.8.</span> <span class="toc-text">（8）测试主从读写操作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E8%8A%82-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86"><span class="toc-number">9.5.</span> <span class="toc-text">第四节 主从复制原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E8%8A%82-%E4%B8%BB%E5%8A%A8%E5%A4%8D%E5%88%B6%E4%B8%89%E7%A7%8D%E6%A8%A1%E5%BC%8F"><span class="toc-number">9.6.</span> <span class="toc-text">第五节 主动复制三种模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E8%8A%82-%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F"><span class="toc-number">9.7.</span> <span class="toc-text">第六节 哨兵模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F%E7%AE%80%E4%BB%8B"><span class="toc-number">9.7.1.</span> <span class="toc-text">6.1 哨兵模式简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F%E7%9A%84%E4%BD%BF%E7%94%A8%E6%AD%A5%E9%AA%A4"><span class="toc-number">9.7.2.</span> <span class="toc-text">6.2 哨兵模式的使用步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E7%AC%AC%E4%B8%80%E6%AD%A5-%E8%AE%BE%E7%BD%AE%E7%AE%80%E5%8D%95%E7%9A%84%E4%B8%80%E4%B8%BB%E4%BA%8C%E4%BB%86"><span class="toc-number">9.7.2.1.</span> <span class="toc-text">（1）第一步: 设置简单的一主二仆</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E7%AC%AC%E4%BA%8C%E6%AD%A5-%E4%B8%BA%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F%E5%87%86%E5%A4%87%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">9.7.2.2.</span> <span class="toc-text">（2）第二步: 为哨兵模式准备配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%883%EF%BC%89%E7%AC%AC%E4%B8%89%E6%AD%A5-%E5%90%AF%E5%8A%A8%E5%93%A8%E5%85%B5"><span class="toc-number">9.7.2.3.</span> <span class="toc-text">（3）第三步: 启动哨兵</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F%E7%9A%84%E6%93%8D%E4%BD%9C%E6%BC%94%E7%A4%BA"><span class="toc-number">9.7.3.</span> <span class="toc-text">6.3 哨兵模式的操作演示</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E4%B8%BB%E6%9C%BA%E5%AE%95%E6%9C%BA%E6%BC%94%E7%A4%BA"><span class="toc-number">9.7.3.1.</span> <span class="toc-text">（1）主机宕机演示</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E5%A4%8D%E5%88%B6%E5%BB%B6%E6%97%B6"><span class="toc-number">9.7.3.2.</span> <span class="toc-text">（2）复制延时</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%EF%BC%883%EF%BC%89%E6%95%85%E9%9A%9C%E6%81%A2%E5%A4%8D"><span class="toc-number">9.7.3.3.</span> <span class="toc-text">（3）故障恢复</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E7%AB%A0-Redis%E9%9B%86%E7%BE%A4%E6%93%8D%E4%BD%9C"><span class="toc-number">10.</span> <span class="toc-text">第十章 Redis集群操作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87-7"><span class="toc-number">10.1.</span> <span class="toc-text">学习目标</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-1-%E7%9B%AE%E5%89%8D%E9%9D%A2%E4%B8%B4%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90"><span class="toc-number">10.2.</span> <span class="toc-text">9.1 目前面临问题分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-2-%E4%BB%80%E4%B9%88%E6%98%AF%E9%9B%86%E7%BE%A4"><span class="toc-number">10.3.</span> <span class="toc-text">9.2 什么是集群</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-3-%E9%9B%86%E7%BE%A4%E7%9A%84%E6%90%AD%E5%BB%BA"><span class="toc-number">10.4.</span> <span class="toc-text">9.3 集群的搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E7%AC%AC%E4%B8%80%E6%AD%A5-%E6%90%AD%E5%BB%BA%E5%89%8D%E7%9A%84%E5%87%86%E5%A4%87"><span class="toc-number">10.4.1.</span> <span class="toc-text">（1）第一步,搭建前的准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E7%AC%AC%E4%BA%8C%E6%AD%A5-%E5%88%B6%E4%BD%9C%E5%85%AD%E4%B8%AA%E5%AE%9E%E4%BE%8B%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">10.4.2.</span> <span class="toc-text">（2）第二步,制作六个实例的配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%883%EF%BC%89%E7%AC%AC%E4%B8%89%E6%AD%A5-%E5%90%AF%E5%8A%A8%E5%85%AD%E4%B8%AA%E6%9C%8D%E5%8A%A1"><span class="toc-number">10.4.3.</span> <span class="toc-text">（3）第三步,启动六个服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%884%EF%BC%89%E7%AC%AC%E5%9B%9B%E6%AD%A5-%E5%B0%86%E5%85%AD%E4%B8%AA%E6%9C%8D%E5%8A%A1%E5%90%88%E5%B9%B6%E4%B8%BA%E4%B8%80%E4%B8%AA%E9%9B%86%E7%BE%A4"><span class="toc-number">10.4.4.</span> <span class="toc-text">（4）第四步 ,将六个服务合并为一个集群</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-4%E9%9B%86%E7%BE%A4%E7%9A%84%E7%99%BB%E5%BD%95"><span class="toc-number">10.5.</span> <span class="toc-text">9.4集群的登录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%881%EF%BC%89%E9%9B%86%E7%BE%A4%E7%99%BB%E5%BD%95%E6%96%B9%E5%BC%8F"><span class="toc-number">10.5.1.</span> <span class="toc-text">（1）集群登录方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EF%BC%882%EF%BC%89%E7%99%BB%E5%BD%95%E5%90%8E%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E4%BF%A1%E6%81%AF"><span class="toc-number">10.5.2.</span> <span class="toc-text">（2）登录后查看集群信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-5-%E9%9B%86%E7%BE%A4%E7%9A%84slots"><span class="toc-number">10.6.</span> <span class="toc-text">9.5 集群的slots</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-6-%E9%9B%86%E7%BE%A4%E4%B8%AD%E5%BD%95%E5%85%A5%E5%80%BC"><span class="toc-number">10.7.</span> <span class="toc-text">9.6 集群中录入值</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-7-%E9%9B%86%E7%BE%A4%E4%B8%AD%E6%9F%A5%E6%89%BE%E5%80%BC"><span class="toc-number">10.8.</span> <span class="toc-text">9.7 集群中查找值</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-8-%E9%9B%86%E7%BE%A4%E6%95%85%E9%9A%9C%E6%81%A2%E5%A4%8D"><span class="toc-number">10.9.</span> <span class="toc-text">9.8 集群故障恢复</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-9-%E9%9B%86%E7%BE%A4%E6%8F%90%E4%BE%9B%E7%9A%84%E5%A5%BD%E5%A4%84"><span class="toc-number">10.10.</span> <span class="toc-text">9.9 集群提供的好处</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-10-%E9%9B%86%E7%BE%A4%E7%9A%84%E4%B8%8D%E8%B6%B3"><span class="toc-number">10.11.</span> <span class="toc-text">9.10 集群的不足</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/articles/0.html" title="无题">无题</a><time datetime="2024-10-08T14:29:26.293Z" title="发表于 2024-10-08 22:29:26">2024-10-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/articles/1.html" title="无题">无题</a><time datetime="2024-10-08T14:29:26.293Z" title="发表于 2024-10-08 22:29:26">2024-10-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/articles/0.html" title="无题">无题</a><time datetime="2024-10-08T14:29:26.293Z" title="发表于 2024-10-08 22:29:26">2024-10-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/articles/0.html" title="无题">无题</a><time datetime="2024-10-08T14:29:26.293Z" title="发表于 2024-10-08 22:29:26">2024-10-08</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/articles/0.html" title="无题">无题</a><time datetime="2024-10-08T14:29:26.277Z" title="发表于 2024-10-08 22:29:26">2024-10-08</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo_v5.4.0" title="博客框架为Hexo_v5.4.0"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Frame-Hexo.svg" alt="博客框架为Hexo_v5.4.0"/></a><a class="github-badge" target="_blank" href="https://github.com/" style="margin-inline:5px" data-title="本站项目由Github托管" title="本站项目由Github托管"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Source-Github.svg" alt="本站项目由Github托管"/></a><a class="github-badge" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" style="margin-inline:5px" data-title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.2.0/img/badge/Copyright-BY-NC-SA.svg" alt="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"/></a></p></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2023 - 2024 By <a class="footer-bar-link" href="/" title="YuPengtao" target="_blank">YuPengtao</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://beian.miit.gov.cn/" title="蜀ICP备-2023013130号">蜀ICP备-2023013130号</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">58</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">27</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">14</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://this0.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.png" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 归档</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 休闲</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/fcircle/"><svg class="icon faa-tada" aria-hidden="true"><use xlink:href="#icon-artstation"></use></svg><span> 朋友圈</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 个人</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 唠叨</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于站长</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/Docker/" style="font-size: 0.88rem;">Docker<sup>3</sup></a><a href="/tags/JavaSE/" style="font-size: 0.88rem;">JavaSE<sup>18</sup></a><a href="/tags/JavaWeb/" style="font-size: 0.88rem;">JavaWeb<sup>1</sup></a><a href="/tags/Java%E9%A1%B9%E7%9B%AE/" style="font-size: 0.88rem;">Java项目<sup>1</sup></a><a href="/tags/Linux/" style="font-size: 0.88rem;">Linux<sup>1</sup></a><a href="/tags/Maven/" style="font-size: 0.88rem;">Maven<sup>1</sup></a><a href="/tags/MyBatis-Plus/" style="font-size: 0.88rem;">MyBatis-Plus<sup>1</sup></a><a href="/tags/Mybatis/" style="font-size: 0.88rem;">Mybatis<sup>1</sup></a><a href="/tags/Redis/" style="font-size: 0.88rem;">Redis<sup>1</sup></a><a href="/tags/SSM/" style="font-size: 0.88rem;">SSM<sup>3</sup></a><a href="/tags/SpringBoot/" style="font-size: 0.88rem;">SpringBoot<sup>1</sup></a><a href="/tags/SpringFramework/" style="font-size: 0.88rem;">SpringFramework<sup>1</sup></a><a href="/tags/SpringMVC/" style="font-size: 0.88rem;">SpringMVC<sup>1</sup></a><a href="/tags/gateway/" style="font-size: 0.88rem;">gateway<sup>1</sup></a><a href="/tags/mysql/" style="font-size: 0.88rem;">mysql<sup>1</sup></a><a href="/tags/nacos/" style="font-size: 0.88rem;">nacos<sup>1</sup></a><a href="/tags/nvm/" style="font-size: 0.88rem;">nvm<sup>1</sup></a><a href="/tags/sss/" style="font-size: 0.88rem;">sss<sup>1</sup></a><a href="/tags/%E5%B7%A5%E5%85%B7%E6%96%87%E6%A1%A3/" style="font-size: 0.88rem;">工具文档<sup>1</sup></a><a href="/tags/%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/" style="font-size: 0.88rem;">开发环境<sup>1</sup></a><a href="/tags/%E6%97%85%E6%B8%B8/" style="font-size: 0.88rem;">旅游<sup>1</sup></a><a href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E5%BC%80%E5%8F%91/" style="font-size: 0.88rem;">服务器端开发<sup>1</sup></a><a href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%BF%90%E7%BB%B4/" style="font-size: 0.88rem;">服务器运维<sup>3</sup></a><a href="/tags/%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" style="font-size: 0.88rem;">环境搭建<sup>2</sup></a><a href="/tags/%E7%BD%91%E5%85%B3/" style="font-size: 0.88rem;">网关<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%AB%99%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3/" style="font-size: 0.88rem;">网站说明文档<sup>2</sup></a><a href="/tags/%E9%98%B2%E7%81%AB%E5%A2%99/" style="font-size: 0.88rem;">防火墙<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="chat-btn" type="button" title="聊天"><i class="anzhiyufont anzhiyu-icon-comment-sms"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script async src="/anzhiyu/random.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo-vercel.this0.com',
      region: 'ap-chengdu',
      onCommentLoaded: () => {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(runFn,0)
    else getScript('https://cdn.cbd.int/twikoo@1.6.25/dist/twikoo.all.min.js').then(runFn)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo-vercel.this0.com',
      region: 'ap-chengdu',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const runFn = () => {
    init();
    
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://twikoo-vercel.this0.com',
        region: 'ap-chengdu',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.cbd.int/twikoo@1.6.25/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'data-lazy-src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'><div class='name'><span>${array[i].nick} </span></div></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script async data-pjax src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.1/bubble/bubble.js"></script><script>var visitorMail = "visitor@email.com";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script>(() => {
  window.$crisp = [];
  window.CRISP_WEBSITE_ID = "6a9fd556-c343-47a3-9b3c-d19b7402038e";
  (function () {
    d = document;
    s = d.createElement("script");
    s.src = "https://client.crisp.chat/l.js";
    s.async = 1;
    d.getElementsByTagName("head")[0].appendChild(s);
  })();
  $crisp.push(["safe", true])

  const isChatBtn = true
  const isChatHideShow = false

  if (isChatBtn) {
    const open = () => {
      $crisp.push(["do", "chat:show"])
      $crisp.push(["do", "chat:open"])
    }

    const close = () => {
      $crisp.push(["do", "chat:hide"])
    }

    close()
    $crisp.push(["on", "chat:closed", function() {
      close()
    }])

    window.chatBtnFn = () => {
      $crisp.is("chat:visible") ? close() : open()
    }
  } else if (isChatHideShow) {
    window.chatBtn = {
      hide: () => {
        $crisp.push(["do", "chat:hide"])
      },
      show: () => {
        $crisp.push(["do", "chat:show"])
      }
    }
  }
})()</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"]):not([href="/music/"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>